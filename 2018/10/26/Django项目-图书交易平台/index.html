<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="python,django项目," />





  <link rel="alternate" href="/atom.xml" title="lalala's blog" type="application/atom+xml" />






<meta name="description" content="目录 1，新建项目 2，用户系统开发 3，书籍商品模块 4，用户中心实现 5，购物车功能 6，订单页面的开发 7，使用缓存 8，评论功能 9，发送邮件功能实现 10，登陆验证码功能实现 11，全文检索的实现 12，用户激活功能实现 13，用户中心最近浏览功能 14，过滤器功能实现 15，使用nginx+gunicorn+django进行部署 16，django日志模块的使用 17，中间件的编写">
<meta name="keywords" content="python,django项目">
<meta property="og:type" content="article">
<meta property="og:title" content="Django项目_图书交易平台">
<meta property="og:url" content="http://yoururl.com/2018/10/26/Django项目-图书交易平台/index.html">
<meta property="og:site_name" content="lalala&#39;s blog">
<meta property="og:description" content="目录 1，新建项目 2，用户系统开发 3，书籍商品模块 4，用户中心实现 5，购物车功能 6，订单页面的开发 7，使用缓存 8，评论功能 9，发送邮件功能实现 10，登陆验证码功能实现 11，全文检索的实现 12，用户激活功能实现 13，用户中心最近浏览功能 14，过滤器功能实现 15，使用nginx+gunicorn+django进行部署 16，django日志模块的使用 17，中间件的编写">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-10-26T11:17:25.258Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Django项目_图书交易平台">
<meta name="twitter:description" content="目录 1，新建项目 2，用户系统开发 3，书籍商品模块 4，用户中心实现 5，购物车功能 6，订单页面的开发 7，使用缓存 8，评论功能 9，发送邮件功能实现 10，登陆验证码功能实现 11，全文检索的实现 12，用户激活功能实现 13，用户中心最近浏览功能 14，过滤器功能实现 15，使用nginx+gunicorn+django进行部署 16，django日志模块的使用 17，中间件的编写">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoururl.com/2018/10/26/Django项目-图书交易平台/"/>





  <title>Django项目_图书交易平台 | lalala's blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">lalala's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">努力做一名白帽子</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoururl.com/2018/10/26/Django项目-图书交易平台/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="lalala">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/lalala">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lalala's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Django项目_图书交易平台</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-26T18:06:00+08:00">
                2018-10-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Django学习笔记/" itemprop="url" rel="index">
                    <span itemprop="name">Django学习笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h1><ul>
<li><a href="#1">1，新建项目</a></li>
<li><a href="#2">2，用户系统开发</a></li>
<li><a href="#3">3，书籍商品模块</a></li>
<li><a href="#4">4，用户中心实现</a></li>
<li><a href="#5">5，购物车功能</a></li>
<li><a href="#6">6，订单页面的开发</a></li>
<li><a href="#7">7，使用缓存</a></li>
<li><a href="#8">8，评论功能</a></li>
<li><a href="#9">9，发送邮件功能实现</a></li>
<li><a href="#10">10，登陆验证码功能实现</a></li>
<li><a href="#11">11，全文检索的实现</a></li>
<li><a href="#12">12，用户激活功能实现</a></li>
<li><a href="#13">13，用户中心最近浏览功能</a></li>
<li><a href="#14">14，过滤器功能实现</a></li>
<li><a href="#15">15，使用nginx+gunicorn+django进行部署</a></li>
<li><a href="#16">16，django日志模块的使用</a></li>
<li><a href="#17">17，中间件的编写</a></li>
</ul>
<h1 id="1，新建项目"><a href="#1，新建项目" class="headerlink" title="1，新建项目"></a><a id="1">1，新建项目</a></h1><h2 id="1，新建项目-1"><a href="#1，新建项目-1" class="headerlink" title="1，新建项目"></a>1，新建项目</h2><p>新建项目之前需要先看<code>2.</code>，把包都安装了！</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> django-admin startproject bookstore</span></span><br></pre></td></tr></table></figure>
<h2 id="2，将需要用的包添加进来"><a href="#2，将需要用的包添加进来" class="headerlink" title="2，将需要用的包添加进来"></a>2，将需要用的包添加进来</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> wq保存</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vim requirements.txt</span></span><br></pre></td></tr></table></figure>
<p>安装包文件如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># requirements.txt</span></span><br><span class="line">amqp==<span class="number">2.2</span><span class="number">.2</span></span><br><span class="line">billiard==<span class="number">3.5</span><span class="number">.0</span><span class="number">.3</span></span><br><span class="line">celery==<span class="number">4.1</span><span class="number">.0</span></span><br><span class="line">Django==<span class="number">1.8</span><span class="number">.2</span></span><br><span class="line">django-haystack==<span class="number">2.6</span><span class="number">.1</span></span><br><span class="line">django-redis==<span class="number">4.8</span><span class="number">.0</span></span><br><span class="line">django-tinymce==<span class="number">2.6</span><span class="number">.0</span></span><br><span class="line">itsdangerous==<span class="number">0.24</span></span><br><span class="line">jieba==<span class="number">0.39</span></span><br><span class="line">kombu==<span class="number">4.1</span><span class="number">.0</span></span><br><span class="line">olefile==<span class="number">0.44</span></span><br><span class="line">Pillow==<span class="number">4.3</span><span class="number">.0</span></span><br><span class="line">pycryptodome==<span class="number">3.4</span><span class="number">.7</span></span><br><span class="line">PyMySQL==<span class="number">0.7</span><span class="number">.11</span></span><br><span class="line">python-alipay-sdk==<span class="number">1.7</span><span class="number">.0</span></span><br><span class="line">pytz==<span class="number">2017.2</span></span><br><span class="line">redis==<span class="number">2.10</span><span class="number">.6</span></span><br><span class="line"><span class="comment">#uWSGI==2.0.15</span></span><br><span class="line">vine==<span class="number">1.1</span><span class="number">.4</span></span><br><span class="line">Whoosh==<span class="number">2.7</span><span class="number">.4</span></span><br><span class="line">gunicorn</span><br></pre></td></tr></table></figure>
<p>安装环境（在虚拟环境中）</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pip install -r requirements<span class="selector-class">.txt</span> -<span class="selector-tag">i</span> https:<span class="comment">//pypi.tuna.tsinghua.edu.cn/simple/</span></span><br></pre></td></tr></table></figure>
<h2 id="3，修改项目配置文件，将默认sqlite改为mysql"><a href="#3，修改项目配置文件，将默认sqlite改为mysql" class="headerlink" title="3，修改项目配置文件，将默认sqlite改为mysql"></a>3，修改项目配置文件，将默认sqlite改为mysql</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># bookstore/settings.py</span></span><br><span class="line">DATABASES = &#123;</span><br><span class="line">    <span class="string">'default'</span>: &#123;</span><br><span class="line">        <span class="string">'ENGINE'</span>: <span class="string">'django.db.backends.mysql'</span>,</span><br><span class="line">        <span class="string">'NAME'</span>: <span class="string">'bookstore'</span>,</span><br><span class="line">        <span class="string">'USER'</span>: <span class="string">'root'</span>,</span><br><span class="line">        <span class="string">'PASSWORD'</span>: <span class="string">''</span>,</span><br><span class="line">        <span class="string">'HOST'</span>: <span class="string">'127.0.0.1'</span>,</span><br><span class="line">        <span class="string">'PORT'</span>: <span class="number">3306</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为了使用mysql的驱动，在主app的<code>__init__.py</code>文件中加入以下两行代码：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line">pymysql.install_as_MySQLdb()</span><br></pre></td></tr></table></figure>
<h1 id="2，用户系统开发"><a href="#2，用户系统开发" class="headerlink" title="2，用户系统开发"></a><a id="2">2，用户系统开发</a></h1><h2 id="1，用户系统的开发"><a href="#1，用户系统的开发" class="headerlink" title="1，用户系统的开发"></a>1，用户系统的开发</h2><p>新建users这个app，也就是用户app，先从注册页做起。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> python manage.py startapp users</span></span><br></pre></td></tr></table></figure>
<p>我们建好users app后，需要将它添加到配置文件中去。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bookstore/settings.py</span><br><span class="line">INSTALLED_APPS = (</span><br><span class="line">    ...</span><br><span class="line">    <span class="string">'users'</span>, <span class="comment"># 用户模块</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>然后我们需要设计表结构，我们要思考一下，这个users数据表结构应该包含哪些字段？<br>我们需要先抽象出一个BaseModel，一个基本模型，什么意思呢？因为数据表有共同的字段，我们可以把它抽象出来，比如create_at（创建时间），update_at（更新时间），is_delete（软删除）。注意！这个base_model.py要保存在根目录下面的db文件夹中，别忘了db文件夹中的<strong>init</strong>.py。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># bookstore/db/base_model.py</span></span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseModel</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="string">'''模型抽象基类'''</span></span><br><span class="line">    is_delete = models.BooleanField(default=<span class="keyword">False</span>, verbose_name=<span class="string">'删除标记'</span>)</span><br><span class="line">    create_time = models.DateTimeField(auto_now_add=<span class="keyword">True</span>, verbose_name=<span class="string">'创建时间'</span>)</span><br><span class="line">    update_time = models.DateTimeField(auto_now=<span class="keyword">True</span>, verbose_name=<span class="string">'更新时间'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        abstract = <span class="keyword">True</span></span><br></pre></td></tr></table></figure>
<p>然后我们针对Users设计一张表出来。以下代码写入<code>users/models.py</code>文件中。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> db.base_model <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Passport</span><span class="params">(BaseModel)</span>:</span></span><br><span class="line">    <span class="string">'''用户模型类'''</span></span><br><span class="line">    username = models.CharField(max_length=<span class="number">20</span>, unique=<span class="keyword">True</span>, verbose_name=<span class="string">'用户名称'</span>)</span><br><span class="line">    password = models.CharField(max_length=<span class="number">40</span>, verbose_name=<span class="string">'用户密码'</span>)</span><br><span class="line">    email = models.EmailField(verbose_name=<span class="string">'用户邮箱'</span>)</span><br><span class="line">    is_active = models.BooleanField(default=<span class="keyword">False</span>, verbose_name=<span class="string">'激活状态'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 用户表的管理器</span></span><br><span class="line">    objects = PassportManager()</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        db_table = <span class="string">'s_user_account'</span></span><br></pre></td></tr></table></figure>
<p>接下来我们在PassportManager()中实现添加和查找账户信息的功能，这样抽象性更好。下面这个类需要写在<code>Passport</code>的上面。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> utils.get_hash <span class="keyword">import</span> get_hash</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create your models here.</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PassportManager</span><span class="params">(models.Manager)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_one_passport</span><span class="params">(self, username, password, email)</span>:</span></span><br><span class="line">        <span class="string">'''添加一个账户信息'''</span></span><br><span class="line">        passport = self.create(username=username, password=get_hash(password), email=email)</span><br><span class="line">        <span class="comment"># 3.返回passport</span></span><br><span class="line">        <span class="keyword">return</span> passport</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_one_passport</span><span class="params">(self, username, password)</span>:</span></span><br><span class="line">        <span class="string">'''根据用户名密码查找账户的信息'''</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            passport = self.get(username=username, password=get_hash(password))</span><br><span class="line">        <span class="keyword">except</span> self.model.DoesNotExist:</span><br><span class="line">            <span class="comment"># 账户不存在</span></span><br><span class="line">            passport = <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">return</span> passport</span><br></pre></td></tr></table></figure>
<p>我们这里有一个get_hash函数，这个函数用来避免存储明文密码。所以我们来编写这个函数。在根目录新建一个文件夹utils，用来存放功能函数，比如get_hash，别忘了<strong>init</strong>.py文件。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># bookstore/utils/get_hash.py</span></span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha1</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_hash</span><span class="params">(str)</span>:</span></span><br><span class="line">    <span class="string">'''取一个字符串的hash值'''</span></span><br><span class="line">    sh = sha1()</span><br><span class="line">    sh.update(str.encode(<span class="string">'utf8'</span>))</span><br><span class="line">    <span class="keyword">return</span> sh.hexdigest()</span><br></pre></td></tr></table></figure>
<p>接下来我们将Users的表映射到数据库中去。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create database bookstore <span class="attribute">charset</span>=utf8;</span><br><span class="line">$ python manage.py makemigrations users</span><br><span class="line">$ python manage.py migrate</span><br></pre></td></tr></table></figure>
<h2 id="2，用户系统前端模板编写"><a href="#2，用户系统前端模板编写" class="headerlink" title="2，用户系统前端模板编写"></a>2，用户系统前端模板编写</h2><p>接下来我们要将前端模板写一下，先建一个模板文件夹。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mkdir templates</span></span><br></pre></td></tr></table></figure>
<p>我们第一个实现的功能是渲染注册页。将register.html拷贝到templates/users。<br>将js，css，images文件夹拷贝到static文件夹下。作为静态文件。<br>接下来我们将程序跑起来。看到了Django的欢迎页面。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> python manage.py runserver 9000</span></span><br></pre></td></tr></table></figure></p>
<p>然后呢？我们想把register.html渲染出来。我们先来看views.py这个视图文件。<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># users/views.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="string">'''显示用户注册页面'''</span></span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'users/register.html'</span>)</span><br></pre></td></tr></table></figure></p>
<p>然后我们将url映射做好。主应用的urls.py为<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># bookstore/urls.py</span></span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r'^admin/'</span>, include(admin.site.urls)),</span><br><span class="line">    url(<span class="string">r'^user/'</span>, include(<span class="string">'users.urls'</span>, namespace=<span class="string">'user'</span>)), <span class="comment"># 用户模块</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure></p>
<p>‘^’表示只匹配user为开头的url。<br>然后在users app里面的urls配置url映射。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># users/urls.py</span></span><br><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url</span><br><span class="line"><span class="keyword">from</span> users <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r'^register/$'</span>, views.register, name=<span class="string">'register'</span>), <span class="comment"># 用户注册</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure></p>
<p>将templates的路径写入配置文件中。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># settings.py</span></span><br><span class="line">TEMPLATES = [</span><br><span class="line">    &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="string">'DIRS'</span>: [os.path.join(BASE_DIR, <span class="string">'templates'</span>)], <span class="comment"># 这里别忘记配置！</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure></p>
<p>我们可以看到静态文件没有加载出来，所以我们要改一下html文件中的路径。将静态文件的路径前面加上’/static/‘<br>然后在配置文件中加入调试时使用的静态文件目录。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># settings.py</span></span><br><span class="line">STATICFILES_DIRS = [</span><br><span class="line">    os.path.join(BASE_DIR, <span class="string">'static'</span>)</span><br><span class="line">] <span class="comment"># 调试时使用的静态文件目录</span></span><br></pre></td></tr></table></figure></p>
<p>好。我们渲染注册页的任务就完成了。</p>
<h2 id="3，注册页面表单提交功能"><a href="#3，注册页面表单提交功能" class="headerlink" title="3，注册页面表单提交功能"></a>3，注册页面表单提交功能</h2><p>接下来我们要编写注册页面的提交表单功能。<br>1，接受前端传过来的表单数据。<br>2，校验数据。<br>3，写入数据库。<br>4，返回注册页（因为还没做首页）。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># users/views.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register_handle</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="string">'''进行用户注册处理'''</span></span><br><span class="line">    <span class="comment"># 接收数据</span></span><br><span class="line">    username = request.POST.get(<span class="string">'user_name'</span>)</span><br><span class="line">    password = request.POST.get(<span class="string">'pwd'</span>)</span><br><span class="line">    email = request.POST.get(<span class="string">'email'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 进行数据校验</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> all([username, password, email]):</span><br><span class="line">        <span class="comment"># 有数据为空</span></span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">'users/register.html'</span>, &#123;<span class="string">'errmsg'</span>: <span class="string">'参数不能为空!'</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 判断邮箱是否合法</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> re.match(<span class="string">r'^[a-z0-9][\w\.\-]*@[a-z0-9\-]+(\.[a-z]&#123;2,5&#125;)&#123;1,2&#125;$'</span>, email):</span><br><span class="line">        <span class="comment"># 邮箱不合法</span></span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">'users/register.html'</span>, &#123;<span class="string">'errmsg'</span>: <span class="string">'邮箱不合法!'</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 进行业务处理:注册，向账户系统中添加账户</span></span><br><span class="line">    <span class="comment"># Passport.objects.create(username=username, password=password, email=email)</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        Passport.objects.add_one_passport(username=username, password=password, email=email)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">'users/register.html'</span>, &#123;<span class="string">'errmsg'</span>: <span class="string">'用户名已存在！'</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 注册完，还是返回注册页。</span></span><br><span class="line">    <span class="keyword">return</span> redirect(reverse(<span class="string">'user:register'</span>))</span><br></pre></td></tr></table></figure></p>
<p>配置urls.py<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># users/urls.py</span></span><br><span class="line">url(<span class="string">r'^register_handle/$'</span>, views.register_handle, name=<span class="string">'register_handle'</span>), <span class="comment"># 用户注册处理</span></span><br></pre></td></tr></table></figure></p>
<p>前端使用Form来发送POST请求。<br><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;form <span class="function"><span class="keyword">method</span>="<span class="title">post</span>" <span class="title">action</span>="/<span class="title">user</span>/<span class="title">register_handle</span>/"&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>注意 添加csrf_token以及错误信息<br><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123; % csrf_token %&#125;</span><br><span class="line">&#123;&#123;errmsg&#125;&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后就完成注册功能了。之后需要实现发送激活邮件。</p>
<h1 id="3，书籍商品模块"><a href="#3，书籍商品模块" class="headerlink" title="3，书籍商品模块"></a><a id="3">3，书籍商品模块</a></h1><h2 id="1，渲染首页功能（书籍表结构设计）"><a href="#1，渲染首页功能（书籍表结构设计）" class="headerlink" title="1，渲染首页功能（书籍表结构设计）"></a>1，渲染首页功能（书籍表结构设计）</h2><p>完成注册功能以后，点击注册按钮应该跳转到首页。所以我们把首页index.html完成。先新建一个books app。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> python manage.py startapp books</span></span><br></pre></td></tr></table></figure></p>
<p>在配置文件中添加books app<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># bookstore/settings.py</span><br><span class="line">INSTALLED_APPS = (</span><br><span class="line">    ...</span><br><span class="line">    <span class="string">'users'</span>, # 用户模块</span><br><span class="line">    <span class="string">'books'</span>, # 商品模块</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>然后设计models，也就是books模块的表结构。这里我们先介绍一下富文本编辑器，因为编辑商品详情页需要使用富文本编辑器。</p>
<h3 id="富文本编辑器应用到项目中"><a href="#富文本编辑器应用到项目中" class="headerlink" title="富文本编辑器应用到项目中"></a>富文本编辑器应用到项目中</h3><ul>
<li><p>在settings.py中为INSTALLED_APPS添加编辑器应用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># settings.py</span></span><br><span class="line">INSTALLED_APPS = (</span><br><span class="line">    ...</span><br><span class="line">    <span class="string">'tinymce'</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
</li>
<li><p>在settings.py中添加编辑配置项</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">TINYMCE_DEFAULT_CONFIG = &#123;</span><br><span class="line">    <span class="string">'theme'</span>: <span class="string">'advanced'</span>,</span><br><span class="line">    <span class="string">'width'</span>: <span class="number">600</span>,</span><br><span class="line">    <span class="string">'height'</span>: <span class="number">400</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在根urls.py中配置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">    ...</span><br><span class="line">    url(<span class="string">r'^tinymce/'</span>, include(<span class="string">'tinymce.urls'</span>)),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>下面在我们的应用中添加富文本编辑器。<br>然后我们就可以设计我们的商品表结构了，我们可以通过观察detail.html来设计表结构。<br>我们先把一些常用的常量存储到books/enums.py文件中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">PYTHON = <span class="number">1</span></span><br><span class="line">JAVASCRIPT = <span class="number">2</span></span><br><span class="line">ALGORITHMS = <span class="number">3</span></span><br><span class="line">MACHINELEARNING = <span class="number">4</span></span><br><span class="line">OPERATINGSYSTEM = <span class="number">5</span></span><br><span class="line">DATABASE = <span class="number">6</span></span><br><span class="line"></span><br><span class="line">BOOKS_TYPE = &#123;</span><br><span class="line">    PYTHON: <span class="string">'Python'</span>,</span><br><span class="line">    JAVASCRIPT: <span class="string">'Javascript'</span>,</span><br><span class="line">    ALGORITHMS: <span class="string">'数据结构与算法'</span>,</span><br><span class="line">    MACHINELEARNING: <span class="string">'机器学习'</span>,</span><br><span class="line">    OPERATINGSYSTEM: <span class="string">'操作系统'</span>,</span><br><span class="line">    DATABASE: <span class="string">'数据库'</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">OFFLINE = <span class="number">0</span></span><br><span class="line">ONLINE = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">STATUS_CHOICE = &#123;</span><br><span class="line">    OFFLINE: <span class="string">'下线'</span>,</span><br><span class="line">    ONLINE: <span class="string">'上线'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后再来设计表结构：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> db.base_model <span class="keyword">import</span> BaseModel</span><br><span class="line"><span class="keyword">from</span> tinymce.models <span class="keyword">import</span> HTMLField</span><br><span class="line"><span class="keyword">from</span> books.enums <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># Create your models here.</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Books</span><span class="params">(BaseModel)</span>:</span></span><br><span class="line">    <span class="string">'''商品模型类'''</span></span><br><span class="line">    books_type_choices = ((k, v) <span class="keyword">for</span> k,v <span class="keyword">in</span> BOOKS_TYPE.items())</span><br><span class="line">    status_choices = ((k, v) <span class="keyword">for</span> k,v <span class="keyword">in</span> STATUS_CHOICE.items())</span><br><span class="line">    type_id = models.SmallIntegerField(default=PYTHON, choices=books_type_choices, verbose_name=<span class="string">'商品种类'</span>)</span><br><span class="line">    name = models.CharField(max_length=<span class="number">20</span>, verbose_name=<span class="string">'商品名称'</span>)</span><br><span class="line">    desc = models.CharField(max_length=<span class="number">128</span>, verbose_name=<span class="string">'商品简介'</span>)</span><br><span class="line">    price = models.DecimalField(max_digits=<span class="number">10</span>, decimal_places=<span class="number">2</span>, verbose_name=<span class="string">'商品价格'</span>)</span><br><span class="line">    unit = models.CharField(max_length=<span class="number">20</span>, verbose_name=<span class="string">'商品单位'</span>)</span><br><span class="line">    stock = models.IntegerField(default=<span class="number">1</span>, verbose_name=<span class="string">'商品库存'</span>)</span><br><span class="line">    sales = models.IntegerField(default=<span class="number">0</span>, verbose_name=<span class="string">'商品销量'</span>)</span><br><span class="line">    detail = HTMLField(verbose_name=<span class="string">'商品详情'</span>)</span><br><span class="line">    image = models.ImageField(upload_to=<span class="string">'books'</span>, verbose_name=<span class="string">'商品图片'</span>)</span><br><span class="line">    status = models.SmallIntegerField(default=ONLINE, choices=status_choices, verbose_name=<span class="string">'商品状态'</span>)</span><br><span class="line"></span><br><span class="line">    objects = BooksManager()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># admin显示书籍的名字</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.name</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        db_table = <span class="string">'s_books'</span></span><br><span class="line">        verbose_name = <span class="string">'书籍'</span></span><br><span class="line">        verbose_name_plural = <span class="string">'书籍'</span></span><br></pre></td></tr></table></figure>
<p>同样，我们这里再写一下BooksManager()，有一些基本功能在这里抽象出来。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BooksManager</span><span class="params">(models.Manager)</span>:</span></span><br><span class="line">    <span class="string">'''商品模型管理器类'''</span></span><br><span class="line">    <span class="comment"># sort='new' 按照创建时间进行排序</span></span><br><span class="line">    <span class="comment"># sort='hot' 按照商品销量进行排序</span></span><br><span class="line">    <span class="comment"># sort='price' 按照商品的价格进行排序</span></span><br><span class="line">    <span class="comment"># sort= 按照默认顺序排序</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_books_by_type</span><span class="params">(self, type_id, limit=None, sort=<span class="string">'default'</span>)</span>:</span></span><br><span class="line">        <span class="string">'''根据商品类型id查询商品信息'''</span></span><br><span class="line">        <span class="keyword">if</span> sort == <span class="string">'new'</span>:</span><br><span class="line">            order_by = (<span class="string">'-create_time'</span>,)</span><br><span class="line">        <span class="keyword">elif</span> sort == <span class="string">'hot'</span>:</span><br><span class="line">            order_by = (<span class="string">'-sales'</span>, )</span><br><span class="line">        <span class="keyword">elif</span> sort == <span class="string">'price'</span>:</span><br><span class="line">            order_by = (<span class="string">'price'</span>, )</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            order_by = (<span class="string">'-pk'</span>, ) <span class="comment"># 按照primary key降序排列。</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 查询数据</span></span><br><span class="line">        books_li = self.filter(type_id=type_id).order_by(*order_by)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 查询结果集的限制</span></span><br><span class="line">        <span class="keyword">if</span> limit:</span><br><span class="line">            books_li = books_li[:limit]</span><br><span class="line">        <span class="keyword">return</span> books_li</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_books_by_id</span><span class="params">(self, books_id)</span>:</span></span><br><span class="line">        <span class="string">'''根据商品的id获取商品信息'''</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            books = self.get(id=books_id)</span><br><span class="line">        <span class="keyword">except</span> self.model.DoesNotExist:</span><br><span class="line">            <span class="comment"># 不存在商品信息</span></span><br><span class="line">            books = <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">return</span> books</span><br></pre></td></tr></table></figure>
<p>做数据库迁移。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> python manage.py makemigrations books</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> python manage.py migrate</span></span><br></pre></td></tr></table></figure>
<p>好，接下来我们就可以将首页index.html渲染出来了。现在根urls.py中配置url。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url(<span class="string">r'^'</span>, include(<span class="string">'books.urls'</span>, namespace=<span class="string">'books'</span>)), <span class="comment"># 商品模块</span></span><br></pre></td></tr></table></figure>
<p>然后在books app中的urls.py中配置url。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url</span><br><span class="line"><span class="keyword">from</span> books <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r'^$'</span>, views.index, name=<span class="string">'index'</span>), <span class="comment"># 首页</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h2 id="2，编写书籍表视图函数。"><a href="#2，编写书籍表视图函数。" class="headerlink" title="2，编写书籍表视图函数。"></a>2，编写书籍表视图函数。</h2><p>然后编写视图文件views.py。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># books/views.py</span></span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render</span><br><span class="line"><span class="keyword">from</span> books.models <span class="keyword">import</span> Books</span><br><span class="line"><span class="keyword">from</span> books.enums <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> django.core.urlresolvers <span class="keyword">import</span> reverse</span><br><span class="line"><span class="keyword">from</span> django.core.paginator <span class="keyword">import</span> Paginator</span><br><span class="line"><span class="comment"># Create your views here.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="string">'''显示首页'''</span></span><br><span class="line">    <span class="comment"># 查询每个种类的3个新品信息和4个销量最好的商品信息</span></span><br><span class="line">    python_new = Books.objects.get_books_by_type(PYTHON, limit=<span class="number">3</span>, sort=<span class="string">'new'</span>)</span><br><span class="line">    python_hot = Books.objects.get_books_by_type(PYTHON, limit=<span class="number">4</span>, sort=<span class="string">'hot'</span>)</span><br><span class="line">    javascript_new = Books.objects.get_books_by_type(JAVASCRIPT,limit= <span class="number">3</span>, sort=<span class="string">'new'</span>)</span><br><span class="line">    javascript_hot = Books.objects.get_books_by_type(JAVASCRIPT, limit=<span class="number">4</span>, sort=<span class="string">'hot'</span>)</span><br><span class="line">    algorithms_new = Books.objects.get_books_by_type(ALGORITHMS, <span class="number">3</span>, sort=<span class="string">'new'</span>)</span><br><span class="line">    algorithms_hot = Books.objects.get_books_by_type(ALGORITHMS, <span class="number">4</span>, sort=<span class="string">'hot'</span>)</span><br><span class="line">    machinelearning_new = Books.objects.get_books_by_type(MACHINELEARNING, <span class="number">3</span>, sort=<span class="string">'new'</span>)</span><br><span class="line">    machinelearning_hot = Books.objects.get_books_by_type(MACHINELEARNING, <span class="number">4</span>, sort=<span class="string">'hot'</span>)</span><br><span class="line">    operatingsystem_new = Books.objects.get_books_by_type(OPERATINGSYSTEM, <span class="number">3</span>, sort=<span class="string">'new'</span>)</span><br><span class="line">    operatingsystem_hot = Books.objects.get_books_by_type(OPERATINGSYSTEM, <span class="number">4</span>, sort=<span class="string">'hot'</span>)</span><br><span class="line">    database_new = Books.objects.get_books_by_type(DATABASE, <span class="number">3</span>, sort=<span class="string">'new'</span>)</span><br><span class="line">    database_hot = Books.objects.get_books_by_type(DATABASE, <span class="number">4</span>, sort=<span class="string">'hot'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 定义模板上下文</span></span><br><span class="line">    context = &#123;</span><br><span class="line">        <span class="string">'python_new'</span>: python_new,</span><br><span class="line">        <span class="string">'python_hot'</span>: python_hot,</span><br><span class="line">        <span class="string">'javascript_new'</span>: javascript_new,</span><br><span class="line">        <span class="string">'javascript_hot'</span>: javascript_hot,</span><br><span class="line">        <span class="string">'algorithms_new'</span>: algorithms_new,</span><br><span class="line">        <span class="string">'algorithms_hot'</span>: algorithms_hot,</span><br><span class="line">        <span class="string">'machinelearning_new'</span>: machinelearning_new,</span><br><span class="line">        <span class="string">'machinelearning_hot'</span>: machinelearning_hot,</span><br><span class="line">        <span class="string">'operatingsystem_new'</span>: operatingsystem_new,</span><br><span class="line">        <span class="string">'operatingsystem_hot'</span>: operatingsystem_hot,</span><br><span class="line">        <span class="string">'database_new'</span>: database_new,</span><br><span class="line">        <span class="string">'database_hot'</span>: database_hot,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># 使用模板</span></span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'books/index.html'</span>, context)</span><br></pre></td></tr></table></figure>
<p>然后将index.html拷贝到templates/books。</p>
<h2 id="3，将Books注册到后台管理系统admin"><a href="#3，将Books注册到后台管理系统admin" class="headerlink" title="3，将Books注册到后台管理系统admin"></a>3，将Books注册到后台管理系统admin</h2><p>再将Books这个model注册到admin里面，方便管理，可以用来在后台编辑商品信息。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># books/admin.py</span></span><br><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> books.models <span class="keyword">import</span> Books</span><br><span class="line"><span class="comment"># Register your models here.</span></span><br><span class="line"></span><br><span class="line">admin.site.register(Books) <span class="comment"># 在admin中添加有关商品的编辑功能。</span></span><br></pre></td></tr></table></figure>
<p>然后我们创建超级管理员账户。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> python manage.py createsuperuser</span></span><br></pre></td></tr></table></figure>
<p>这样我们就可以登陆admin来管理商品信息了，admin功能是django的杀手锏之一。<br>接下来我们要把index.html中的文件路径改一下，要不然显示不出来。<br>我们通过分析模板来改写成后端渲染出来的模板。比如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="keyword">for</span> book <span class="keyword">in</span> python_new %&#125;</span><br><span class="line">    &lt;a href="#"&gt;&#123;&#123; book.name &#125;&#125;&lt;/a&gt;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>
<p>用来替换掉<code>index.html</code>中的：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>Python核心编程<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>笨办法学Python<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>Python学习手册<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>用代码：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;% for book in python_hot %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h4</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>&#123;&#123; book.name &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&#123;% static book.image %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"prize"</span>&gt;</span>¥ &#123;&#123; book.price &#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure></p>
<p>替换掉<code>index.html</code>中的：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h4</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>Python核心编程<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"images/book/book001.jpg"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"prize"</span>&gt;</span>¥ 30.00<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h4</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>Python学习手册<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"images/book/book002.jpg"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"prize"</span>&gt;</span>¥ 5.50<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h4</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>Python Cookbook<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"images/book/book003.jpg"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"prize"</span>&gt;</span>¥ 3.90<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h4</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>Python高性能编程<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"images/book/book004.jpg"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"prize"</span>&gt;</span>¥ 25.80<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>由于我们在编辑商品信息时，需要上传书籍的图片，所以在配置文件中设置图片存放目录。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># settings.py</span></span><br><span class="line">MEDIA_ROOT = os.path.join(BASE_DIR, <span class="string">"static"</span>)</span><br></pre></td></tr></table></figure>
<p>我们将’/static/images/…’的格式改成django里面推荐的用法。<br>在index.html开头添加</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">load</span></span> staticfiles %&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure>
<p>并改写静态文件url格式为：</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"</span></span></span><span class="template-tag">&#123;% <span class="name"><span class="name">static</span></span> book.image %&#125;</span><span class="xml"><span class="tag"><span class="string">"</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>好，那我们首页的渲染工作也就完成了。</p>
<h2 id="4，从注册页跳转到首页"><a href="#4，从注册页跳转到首页" class="headerlink" title="4，从注册页跳转到首页"></a>4，从注册页跳转到首页</h2><p>接下来我们将register.html注册完以后，跳转到首页去。</p>
<figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># user/views.py</span></span><br><span class="line"><span class="keyword">return</span> redirect(<span class="keyword">reverse</span>(<span class="string">'books:index'</span>))</span><br></pre></td></tr></table></figure>
<p>做完注册和首页，我们可以来做登陆页面了。将login.html拷贝到templates/users/下。<br>注意修改静态文件路径。然后编写/users/views.py文件中的login功能。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="string">'''显示登录页面'''</span></span><br><span class="line">    <span class="keyword">if</span> request.COOKIES.get(<span class="string">"username"</span>):</span><br><span class="line">        username = request.COOKIES.get(<span class="string">"username"</span>)</span><br><span class="line">        checked = <span class="string">'checked'</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        username = <span class="string">''</span></span><br><span class="line">        checked = <span class="string">''</span></span><br><span class="line">    context = &#123;</span><br><span class="line">        <span class="string">'username'</span>: username,</span><br><span class="line">        <span class="string">'checked'</span>: checked,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'users/login.html'</span>, context)</span><br></pre></td></tr></table></figure>
<p>将url配置到urls.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url(<span class="string">r'^login/$'</span>, views.login, name=<span class="string">'login'</span>) <span class="comment"># 显示登陆页面</span></span><br></pre></td></tr></table></figure>
<p>好，我们显示登陆页面也做完了。</p>
<h2 id="5，登陆功能的实现。"><a href="#5，登陆功能的实现。" class="headerlink" title="5，登陆功能的实现。"></a>5，登陆功能的实现。</h2><p>我们先来实现登录数据校验的功能。还有记住用户名的功能。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># users/views.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login_check</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="string">'''进行用户登录校验'''</span></span><br><span class="line">    <span class="comment"># 1.获取数据</span></span><br><span class="line">    username = request.POST.get(<span class="string">'username'</span>)</span><br><span class="line">    password = request.POST.get(<span class="string">'password'</span>)</span><br><span class="line">    remember = request.POST.get(<span class="string">'remember'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2.数据校验</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> all([username, password, remember]):</span><br><span class="line">        <span class="comment"># 有数据为空</span></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'res'</span>: <span class="number">2</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3.进行处理:根据用户名和密码查找账户信息</span></span><br><span class="line">    passport = Passport.objects.get_one_passport(username=username, password=password)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> passport:</span><br><span class="line">        next_url = reverse(<span class="string">'books:index'</span>) <span class="comment"># /user/</span></span><br><span class="line">        jres = JsonResponse(&#123;<span class="string">'res'</span>: <span class="number">1</span>, <span class="string">'next_url'</span>: next_url&#125;)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 判断是否需要记住用户名</span></span><br><span class="line">        <span class="keyword">if</span> remember == <span class="string">'true'</span>:</span><br><span class="line">            <span class="comment"># 记住用户名</span></span><br><span class="line">            jres.set_cookie(<span class="string">'username'</span>, username, max_age=<span class="number">7</span>*<span class="number">24</span>*<span class="number">3600</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 不要记住用户名</span></span><br><span class="line">            jres.delete_cookie(<span class="string">'username'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 记住用户的登录状态</span></span><br><span class="line">        request.session[<span class="string">'islogin'</span>] = <span class="keyword">True</span></span><br><span class="line">        request.session[<span class="string">'username'</span>] = username</span><br><span class="line">        request.session[<span class="string">'passport_id'</span>] = passport.id</span><br><span class="line">        <span class="keyword">return</span> jres</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># 用户名或密码错误</span></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'res'</span>: <span class="number">0</span>&#125;)</span><br></pre></td></tr></table></figure>
<p>这个函数在前端发送数据是调用。我们在前端编写一段发送ajax post请求的html代码和jquery代码。将下面这段代码替换掉表单代码：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123; % csrf_token %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">id</span>=<span class="string">"username"</span> <span class="attr">class</span>=<span class="string">"name_input"</span> <span class="attr">value</span>=<span class="string">"&#123;&#123; username &#125;&#125;"</span> <span class="attr">placeholder</span>=<span class="string">"请输入用户名"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"user_error"</span>&gt;</span>输入错误<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">id</span>=<span class="string">"pwd"</span> <span class="attr">class</span>=<span class="string">"pass_input"</span> <span class="attr">placeholder</span>=<span class="string">"请输入密码"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"pwd_error"</span>&gt;</span>输入错误<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"more_input clearfix"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">name</span>=<span class="string">"remember"</span> &#123;&#123; <span class="attr">checked</span> &#125;&#125;&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span>&gt;</span>记住用户名<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>忘记密码<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">id</span>=<span class="string">"btnLogin"</span> <span class="attr">value</span>=<span class="string">"登录"</span> <span class="attr">class</span>=<span class="string">"input_submit"</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'js/jquery-1.12.4.min.js' %&#125;"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">    $(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        $(<span class="string">'#btnLogin'</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> username = $(<span class="string">"#username"</span>).val()</span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> password = $(<span class="string">"#pwd"</span>).val()</span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> remember = $(<span class="string">'input[name="remember"]'</span>).prop(<span class="string">'checked'</span>)</span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> csrfmiddlewaretoken = $(<span class="string">'input[name="csrfmiddlewaretoken"]'</span>).val()</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">            <span class="keyword">var</span> params = &#123;</span></span><br><span class="line"><span class="undefined">                username: username,</span></span><br><span class="line"><span class="undefined">                password: password,</span></span><br><span class="line"><span class="undefined">                remember: remember,</span></span><br><span class="line"><span class="undefined">                csrfmiddlewaretoken: csrfmiddlewaretoken</span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="javascript">            $.post(<span class="string">'/user/login_check/'</span>, params, <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span></span><br><span class="line"><span class="actionscript">                <span class="comment">// 用户名密码错误 &#123;'res': 0&#125;</span></span></span><br><span class="line"><span class="actionscript">                <span class="comment">// 登录成功 &#123;'res': 1&#125;</span></span></span><br><span class="line"><span class="actionscript">                <span class="keyword">if</span> (data.res == <span class="number">1</span>) &#123;</span></span><br><span class="line"><span class="actionscript">                    <span class="comment">// 跳转页面</span></span></span><br><span class="line"><span class="undefined">                    location.href = data.next_url;</span></span><br><span class="line"><span class="actionscript">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (data.res == <span class="number">2</span>) &#123;</span></span><br><span class="line"><span class="actionscript">                    alert(<span class="string">"数据不完整"</span>);</span></span><br><span class="line"><span class="actionscript">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (data.res == <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="actionscript">                    alert(<span class="string">"用户名或者密码错误"</span>);</span></span><br><span class="line"><span class="undefined">                &#125;</span></span><br><span class="line"><span class="undefined">            &#125;)</span></span><br><span class="line"><span class="undefined">        &#125;)</span></span><br><span class="line"><span class="undefined">    &#125;)</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>配置urls.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url(<span class="string">r'^login_check/$'</span>, views.login_check, name=<span class="string">'login_check'</span>), <span class="comment"># 用户登录校验</span></span><br></pre></td></tr></table></figure>
<h2 id="6，首页上的登陆和注册按钮redirect到相关页面。"><a href="#6，首页上的登陆和注册按钮redirect到相关页面。" class="headerlink" title="6，首页上的登陆和注册按钮redirect到相关页面。"></a>6，首页上的登陆和注册按钮redirect到相关页面。</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'user:login' %&#125;"</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">span</span>&gt;</span>|<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'user:register' %&#125;"</span>&gt;</span>注册<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>现在登陆以后还是显示登陆和注册，应该显示用户名才对。我们来修改一下index.html。这里就会用到session这个概念了。顺便把logout功能也实现了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /user/logout</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logout</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="string">'''用户退出登录'''</span></span><br><span class="line">    <span class="comment"># 清空用户的session信息</span></span><br><span class="line">    request.session.flush()</span><br><span class="line">    <span class="comment"># 跳转到首页</span></span><br><span class="line">    <span class="keyword">return</span> redirect(reverse(<span class="string">'books:index'</span>))</span><br></pre></td></tr></table></figure>
<p>然后改写index.html</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="keyword">if</span> request.session.islogin %&#125;</span><br><span class="line">&lt;div class="login_btn fl"&gt;</span><br><span class="line">    欢迎您：&lt;em&gt;&#123;&#123; request.session.username &#125;&#125;&lt;/em&gt;</span><br><span class="line">    &lt;span&gt;|&lt;/span&gt;</span><br><span class="line">    &lt;a href="&#123;% url 'user:logout' %&#125;"&gt;退出&lt;/a&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&#123;% <span class="keyword">else</span> %&#125;</span><br><span class="line">&lt;div class="login_btn fl"&gt;</span><br><span class="line">    &lt;a href="&#123;% url 'user:login' %&#125;"&gt;登录&lt;/a&gt;</span><br><span class="line">    &lt;span&gt;|&lt;/span&gt;</span><br><span class="line">    &lt;a href="&#123;% url 'user:register' %&#125;"&gt;注册&lt;/a&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>
<p>配置urls.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url(<span class="string">r'^logout/$'</span>, views.logout, name=<span class="string">'logout'</span>), <span class="comment"># 退出用户登录</span></span><br></pre></td></tr></table></figure>
<h2 id="7，实现商品详情页的功能"><a href="#7，实现商品详情页的功能" class="headerlink" title="7，实现商品详情页的功能"></a>7，实现商品详情页的功能</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># books/views.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">detail</span><span class="params">(request, books_id)</span>:</span></span><br><span class="line">    <span class="string">'''显示商品的详情页面'''</span></span><br><span class="line">    <span class="comment"># 获取商品的详情信息</span></span><br><span class="line">    books = Books.objects.get_books_by_id(books_id=books_id)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> books <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">        <span class="comment"># 商品不存在，跳转到首页</span></span><br><span class="line">        <span class="keyword">return</span> redirect(reverse(<span class="string">'books:index'</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 新品推荐</span></span><br><span class="line">    books_li = Books.objects.get_books_by_type(type_id=books.type_id, limit=<span class="number">2</span>, sort=<span class="string">'new'</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 当前商品类型</span></span><br><span class="line">    type_title = BOOKS_TYPE[books.type_id]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 定义上下文</span></span><br><span class="line">    context = &#123;<span class="string">'books'</span>: books, <span class="string">'books_li'</span>: books_li，<span class="string">'type_title'</span>:type_title&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 使用模板</span></span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'books/detail.html'</span>, context)</span><br></pre></td></tr></table></figure>
<p>配置urls.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url(<span class="string">r'books/(?P&lt;books_id&gt;\d+)/$'</span>, views.detail, name=<span class="string">'detail'</span>), <span class="comment"># 详情页</span></span><br></pre></td></tr></table></figure>
<p>将detail.html页面拷贝到templates/books下。<br>然后将detail.html页面改写成django可以渲染的模板。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#动态添加详情页商品的标签(全部商品下的)</span><br><span class="line">&#123;&#123;type_title&#125;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>&#123;&#123; books.name &#125;&#125;<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123; books.desc &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"price_bar"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"show_pirze"</span>&gt;</span>¥<span class="tag">&lt;<span class="name">em</span>&gt;</span>&#123;&#123; books.price &#125;&#125;<span class="tag">&lt;/<span class="name">em</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"show_unit"</span>&gt;</span>单  位：&#123;&#123; books.unit &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;% for book in books_li %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'books:detail' books_id=book.id %&#125;"</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&#123;% static book.image %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h4</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'books:detail' books_id=book.id %&#125;"</span>&gt;</span>&#123;&#123; book.name &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"price"</span>&gt;</span>￥&#123;&#123; book.price &#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>
<p>然后将静态文件的路径修改。<br>比如：<br><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"</span></span></span><span class="template-tag">&#123;% <span class="name"><span class="name">static</span></span> books.image %&#125;</span><span class="xml"><span class="tag"><span class="string">"</span>&gt;</span></span></span><br></pre></td></tr></table></figure></p>
<p>然后将登陆后的用户名等显示出来。那商品详情页就开发的差不多了。</p>
<h2 id="8，抽象出一个通用的模板，供别的模板继承。"><a href="#8，抽象出一个通用的模板，供别的模板继承。" class="headerlink" title="8，抽象出一个通用的模板，供别的模板继承。"></a>8，抽象出一个通用的模板，供别的模板继承。</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">&#123;# 首页 登录 注册 的父模板 #&#125;</span><br><span class="line"><span class="meta">&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/1999/xhtml"</span> <span class="attr">xml:lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">&#123;% load staticfiles %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html;charset=UTF-8"</span>&gt;</span></span><br><span class="line">    &#123;# 网页顶部标题块 #&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>&#123;% block title %&#125;&#123;% endblock title %&#125;<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">type</span>=<span class="string">"text/css"</span> <span class="attr">href</span>=<span class="string">"&#123;% static 'css/reset.css' %&#125;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">type</span>=<span class="string">"text/css"</span> <span class="attr">href</span>=<span class="string">"&#123;% static 'css/main.css' %&#125;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'js/jquery-1.12.4.min.js' %&#125;"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'js/jquery-ui.min.js' %&#125;"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'js/slide.js' %&#125;"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    &#123;# 网页顶部引入文件块 #&#125;</span><br><span class="line">    &#123;% block topfiles %&#125;</span><br><span class="line">    &#123;% endblock topfiles %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">&#123;# 网页顶部欢迎信息块 #&#125;</span><br><span class="line">&#123;% block header_con %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"header_con"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"header"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"welcome fl"</span>&gt;</span>欢迎来到尚硅谷书店!<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"fr"</span>&gt;</span></span><br><span class="line">                &#123;% if request.session.islogin %&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"login_btn fl"</span>&gt;</span></span><br><span class="line">                    欢迎您：<span class="tag">&lt;<span class="name">em</span>&gt;</span>&#123;&#123; request.session.username &#125;&#125;<span class="tag">&lt;/<span class="name">em</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span>&gt;</span>|<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'user:logout' %&#125;"</span>&gt;</span>退出<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                &#123;% else %&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"login_btn fl"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'user:login' %&#125;"</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span>&gt;</span>|<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'user:register' %&#125;"</span>&gt;</span>注册<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                &#123;% endif %&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"user_link fl"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span>&gt;</span>|<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>用户中心<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span>&gt;</span>|<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>我的购物车<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span>&gt;</span>|<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>我的订单<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span>      </span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endblock header_con %&#125;</span><br><span class="line">&#123;# 网页顶部搜索框块 #&#125;</span><br><span class="line">&#123;% block search_bar %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"search_bar clearfix"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'books:index' %&#125;"</span> <span class="attr">class</span>=<span class="string">"logo fl"</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'images/logo.png' %&#125;"</span> <span class="attr">style</span>=<span class="string">"width: 160px; height: 53px;"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"search_con fl"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">class</span>=<span class="string">"input_text fl"</span> <span class="attr">name</span>=<span class="string">""</span> <span class="attr">placeholder</span>=<span class="string">"搜索商品"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"input_btn fr"</span> <span class="attr">name</span>=<span class="string">""</span> <span class="attr">value</span>=<span class="string">"搜索"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"guest_cart fr"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span> <span class="attr">class</span>=<span class="string">"cart_name fl"</span>&gt;</span>我的购物车<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"book_count fl"</span> <span class="attr">id</span>=<span class="string">"show_count"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endblock search_bar %&#125;</span><br><span class="line">&#123;# 网页主体内容块 #&#125;</span><br><span class="line">&#123;% block body %&#125;&#123;% endblock body %&#125;</span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"footer"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"foot_link"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>关于我们<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span>&gt;</span>|<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>联系我们<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span>&gt;</span>|<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>招聘人才<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span>&gt;</span>|<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>友情链接<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>CopyRight © 2016 北京尚硅谷信息技术有限公司 All Rights Reserved<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>电话：010-****888    京ICP备*******8号<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    &#123;# 网页底部html元素块 #&#125;</span><br><span class="line">    &#123;% block bottom %&#125;&#123;% endblock bottom %&#125;</span><br><span class="line">    &#123;# 网页底部引入文件块 #&#125;</span><br><span class="line">    &#123;% block bottomfiles %&#125;&#123;% endblock bottomfiles %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>然后在别的模板中继承base.html，这就是抽象的好处。现在的组件化思路也是这样的，松耦合，紧内聚，复用的思路。<br>比如改写register.html<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends 'base.html' %&#125;</span><br><span class="line">&#123;% load staticfiles %&#125;</span><br><span class="line">&#123;% block title %&#125;尚硅谷书城-注册&#123;% endblock title %&#125;</span><br><span class="line">&#123;% block topfiles %&#125;</span><br><span class="line">&#123;% endblock topfiles %&#125;</span><br><span class="line">&#123;% block header_con %&#125;&#123;% endblock header_con %&#125;</span><br><span class="line">&#123;% block search_bar %&#125;&#123;% endblock search_bar %&#125;</span><br><span class="line">&#123;% block body %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"register_con"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"l_con fl"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"reg_logo"</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"/static/images/logo.png"</span> <span class="attr">style</span>=<span class="string">"width: 160px; height: 53px;"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"reg_slogan"</span>&gt;</span>学计算机  ·  来尚硅谷<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"reg_banner"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"r_con fr"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"reg_title clearfix"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h1</span>&gt;</span>用户注册<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"reg_form clearfix"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">action</span>=<span class="string">"/user/register_handle/"</span>&gt;</span></span><br><span class="line">                    &#123; % csrf_token %&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">label</span>&gt;</span>用户名:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"user_name"</span> <span class="attr">id</span>=<span class="string">"user_name"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"error_tip"</span>&gt;</span>提示信息<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">label</span>&gt;</span>密码:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"pwd"</span> <span class="attr">id</span>=<span class="string">"pwd"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"error_tip"</span>&gt;</span>提示信息<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">label</span>&gt;</span>确认密码:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"cpwd"</span> <span class="attr">id</span>=<span class="string">"cpwd"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"error_tip"</span>&gt;</span>提示信息<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">label</span>&gt;</span>邮箱:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"email"</span> <span class="attr">id</span>=<span class="string">"email"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"error_tip"</span>&gt;</span>提示信息<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"agreement"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">name</span>=<span class="string">"allow"</span> <span class="attr">id</span>=<span class="string">"allow"</span> <span class="attr">checked</span>=<span class="string">"checked"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">label</span>&gt;</span>同意”尚硅谷书城用户使用协议“<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"error_tip2"</span>&gt;</span>提示信息<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"reg_sub"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"注 册"</span> <span class="attr">name</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">                        &#123;&#123;errmsg&#125;&#125;</span><br><span class="line">                    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endblock body %&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后改写login.html<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends 'base.html' %&#125;</span><br><span class="line">&#123;% load staticfiles %&#125;</span><br><span class="line">&#123;% block title %&#125;尚硅谷书城-登录&#123;% endblock title %&#125;</span><br><span class="line">&#123;% block topfiles %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">    $(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        $(<span class="string">'#btnLogin'</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="actionscript">            <span class="comment">// 获取用户名和密码</span></span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> username = $(<span class="string">'#username'</span>).val()</span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> password = $(<span class="string">'#pwd'</span>).val()</span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> csrf = $(<span class="string">'input[name="csrfmiddlewaretoken"]'</span>).val()</span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> remember = $(<span class="string">'input[name="remember"]'</span>).prop(<span class="string">'checked'</span>)</span></span><br><span class="line"><span class="actionscript">            <span class="comment">// 发起ajax请求</span></span></span><br><span class="line"><span class="actionscript">            <span class="keyword">var</span> params = &#123;</span></span><br><span class="line"><span class="actionscript">                <span class="string">'username'</span>: username,</span></span><br><span class="line"><span class="actionscript">                <span class="string">'password'</span>: password,</span></span><br><span class="line"><span class="actionscript">                <span class="string">'csrfmiddlewaretoken'</span>: csrf,</span></span><br><span class="line"><span class="actionscript">                <span class="string">'remember'</span>: remember</span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="javascript">            $.post(<span class="string">'/user/login_check/'</span>, params, <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span></span><br><span class="line"><span class="actionscript">                <span class="comment">// 用户名密码错误 &#123;'res':0&#125;</span></span></span><br><span class="line"><span class="actionscript">                <span class="comment">// 登录成功 &#123;'res':1&#125;</span></span></span><br><span class="line"><span class="actionscript">                <span class="keyword">if</span> (data.res == <span class="number">0</span>)&#123;</span></span><br><span class="line"><span class="javascript">                    $(<span class="string">'#username'</span>).next().html(<span class="string">'用户名或密码错误'</span>).show()</span></span><br><span class="line"><span class="undefined">                &#125;</span></span><br><span class="line"><span class="actionscript">                <span class="keyword">else</span></span></span><br><span class="line"><span class="undefined">                &#123;</span></span><br><span class="line"><span class="actionscript">                    <span class="comment">// 跳转页面</span></span></span><br><span class="line"><span class="actionscript">                    location.href = data.next_url <span class="comment">// /user/</span></span></span><br><span class="line"><span class="undefined">                &#125;</span></span><br><span class="line"><span class="undefined">            &#125;)</span></span><br><span class="line"><span class="undefined">        &#125;)</span></span><br><span class="line"><span class="undefined">    &#125;)</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">&#123;% endblock topfiles %&#125;</span><br><span class="line">&#123;% block header_con %&#125;&#123;% endblock header_con %&#125;</span><br><span class="line">&#123;% block search_bar %&#125;&#123;% endblock search_bar %&#125;</span><br><span class="line">&#123;% block body %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"login_top clearfix"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"index.html"</span> <span class="attr">class</span>=<span class="string">"login_logo"</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'images/logo.png' %&#125;"</span> <span class="attr">style</span>=<span class="string">"width: 160px; height: 53px;"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"login_form_bg"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"login_form_wrap clearfix"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"login_banner fl"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"slogan fl"</span>&gt;</span>学计算机 · 来尚硅谷<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"login_form fr"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"login_title clearfix"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>用户登录<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>立即注册<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form_input"</span>&gt;</span></span><br><span class="line">                    &#123; % csrf_token %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">id</span>=<span class="string">"username"</span> <span class="attr">class</span>=<span class="string">"name_input"</span> <span class="attr">value</span>=<span class="string">"&#123;&#123; username &#125;&#125;"</span> <span class="attr">placeholder</span>=<span class="string">"请输入用户名"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"user_error"</span>&gt;</span>输入错误<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">id</span>=<span class="string">"pwd"</span> <span class="attr">class</span>=<span class="string">"pass_input"</span> <span class="attr">placeholder</span>=<span class="string">"请输入密码"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"pwd_error"</span>&gt;</span>输入错误<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"more_input clearfix"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">name</span>=<span class="string">"remember"</span> &#123;&#123; <span class="attr">checked</span> &#125;&#125;&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">label</span>&gt;</span>记住用户名<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>忘记密码<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">id</span>=<span class="string">"btnLogin"</span> <span class="attr">value</span>=<span class="string">"登录"</span> <span class="attr">class</span>=<span class="string">"input_submit"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endblock body %&#125;</span><br></pre></td></tr></table></figure></p>
<p>改写index.html<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends 'base.html' %&#125;</span><br><span class="line">&#123;% load staticfiles %&#125;</span><br><span class="line">&#123;% block title %&#125;尚硅谷书店-首页&#123;% endblock title %&#125;</span><br><span class="line">&#123;% block topfiles %&#125;</span><br><span class="line">&#123;% endblock topfiles %&#125;</span><br><span class="line">&#123;% block body %&#125;</span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"navbar_con"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"navbar"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">h1</span> <span class="attr">class</span>=<span class="string">"fl"</span>&gt;</span>全部商品分类<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"navlist fl"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>首页<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"interval"</span>&gt;</span>|<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>移动端书城<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"interval"</span>&gt;</span>|<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>秒杀<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"center_con clearfix"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"subnav fl"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#model01"</span> <span class="attr">class</span>=<span class="string">"python"</span>&gt;</span>Python<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#model02"</span> <span class="attr">class</span>=<span class="string">"javascript"</span>&gt;</span>Javascript<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#model03"</span> <span class="attr">class</span>=<span class="string">"algorithms"</span>&gt;</span>数据结构与算法<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#model04"</span> <span class="attr">class</span>=<span class="string">"machinelearning"</span>&gt;</span>机器学习<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#model05"</span> <span class="attr">class</span>=<span class="string">"operatingsystem"</span>&gt;</span>操作系统<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#model06"</span> <span class="attr">class</span>=<span class="string">"database"</span>&gt;</span>数据库<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"slide fl"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"slide_pics"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'images/slide.jpg' %&#125;"</span> <span class="attr">alt</span>=<span class="string">"幻灯片"</span> <span class="attr">style</span>=<span class="string">"width: 760px; height: 270px;"</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'images/slide02.jpg' %&#125;"</span> <span class="attr">alt</span>=<span class="string">"幻灯片"</span> <span class="attr">style</span>=<span class="string">"width: 760px; height: 270px;"</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'images/slide03.jpg' %&#125;"</span> <span class="attr">alt</span>=<span class="string">"幻灯片"</span> <span class="attr">style</span>=<span class="string">"width: 760px; height: 270px;"</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'images/slide04.jpg' %&#125;"</span> <span class="attr">alt</span>=<span class="string">"幻灯片"</span> <span class="attr">style</span>=<span class="string">"width: 760px; height: 270px;"</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"prev"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"next"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"points"</span>&gt;</span><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"adv fl"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'images/adv01.jpg' %&#125;"</span> <span class="attr">style</span>=<span class="string">"width: 240px; height: 135px;"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'images/adv02.jpg' %&#125;"</span> <span class="attr">style</span>=<span class="string">"width: 240px; height: 135px;"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"list_model"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"list_title clearfix"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">h3</span> <span class="attr">class</span>=<span class="string">"fl"</span> <span class="attr">id</span>=<span class="string">"model01"</span>&gt;</span>Python<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"subtitle fl"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span>&gt;</span>|<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                &#123;% for book in python_new %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'books:detail' books_id=book.id %&#125;"</span>&gt;</span>&#123;&#123; book.name &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                &#123;% endfor %&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span> <span class="attr">class</span>=<span class="string">"book_more fr"</span>&gt;</span>查看更多 &gt;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"book_con clearfix"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"book_banner fl"</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'images/banner01.jpg' %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"book_list fl"</span>&gt;</span></span><br><span class="line">                &#123;% for book in python_hot %&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">h4</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'books:detail' books_id=book.id  %&#125;"</span>&gt;</span>&#123;&#123; book.name &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'books:detail' books_id=book.id  %&#125;"</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&#123;% static book.image %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"price"</span>&gt;</span>¥ &#123;&#123; book.price &#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                &#123;% endfor %&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"list_model"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"list_title clearfix"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">h3</span> <span class="attr">class</span>=<span class="string">"fl"</span> <span class="attr">id</span>=<span class="string">"model02"</span>&gt;</span>Javascript<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"subtitle fl"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span>&gt;</span>|<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                &#123;% for book in javascript_new %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>&#123;&#123; book.name &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                &#123;% endfor %&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span> <span class="attr">class</span>=<span class="string">"book_more fr"</span>&gt;</span>查看更多 &gt;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"book_con clearfix"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"book_banner fl"</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'images/banner02.jpg' %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"book_list fl"</span>&gt;</span></span><br><span class="line">                &#123;% for book in javascript_hot %&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">h4</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>&#123;&#123; book.name &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&#123;% static book.image %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"price"</span>&gt;</span>¥ &#123;&#123; book.price &#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                &#123;% endfor %&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"list_model"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"list_title clearfix"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">h3</span> <span class="attr">class</span>=<span class="string">"fl"</span> <span class="attr">id</span>=<span class="string">"model03"</span>&gt;</span>数据结构与算法<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"subtitle fl"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span>&gt;</span>|<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                &#123;% for book in algorithms_new %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>&#123;&#123; book.name &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                &#123;% endfor %&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span> <span class="attr">class</span>=<span class="string">"book_more fr"</span>&gt;</span>查看更多 &gt;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"book_con clearfix"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"book_banner fl"</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'images/banner03.jpg' %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"book_list fl"</span>&gt;</span></span><br><span class="line">                &#123;% for book in algorithms_hot %&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">h4</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>&#123;&#123; book.name &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&#123;% static book.image %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"price"</span>&gt;</span>¥ &#123;&#123; book.price &#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                &#123;% endfor %&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"list_model"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"list_title clearfix"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">h3</span> <span class="attr">class</span>=<span class="string">"fl"</span> <span class="attr">id</span>=<span class="string">"model04"</span>&gt;</span>机器学习<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"subtitle fl"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span>&gt;</span>|<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                &#123;% for book in machinelearning_new %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>&#123;&#123; book.name &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                &#123;% endfor %&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span> <span class="attr">class</span>=<span class="string">"book_more fr"</span>&gt;</span>查看更多 &gt;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"book_con clearfix"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"book_banner fl"</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'images/banner04.jpg' %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"book_list fl"</span>&gt;</span></span><br><span class="line">                &#123;% for book in machinelearning_hot %&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">h4</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>&#123;&#123; book.name &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&#123;% static book.image %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"price"</span>&gt;</span>¥ &#123;&#123; book.price &#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                &#123;% endfor %&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"list_model"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"list_title clearfix"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">h3</span> <span class="attr">class</span>=<span class="string">"fl"</span> <span class="attr">id</span>=<span class="string">"model05"</span>&gt;</span>操作系统<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"subtitle fl"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span>&gt;</span>|<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                &#123;% for book in operatingsystem_new %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>&#123;&#123; book.name &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                &#123;% endfor %&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span> <span class="attr">class</span>=<span class="string">"book_more fr"</span>&gt;</span>查看更多 &gt;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"book_con clearfix"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"book_banner fl"</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'images/banner05.jpg' %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"book_list fl"</span>&gt;</span></span><br><span class="line">                &#123;% for book in operatingsystem_hot %&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">h4</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>&#123;&#123; book.name &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&#123;% static book.image %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"price"</span>&gt;</span>¥ &#123;&#123; book.price &#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                &#123;% endfor %&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"list_model"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"list_title clearfix"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">h3</span> <span class="attr">class</span>=<span class="string">"fl"</span> <span class="attr">id</span>=<span class="string">"model06"</span>&gt;</span>数据库<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"subtitle fl"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span>&gt;</span>|<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                &#123;% for book in database_new %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>&#123;&#123; book.name &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                &#123;% endfor %&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span> <span class="attr">class</span>=<span class="string">"book_more fr"</span>&gt;</span>查看更多 &gt;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"book_con clearfix"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"book_banner fl"</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&#123;% static 'images/banner06.jpg' %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"book_list fl"</span>&gt;</span></span><br><span class="line">                &#123;% for book in database_hot %&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">h4</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>&#123;&#123; book.name &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&#123;% static book.image %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"price"</span>&gt;</span>¥ &#123;&#123; book.price &#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                &#123;% endfor %&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">&#123;% endblock body %&#125;</span><br></pre></td></tr></table></figure></p>
<p>改写detail.html<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends 'base.html' %&#125;</span><br><span class="line">&#123;% load staticfiles %&#125;</span><br><span class="line">&#123;% block title %&#125;尚硅谷书店-首页&#123;% endblock title %&#125;</span><br><span class="line">&#123;% block body %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"navbar_con"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"navbar clearfix"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"subnav_con fl"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h1</span>&gt;</span>全部商品分类<span class="tag">&lt;/<span class="name">h1</span>&gt;</span> </span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span>           </span><br><span class="line">                <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"subnav"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span> <span class="attr">class</span>=<span class="string">"python"</span>&gt;</span>Python<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span> <span class="attr">class</span>=<span class="string">"javascript"</span>&gt;</span>Javascript<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span> <span class="attr">class</span>=<span class="string">"algorithms"</span>&gt;</span>数据结构与算法<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span> <span class="attr">class</span>=<span class="string">"machinelearning"</span>&gt;</span>机器学习<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span> <span class="attr">class</span>=<span class="string">"operatingsystem"</span>&gt;</span>操作系统<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span> <span class="attr">class</span>=<span class="string">"database"</span>&gt;</span>数据库<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"navlist fl"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>首页<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"interval"</span>&gt;</span>|<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>移动端书城<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"interval"</span>&gt;</span>|<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>秒杀<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"breadcrumb"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>全部分类<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span>&gt;</span>&gt;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>Python<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span>&gt;</span>&gt;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>商品详情<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"book_detail_con clearfix"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"book_detail_pic fl"</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&#123;% static books.image %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"book_detail_list fr"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">h3</span>&gt;</span>&#123;&#123; books.name &#125;&#125;<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123; books.desc &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"price_bar"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"show_pirze"</span>&gt;</span>¥<span class="tag">&lt;<span class="name">em</span>&gt;</span>&#123;&#123; books.price &#125;&#125;<span class="tag">&lt;/<span class="name">em</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"show_unit"</span>&gt;</span>单  位：&#123;&#123; books.unit &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"book_num clearfix"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"num_name fl"</span>&gt;</span>数 量：<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"num_add fl"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">class</span>=<span class="string">"num_show fl"</span> <span class="attr">value</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:;"</span> <span class="attr">class</span>=<span class="string">"add fr"</span>&gt;</span>+<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:;"</span> <span class="attr">class</span>=<span class="string">"minus fr"</span>&gt;</span>-<span class="tag">&lt;/<span class="name">a</span>&gt;</span>   </span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span> </span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"total"</span>&gt;</span>总价：<span class="tag">&lt;<span class="name">em</span>&gt;</span>100元<span class="tag">&lt;/<span class="name">em</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"operate_btn"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:;"</span> <span class="attr">class</span>=<span class="string">"buy_btn"</span>&gt;</span>立即购买<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:;"</span> <span class="attr">class</span>=<span class="string">"add_cart"</span> <span class="attr">id</span>=<span class="string">"add_cart"</span>&gt;</span>加入购物车<span class="tag">&lt;/<span class="name">a</span>&gt;</span>             </span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"main_wrap clearfix"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"l_wrap fl clearfix"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"new_book"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h3</span>&gt;</span>新品推荐<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">                    &#123;% for book in books_li %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'books:detail' books_id=books.id %&#125;"</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&#123;% static book.image %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">h4</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'books:detail' books_id=books.id %&#125;"</span>&gt;</span>&#123;&#123; book.name &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"price"</span>&gt;</span>￥&#123;&#123; book.price &#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    &#123;% endfor %&#125;</span><br><span class="line">                <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"r_wrap fr clearfix"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"detail_tab clearfix"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"active"</span>&gt;</span>商品介绍<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>&gt;</span>评论<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"tab_content"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">dl</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">dt</span>&gt;</span>商品详情：<span class="tag">&lt;/<span class="name">dt</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">dd</span>&gt;</span>&#123;&#123; books.detail | safe &#125;&#125;<span class="tag">&lt;/<span class="name">dd</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">dl</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"add_jump"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endblock body %&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里要注意的是override也就是复写的问题，其实是面向对象的思想。</p>
<h2 id="9，列表页的开发"><a href="#9，列表页的开发" class="headerlink" title="9，列表页的开发"></a>9，列表页的开发</h2><p>接下来我们来实现列表页。通过观察list.html我们可以发现，这里有分页的功能，以及按照不同特征来进行排序，比如价格，比如人气这样的特征。这里要注意分页功能的实现，以及为什么要分页，一下读取所有数据，数据库的压力很大。<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 商品种类 页码 排序方式</span></span><br><span class="line"><span class="comment"># /list/(种类id)/(页码)/?sort=排序方式</span></span><br><span class="line"><span class="keyword">from</span> django.core.paginator <span class="keyword">import</span> Paginator</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">list</span><span class="params">(request, type_id, page)</span>:</span></span><br><span class="line">    <span class="string">'''商品列表页面'''</span></span><br><span class="line">    <span class="comment"># 获取排序方式</span></span><br><span class="line">    sort = request.GET.get(<span class="string">'sort'</span>, <span class="string">'default'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 判断type_id是否合法</span></span><br><span class="line">    <span class="keyword">if</span> int(type_id) <span class="keyword">not</span> <span class="keyword">in</span> BOOKS_TYPE.keys():</span><br><span class="line">        <span class="keyword">return</span> redirect(reverse(<span class="string">'books:index'</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 根据商品种类id和排序方式查询数据</span></span><br><span class="line">    books_li = Books.objects.get_books_by_type(type_id=type_id, sort=sort)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 分页</span></span><br><span class="line">    paginator = Paginator(books_li, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取分页之后的总页数</span></span><br><span class="line">    num_pages = paginator.num_pages</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 取第page页数据</span></span><br><span class="line">    <span class="keyword">if</span> page == <span class="string">''</span> <span class="keyword">or</span> int(page) &gt; num_pages:</span><br><span class="line">        page = <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        page = int(page)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 返回值是一个Page类的实例对象</span></span><br><span class="line">    books_li = paginator.page(page)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 进行页码控制</span></span><br><span class="line">    <span class="comment"># 1.总页数&lt;5, 显示所有页码</span></span><br><span class="line">    <span class="comment"># 2.当前页是前3页，显示1-5页</span></span><br><span class="line">    <span class="comment"># 3.当前页是后3页，显示后5页 10 9 8 7</span></span><br><span class="line">    <span class="comment"># 4.其他情况，显示当前页前2页，后2页，当前页</span></span><br><span class="line">    <span class="keyword">if</span> num_pages &lt; <span class="number">5</span>:</span><br><span class="line">        pages = range(<span class="number">1</span>, num_pages+<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">elif</span> page &lt;= <span class="number">3</span>:</span><br><span class="line">        pages = range(<span class="number">1</span>, <span class="number">6</span>)</span><br><span class="line">    <span class="keyword">elif</span> num_pages - page &lt;= <span class="number">2</span>:</span><br><span class="line">        pages = range(num_pages<span class="number">-4</span>, num_pages+<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        pages = range(page<span class="number">-2</span>, page+<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 新品推荐</span></span><br><span class="line">    books_new = Books.objects.get_books_by_type(type_id=type_id, limit=<span class="number">2</span>, sort=<span class="string">'new'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 定义上下文</span></span><br><span class="line">    type_title = BOOKS_TYPE[int(type_id)]</span><br><span class="line">    context = &#123;</span><br><span class="line">        <span class="string">'books_li'</span>: books_li,</span><br><span class="line">        <span class="string">'books_new'</span>: books_new,</span><br><span class="line">        <span class="string">'type_id'</span>: type_id,</span><br><span class="line">        <span class="string">'sort'</span>: sort,</span><br><span class="line">        <span class="string">'type_title'</span>: type_title,</span><br><span class="line">        <span class="string">'pages'</span>: pages</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 使用模板</span></span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'books/list.html'</span>, context)</span><br></pre></td></tr></table></figure></p>
<p>然后配置urls.py<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># books/urls.py</span></span><br><span class="line">url(<span class="string">r'^list/(?P&lt;type_id&gt;\d+)/(?P&lt;page&gt;\d+)/$'</span>, views.list, name=<span class="string">'list'</span>), <span class="comment"># 列表页</span></span><br></pre></td></tr></table></figure></p>
<p>将list.html拷贝到templates/books<br>先继承base.html。<br>将index.html首页里面的查看更多，修改url定向。<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% url <span class="string">'books:list'</span> type_id=<span class="number">1</span> page=<span class="number">1</span> %&#125;</span><br></pre></td></tr></table></figure></p>
<p>修改名称。<br><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; type_title &#125;&#125;</span><br></pre></td></tr></table></figure></p>
<p>新品推荐。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;% for book in books_new %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'books:detail' books_id=book.id %&#125;"</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&#123;% static book.image %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h4</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'books:detail' books_id=book.id %&#125;"</span>&gt;</span>&#123;&#123; book.name &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"price"</span>&gt;</span>￥&#123;&#123; book.price &#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure></p>
<p>按不同的特征排序。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/list/&#123;&#123; type_id &#125;&#125;/1/"</span> &#123;% <span class="attr">if</span> <span class="attr">sort</span> == <span class="string">'default'</span> %&#125;<span class="attr">class</span>=<span class="string">"active"</span>&#123;% <span class="attr">endif</span> %&#125;&gt;</span>默认<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/list/&#123;&#123; type_id &#125;&#125;/1/?sort=price"</span> &#123;% <span class="attr">if</span> <span class="attr">sort</span> == <span class="string">'price'</span> %&#125;<span class="attr">class</span>=<span class="string">"active"</span>&#123;% <span class="attr">endif</span> %&#125;&gt;</span>价格<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/list/&#123;&#123; type_id &#125;&#125;/1/?sort=hot"</span> &#123;% <span class="attr">if</span> <span class="attr">sort</span> == <span class="string">'hot'</span> %&#125;<span class="attr">class</span>=<span class="string">"active"</span>&#123;% <span class="attr">endif</span> %&#125;&gt;</span>人气<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>商品列表<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;% for books in books_li %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'books:detail' books_id=books.id %&#125;"</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&#123;% static books.image %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h4</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'books:detail' books_id=books.id %&#125;"</span>&gt;</span>&#123;&#123; books.name &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"operate"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"price"</span>&gt;</span>￥&#123;&#123; books.price &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"unit"</span>&gt;</span>&#123;&#123; books.unit &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span> <span class="attr">class</span>=<span class="string">"add_books"</span> <span class="attr">title</span>=<span class="string">"加入购物车"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure></p>
<p>前端分页功能的实现。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% if books_li.has_previous %&#125;</span><br><span class="line">    &lt;a href="/list/&#123;&#123; type_id &#125;&#125;/&#123;&#123; books_li.previous_page_number &#125;&#125;/?sort=&#123;&#123; sort &#125;&#125;"&gt;&lt;上一页&lt;/a&gt;</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line">&#123;% for pindex in pages %&#125;</span><br><span class="line">    &#123;% if pindex == books_li.number %&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/list/&#123;&#123; type_id &#125;&#125;/&#123;&#123; pindex &#125;&#125;/?sort=&#123;&#123; sort &#125;&#125;"</span> <span class="attr">class</span>=<span class="string">"active"</span>&gt;</span>&#123;&#123; pindex &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    &#123;% else %&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/list/&#123;&#123; type_id &#125;&#125;/&#123;&#123; pindex &#125;&#125;/?sort=&#123;&#123; sort &#125;&#125;"</span>&gt;</span>&#123;&#123; pindex &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line">&#123;% if books_li.has_next %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/list/&#123;&#123; type_id &#125;&#125;/&#123;&#123; books_li.next_page_number &#125;&#125;/?sort=&#123;&#123; sort &#125;&#125;"</span>&gt;</span>下一页&gt;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="4，用户中心的实现"><a href="#4，用户中心的实现" class="headerlink" title="4，用户中心的实现"></a><a id="4">4，用户中心的实现</a></h1><p>接下来我们来实现用户中心的功能，先不实现最近浏览这个功能。首先来看一下这个前端页面，那我们知道我们还得给User这个model添加地址表。<br>那我们先来建model<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># user/models.py</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Address</span><span class="params">(BaseModel)</span>:</span></span><br><span class="line">    <span class="string">'''地址模型类'''</span></span><br><span class="line">    recipient_name = models.CharField(max_length=<span class="number">20</span>, verbose_name=<span class="string">'收件人'</span>)</span><br><span class="line">    recipient_addr = models.CharField(max_length=<span class="number">256</span>, verbose_name=<span class="string">'收件地址'</span>)</span><br><span class="line">    zip_code = models.CharField(max_length=<span class="number">6</span>, verbose_name=<span class="string">'邮政编码'</span>)</span><br><span class="line">    recipient_phone = models.CharField(max_length=<span class="number">11</span>, verbose_name=<span class="string">'联系电话'</span>)</span><br><span class="line">    is_default = models.BooleanField(default=<span class="keyword">False</span>, verbose_name=<span class="string">'是否默认'</span>)</span><br><span class="line">    passport = models.ForeignKey(<span class="string">'Passport'</span>, verbose_name=<span class="string">'账户'</span>)</span><br><span class="line"></span><br><span class="line">    objects = AddressManager()</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        db_table = <span class="string">'s_user_address'</span></span><br></pre></td></tr></table></figure></p>
<p>然后实现AddressManager()，对一些常用函数做抽象。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AddressManager</span><span class="params">(models.Manager)</span>:</span></span><br><span class="line">    <span class="string">'''地址模型管理器类'''</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_default_address</span><span class="params">(self, passport_id)</span>:</span></span><br><span class="line">        <span class="string">'''查询指定用户的默认收货地址'''</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            addr = self.get(passport_id=passport_id, is_default=<span class="keyword">True</span>)</span><br><span class="line">        <span class="keyword">except</span> self.model.DoesNotExist:</span><br><span class="line">            <span class="comment"># 没有默认收货地址</span></span><br><span class="line">            addr = <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">return</span> addr</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_one_address</span><span class="params">(self, passport_id, recipient_name, recipient_addr, zip_code, recipient_phone)</span>:</span></span><br><span class="line">        <span class="string">'''添加收货地址'''</span></span><br><span class="line">        <span class="comment"># 判断用户是否有默认收货地址</span></span><br><span class="line">        addr = self.get_default_address(passport_id=passport_id)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> addr:</span><br><span class="line">            <span class="comment"># 存在默认地址</span></span><br><span class="line">            is_default = <span class="keyword">False</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 不存在默认地址</span></span><br><span class="line">            is_default = <span class="keyword">True</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 添加一个地址</span></span><br><span class="line">        addr = self.create(passport_id=passport_id,</span><br><span class="line">                           recipient_name=recipient_name,</span><br><span class="line">                           recipient_addr=recipient_addr,</span><br><span class="line">                           zip_code=zip_code,</span><br><span class="line">                           recipient_phone=recipient_phone,</span><br><span class="line">                           is_default=is_default)</span><br><span class="line">        <span class="keyword">return</span> addr</span><br></pre></td></tr></table></figure></p>
<p>进行数据库迁移<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ python manage.py makemigrations users</span><br><span class="line">$ python manage.py migrate</span><br></pre></td></tr></table></figure></p>
<p>然后编写视图函数views.py<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">user</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="string">'''用户中心-信息页'''</span></span><br><span class="line">    passport_id = request.session.get(<span class="string">'passport_id'</span>)</span><br><span class="line">    <span class="comment"># 获取用户的基本信息</span></span><br><span class="line">    addr = Address.objects.get_default_address(passport_id=passport_id)</span><br><span class="line"></span><br><span class="line">    books_li = []</span><br><span class="line"></span><br><span class="line">    context = &#123;</span><br><span class="line">        <span class="string">'addr'</span>: addr,</span><br><span class="line">        <span class="string">'page'</span>: <span class="string">'user'</span>,</span><br><span class="line">        <span class="string">'books_li'</span>: books_li</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'users/user_center_info.html'</span>, context)</span><br></pre></td></tr></table></figure></p>
<p>配置urls.py<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url(<span class="string">r'^$'</span>, views.user, name=<span class="string">'user'</span>), <span class="comment"># 用户中心-信息页</span></span><br></pre></td></tr></table></figure></p>
<p>然后将user_center_info.html拷贝到templates/users文件夹下。<br>还是继承base.html，然后对模板进行渲染。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>用户名：<span class="tag">&lt;/<span class="name">span</span>&gt;</span>&#123;&#123; request.session.username &#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">&#123;% if addr %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>联系方式：<span class="tag">&lt;/<span class="name">span</span>&gt;</span>&#123;&#123; addr.recipient_phone &#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>联系地址：<span class="tag">&lt;/<span class="name">span</span>&gt;</span>&#123;&#123; addr.recipient_addr &#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">&#123;% else %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>联系方式：<span class="tag">&lt;/<span class="name">span</span>&gt;</span>无<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>联系地址：<span class="tag">&lt;/<span class="name">span</span>&gt;</span>无<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们这里思考一下，用户中心必须登录以后才可以使用，我们应该怎么实现这个功能呢？<br>在这里，python的装饰器功能就派上用场了。<br>新建一个utils文件夹，用来存放自己编写的一些常用功能函数。<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># utils/decorators.py</span></span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> redirect</span><br><span class="line"><span class="keyword">from</span> django.core.urlresolvers <span class="keyword">import</span> reverse</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login_required</span><span class="params">(view_func)</span>:</span></span><br><span class="line">    <span class="string">'''登录判断装饰器'''</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(request, *view_args, **view_kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> request.session.has_key(<span class="string">'islogin'</span>):</span><br><span class="line">            <span class="comment"># 用户已登录</span></span><br><span class="line">            <span class="keyword">return</span> view_func(request, *view_args, **view_kwargs)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 跳转到登录页面</span></span><br><span class="line">            <span class="keyword">return</span> redirect(reverse(<span class="string">'user:login'</span>))</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br></pre></td></tr></table></figure></p>
<p>然后把这个装饰器打在views.py里的user函数上面。<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@login</span>_required</span><br></pre></td></tr></table></figure></p>
<p>装饰器有很多作用，比如可以限定具有某些权限的用户才能登陆，等等。</p>
<h1 id="5，购物车功能"><a href="#5，购物车功能" class="headerlink" title="5，购物车功能"></a><a id="5">5，购物车功能</a></h1><h2 id="1，创建models"><a href="#1，创建models" class="headerlink" title="1，创建models"></a>1，创建models</h2><p>这里我们要引进redis的使用。大家可以参考《redis实战》这本书，有很多redis的妙用，网上有电子版。<br>我们使用redis实现购物车的功能。因为购物车里的数据相对不是那么重要，而且更新频繁。当然如果要是考虑到安全性，还是要持久化到数据库中比较好。redis在内存中不是很安全，比如之前redis就被攻击过。<br>使用shell命令<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ps</span> -ef | <span class="keyword">grep</span> redis</span><br></pre></td></tr></table></figure></p>
<p>来检查redis server是否启动。<br>我们现在配置文件中配置缓存有关的东西。<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># settings.py</span></span><br><span class="line"><span class="comment"># pip install django-redis</span></span><br><span class="line">CACHES = &#123;</span><br><span class="line">    <span class="string">"default"</span>: &#123;</span><br><span class="line">        <span class="string">"BACKEND"</span>: <span class="string">"django_redis.cache.RedisCache"</span>,</span><br><span class="line">        <span class="string">"LOCATION"</span>: <span class="string">"redis://127.0.0.1:6379/2"</span>,</span><br><span class="line">        <span class="string">"OPTIONS"</span>: &#123;</span><br><span class="line">            <span class="string">"CLIENT_CLASS"</span>: <span class="string">"django_redis.client.DefaultClient"</span>,</span><br><span class="line">            <span class="string">"PASSWORD"</span>: <span class="string">""</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SESSION_ENGINE = <span class="string">"django.contrib.sessions.backends.cache"</span></span><br><span class="line">SESSION_CACHE_ALIAS = <span class="string">"default"</span></span><br></pre></td></tr></table></figure></p>
<p>然后新建一个购物车cart app。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> python manage.py startapp cart</span></span><br></pre></td></tr></table></figure></p>
<p>然后开始编写视图函数。先来编写向购物车中添加商品的功能。<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cart/views.py</span></span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> JsonResponse</span><br><span class="line"><span class="keyword">from</span> books.models <span class="keyword">import</span> Books</span><br><span class="line"><span class="keyword">from</span> utils.decorators <span class="keyword">import</span> login_required</span><br><span class="line"><span class="keyword">from</span> django_redis <span class="keyword">import</span> get_redis_connection</span><br><span class="line"><span class="comment"># Create your views here.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 前端发过来的数据：商品id 商品数目 books_id books_count</span></span><br><span class="line"><span class="comment"># 涉及到数据的修改，使用post方式</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cart_add</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="string">'''向购物车中添加数据'''</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 接收数据</span></span><br><span class="line">    books_id = request.POST.get(<span class="string">'books_id'</span>)</span><br><span class="line">    books_count = request.POST.get(<span class="string">'books_count'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 进行数据校验</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> all([books_id, books_count]):</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'res'</span>:<span class="number">1</span> , <span class="string">'errmsg'</span>:<span class="string">'数据不完整'</span>&#125;)</span><br><span class="line"></span><br><span class="line">    books = Books.objects.get_books_by_id(books_id=books_id)</span><br><span class="line">    <span class="keyword">if</span> books <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">        <span class="comment"># 商品不存在</span></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'res'</span>:<span class="number">2</span>, <span class="string">'errmsg'</span>:<span class="string">'商品不存在'</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        count = int(books_count)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># 商品数目不合法</span></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'res'</span>:<span class="number">3</span>, <span class="string">'errmsg'</span>:<span class="string">'商品数量必须为数字'</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 添加商品到购物车</span></span><br><span class="line">    <span class="comment"># 每个用户的购物车记录用一条hash数据保存，格式:cart_用户id: 商品id 商品数量</span></span><br><span class="line">    conn = get_redis_connection(<span class="string">'default'</span>)</span><br><span class="line">    cart_key = <span class="string">'cart_%d'</span> % request.session.get(<span class="string">'passport_id'</span>)</span><br><span class="line"></span><br><span class="line">    res = conn.hget(cart_key, books_id)</span><br><span class="line">    <span class="keyword">if</span> res <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">        <span class="comment"># 如果用户的购车中没有添加过该商品，则添加数据</span></span><br><span class="line">        res = count</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># 如果用户的购车中已经添加过该商品，则累计商品数目</span></span><br><span class="line">        res = int(res) + count</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 判断商品的库存</span></span><br><span class="line">    <span class="keyword">if</span> res &gt; books.stock:</span><br><span class="line">        <span class="comment"># 库存不足</span></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'res'</span>: <span class="number">4</span>, <span class="string">'errmsg'</span>: <span class="string">'商品库存不足'</span>&#125;)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        conn.hset(cart_key, books_id, res)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 返回结果</span></span><br><span class="line">    <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'res'</span>: <span class="number">5</span>&#125;)</span><br></pre></td></tr></table></figure></p>
<p>将商品添加到购物车的功能就实现了。</p>
<h2 id="2，渲染购物车页面"><a href="#2，渲染购物车页面" class="headerlink" title="2，渲染购物车页面"></a>2，渲染购物车页面</h2><p>在登陆以后，我们应该能够看到购物车里的商品数量，现在我们就来实现这个功能。<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cart/views.py</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cart_count</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="string">'''获取用户购物车中商品的数目'''</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 计算用户购物车商品的数量</span></span><br><span class="line">    conn = get_redis_connection(<span class="string">'default'</span>)</span><br><span class="line">    cart_key = <span class="string">'cart_%d'</span> % request.session.get(<span class="string">'passport_id'</span>)</span><br><span class="line">    <span class="comment"># res = conn.hlen(cart_key) 显示商品的条目数</span></span><br><span class="line">    res = <span class="number">0</span></span><br><span class="line">    res_list = conn.hvals(cart_key)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> res_list:</span><br><span class="line">        res += int(i)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 返回结果</span></span><br><span class="line">    <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'res'</span>: res&#125;)</span><br></pre></td></tr></table></figure></p>
<p>然后在前端页面调用这个接口，并渲染出来。<br>在base.html中添加：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># base.html</span><br><span class="line">    &#123;# 获取用户购物车中商品的数目 #&#125;</span><br><span class="line">    &#123;% block cart_count %&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">            $.get(<span class="string">'/cart/count/'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span></span><br><span class="line"><span class="actionscript">                <span class="comment">// &#123;'res':商品的总数&#125;</span></span></span><br><span class="line"><span class="javascript">                $(<span class="string">'#show_count'</span>).html(data.res)</span></span><br><span class="line"><span class="undefined">            &#125;)</span></span><br><span class="line"><span class="undefined">        </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    &#123;% endblock cart_count %&#125;</span><br></pre></td></tr></table></figure></p>
<p>而在登陆和注册页面，不需要显示这个，所以我们override掉这个块。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% block cart_count %&#125;&#123;% endblock cart_count %&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后配置urls.py<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">url(<span class="string">r'^add/$'</span>, views.cart_add, name=<span class="string">'add'</span>), <span class="comment"># 添加购物车数据</span></span><br><span class="line">url(<span class="string">r'^count/$'</span>, views.cart_count, name=<span class="string">'count'</span>), <span class="comment"># 获取用户购物车中商品的数量</span></span><br></pre></td></tr></table></figure></p>
<p>然后在根目录urls.py中配置url<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url(<span class="string">r'^cart/'</span>, include(<span class="string">'cart.urls'</span>, namespace=<span class="string">'cart'</span>)), <span class="comment"># 购物车模块</span></span><br></pre></td></tr></table></figure></p>
<p>然后在前端详情页<code>detail.html</code>编写添加到购物车的jquery代码。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">    $(<span class="string">'#add_cart'</span>).click(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 获取商品的id和商品数量</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> books_id = $(<span class="keyword">this</span>).attr(<span class="string">'books_id'</span>);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> books_count = $(<span class="string">'.num_show'</span>).val();</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> csrf = $(<span class="string">'input[name="csrfmiddlewaretoken"]'</span>).val();</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 发起请求，访问/cart/add/, 进行购物车数据的添加</span></span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> params = &#123;</span></span><br><span class="line"><span class="actionscript">            <span class="string">'books_id'</span>: books_id,</span></span><br><span class="line"><span class="actionscript">            <span class="string">'books_count'</span>: books_count,</span></span><br><span class="line"><span class="actionscript">            <span class="string">'csrfmiddlewaretoken'</span>: csrf</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">        $.post(<span class="string">'/cart/add/'</span>, params, <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">if</span> (data.res == <span class="number">5</span>)&#123;</span></span><br><span class="line"><span class="actionscript">                <span class="comment">// 添加成功</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">var</span> count = $(<span class="string">'#show_count'</span>).html();</span></span><br><span class="line"><span class="javascript">                <span class="keyword">var</span> count = <span class="built_in">parseInt</span>(count) + <span class="built_in">parseInt</span>(books_count);</span></span><br><span class="line"><span class="javascript">                $(<span class="string">'#show_count'</span>).html(count);</span></span><br><span class="line"><span class="actionscript">            &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="actionscript">                <span class="comment">// 添加失败</span></span></span><br><span class="line"><span class="undefined">                alert(data.errmsg)</span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="undefined">        &#125;)</span></span><br><span class="line"><span class="undefined">    &#125;)</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>发送ajax post请求来更新购物车数量。<br>再改写html tag。<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123; % csrf_token %&#125;</span><br><span class="line">&lt;a <span class="attribute">href</span>=<span class="string">"javascript:;"</span> <span class="attribute">class</span>=<span class="string">"buy_btn"</span>&gt;立即购买&lt;/a&gt;</span><br><span class="line">&lt;a <span class="attribute">href</span>=<span class="string">"javascript:;"</span> <span class="attribute">books_id</span>=<span class="string">"&#123;&#123; books.id &#125;&#125;"</span> <span class="attribute">class</span>=<span class="string">"add_cart"</span> <span class="attribute">id</span>=<span class="string">"add_cart"</span>&gt;加入购物车&lt;/a&gt;</span><br></pre></td></tr></table></figure></p>
<p>现在我们可以将商品添加到购物车中去了。<br>然后我们再编写一段jquery代码，实现+/-商品数量的功能。并且可以自动更新总价格。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">// detail.html</span><br><span class="line">&#123;% block topfiles %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">$(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="undefined">    update_total_price()</span></span><br><span class="line"><span class="actionscript">    <span class="comment">// 计算总价</span></span></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">update_total_price</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 获取商品的价格和数量</span></span></span><br><span class="line"><span class="javascript">        books_price = $(<span class="string">'.show_pirze'</span>).children(<span class="string">'em'</span>).text()</span></span><br><span class="line"><span class="javascript">        books_count = $(<span class="string">'.num_show'</span>).val()</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 计算商品的总价</span></span></span><br><span class="line"><span class="javascript">        books_price = <span class="built_in">parseFloat</span>(books_price)</span></span><br><span class="line"><span class="javascript">        books_count = <span class="built_in">parseInt</span>(books_count)</span></span><br><span class="line"><span class="undefined">        total_price = books_price * books_count</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 设置商品总价</span></span></span><br><span class="line"><span class="javascript">        $(<span class="string">'.total'</span>).children(<span class="string">'em'</span>).text(total_price.toFixed(<span class="number">2</span>) + <span class="string">'元'</span>)</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">    <span class="comment">// 商品增加</span></span></span><br><span class="line"><span class="javascript">    $(<span class="string">'.add'</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 获取商品的数量</span></span></span><br><span class="line"><span class="javascript">        books_count = $(<span class="string">'.num_show'</span>).val()</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 加1</span></span></span><br><span class="line"><span class="javascript">        books_count = <span class="built_in">parseInt</span>(books_count) + <span class="number">1</span></span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 重新设置值</span></span></span><br><span class="line"><span class="javascript">        $(<span class="string">'.num_show'</span>).val(books_count)</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 计算总价</span></span></span><br><span class="line"><span class="undefined">        update_total_price()</span></span><br><span class="line"><span class="undefined">    &#125;)</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">    <span class="comment">// 商品减少</span></span></span><br><span class="line"><span class="javascript">    $(<span class="string">'.minus'</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 获取商品的数量</span></span></span><br><span class="line"><span class="javascript">        books_count = $(<span class="string">'.num_show'</span>).val()</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 加1</span></span></span><br><span class="line"><span class="javascript">        books_count = <span class="built_in">parseInt</span>(books_count) - <span class="number">1</span></span></span><br><span class="line"><span class="actionscript">        <span class="keyword">if</span> (books_count == <span class="number">0</span>)&#123;</span></span><br><span class="line"><span class="undefined">            books_count = 1</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 重新设置值</span></span></span><br><span class="line"><span class="javascript">        $(<span class="string">'.num_show'</span>).val(books_count)</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 计算总价</span></span></span><br><span class="line"><span class="undefined">        update_total_price()</span></span><br><span class="line"><span class="undefined">    &#125;)</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">    <span class="comment">// 手动输入</span></span></span><br><span class="line"><span class="javascript">    $(<span class="string">'.num_show'</span>).blur(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 获取商品的数量</span></span></span><br><span class="line"><span class="javascript">        books_count = $(<span class="keyword">this</span>).val()</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 数据校验</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">if</span> (<span class="built_in">isNaN</span>(books_count) || books_count.trim().length == <span class="number">0</span> || <span class="built_in">parseInt</span>(books_count) &lt;= <span class="number">0</span> )&#123;</span></span><br><span class="line"><span class="undefined">            books_count = 1</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 重新设置值</span></span></span><br><span class="line"><span class="javascript">        $(<span class="string">'.num_show'</span>).val(<span class="built_in">parseInt</span>(books_count))</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 计算总价</span></span></span><br><span class="line"><span class="undefined">        update_total_price()</span></span><br><span class="line"><span class="undefined">    &#125;)</span></span><br><span class="line"><span class="undefined">&#125;)</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">&#123;% endblock topfiles %&#125;</span><br></pre></td></tr></table></figure></p>
<p>好，添加商品到购物车的功能我们就实现好了。</p>
<h2 id="3，购物车页面的开发"><a href="#3，购物车页面的开发" class="headerlink" title="3，购物车页面的开发"></a>3，购物车页面的开发</h2><p>接下来我们来实现展示购物车页面的功能。<br>编写views.py。<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cart/views.py</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cart_show</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="string">'''显示用户购物车页面'''</span></span><br><span class="line">    passport_id = request.session.get(<span class="string">'passport_id'</span>)</span><br><span class="line">    <span class="comment"># 获取用户购物车的记录</span></span><br><span class="line">    conn = get_redis_connection(<span class="string">'default'</span>)</span><br><span class="line">    cart_key = <span class="string">'cart_%d'</span> % passport_id</span><br><span class="line">    res_dict = conn.hgetall(cart_key)</span><br><span class="line"></span><br><span class="line">    books_li = []</span><br><span class="line">    <span class="comment"># 保存所有商品的总数</span></span><br><span class="line">    total_count = <span class="number">0</span></span><br><span class="line">    <span class="comment"># 保存所有商品的总价格</span></span><br><span class="line">    total_price = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 遍历res_dict获取商品的数据</span></span><br><span class="line">    <span class="keyword">for</span> id, count <span class="keyword">in</span> res_dict.items():</span><br><span class="line">        <span class="comment"># 根据id获取商品的信息</span></span><br><span class="line">        books = Books.objects.get_books_by_id(books_id=id)</span><br><span class="line">        <span class="comment"># 保存商品的数目</span></span><br><span class="line">        books.count = count</span><br><span class="line">        <span class="comment"># 保存商品的小计</span></span><br><span class="line">        books.amount = int(count) * books.price</span><br><span class="line">        <span class="comment"># books_li.append((books, count))</span></span><br><span class="line">        books_li.append(books)</span><br><span class="line"></span><br><span class="line">        total_count += int(count)</span><br><span class="line">        total_price += int(count) * books.price</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 定义模板上下文</span></span><br><span class="line">    context = &#123;</span><br><span class="line">        <span class="string">'books_li'</span>: books_li,</span><br><span class="line">        <span class="string">'total_count'</span>: total_count,</span><br><span class="line">        <span class="string">'total_price'</span>: total_price,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'cart/cart.html'</span>, context)</span><br></pre></td></tr></table></figure></p>
<p>然后配置urls.py<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url(<span class="string">r'^$'</span>, views.cart_show, name=<span class="string">'show'</span>), <span class="comment"># 显示用户的购物车页面</span></span><br></pre></td></tr></table></figure></p>
<p>然后将cart.html拷贝到templates/cart文件夹下面。<br>还是继承base.html。然后在base.html中改写url定向。<br><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">url</span></span> 'cart:show' %&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure></p>
<p>接下来，我们把订单列表渲染出来。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;% for book in books_li %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"cart_list_td clearfix"</span>&gt;</span></span><br><span class="line">    &#123;# 提交表单时，如果checkbox没有被选中，它的值不会被提交 #&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col01"</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">name</span>=<span class="string">"books_ids"</span> <span class="attr">value</span>=<span class="string">"&#123;&#123; book.id &#125;&#125;"</span> <span class="attr">checked</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col02"</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&#123;% static book.image %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col03"</span>&gt;</span>&#123;&#123; book.name &#125;&#125;<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">em</span>&gt;</span>&#123;&#123; book.price &#125;&#125;元/&#123;&#123; book.unit &#125;&#125;<span class="tag">&lt;/<span class="name">em</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col04"</span>&gt;</span>&#123;&#123; book.unit &#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col05"</span>&gt;</span>&#123;&#123; book.price &#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col06"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"num_add"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:;"</span> <span class="attr">class</span>=<span class="string">"add fl"</span>&gt;</span>+<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">books_id</span>=<span class="string">"&#123;&#123; book.id &#125;&#125;"</span> <span class="attr">class</span>=<span class="string">"num_show fl"</span> <span class="attr">value</span>=<span class="string">"&#123;&#123; book.count &#125;&#125;"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:;"</span> <span class="attr">class</span>=<span class="string">"minus fl"</span>&gt;</span>-<span class="tag">&lt;/<span class="name">a</span>&gt;</span>   </span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col07"</span>&gt;</span>&#123;&#123; book.amount &#125;&#125;元<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col08"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:;"</span>&gt;</span>删除<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="4，购物车中删除商品的功能"><a href="#4，购物车中删除商品的功能" class="headerlink" title="4，购物车中删除商品的功能"></a>4，购物车中删除商品的功能</h2><p>先来编写views.py函数。<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cart/views.py</span></span><br><span class="line"><span class="comment"># 前端传过来的参数:商品id books_id</span></span><br><span class="line"><span class="comment"># post</span></span><br><span class="line"><span class="comment"># /cart/del/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cart_del</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="string">'''删除用户购物车中商品的信息'''</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 接收数据</span></span><br><span class="line">    books_id = request.POST.get(<span class="string">'books_id'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 校验商品是否存放</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> all([books_id]):</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'res'</span>: <span class="number">1</span>, <span class="string">'errmsg'</span>: <span class="string">'数据不完整'</span>&#125;)</span><br><span class="line"></span><br><span class="line">    books = Books.objects.get_books_by_id(books_id=books_id)</span><br><span class="line">    <span class="keyword">if</span> books <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'res'</span>: <span class="number">2</span>, <span class="string">'errmsg'</span>: <span class="string">'商品不存在'</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 删除购物车商品信息</span></span><br><span class="line">    conn = get_redis_connection(<span class="string">'default'</span>)</span><br><span class="line">    cart_key = <span class="string">'cart_%d'</span> % request.session.get(<span class="string">'passport_id'</span>)</span><br><span class="line">    conn.hdel(cart_key, books_id)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 返回信息</span></span><br><span class="line">    <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'res'</span>: <span class="number">3</span>&#125;)</span><br></pre></td></tr></table></figure></p>
<p>配置urls.py<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url(<span class="string">r'^del/$'</span>, views.cart_del, name=<span class="string">'delete'</span>), <span class="comment"># 购物车商品记录删除</span></span><br></pre></td></tr></table></figure></p>
<p>然后在购物车页面cart.html编写jquery代码来调用del接口。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">&#123;% block topfiles %&#125;</span><br><span class="line">    &lt;script&gt;</span><br><span class="line">    $(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        update_cart_count()</span><br><span class="line">        <span class="comment">// 计算所有被选中商品的总价，总数目和商品的小计</span></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">update_total_price</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            total_count = <span class="number">0</span></span><br><span class="line">            total_price = <span class="number">0</span></span><br><span class="line">            <span class="comment">// 获取所有被选中的商品所在的ul元素</span></span><br><span class="line">            $(<span class="string">'.cart_list_td'</span>).find(<span class="string">':checked'</span>).parents(<span class="string">'ul'</span>).each(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="comment">// 计算商品的小计</span></span><br><span class="line">                res_dict = update_books_price($(<span class="keyword">this</span>))</span><br><span class="line"></span><br><span class="line">                total_count += res_dict.books_count</span><br><span class="line">                total_price += res_dict.books_amount</span><br><span class="line">            &#125;)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 设置商品的总价和总数目</span></span><br><span class="line">            $(<span class="string">'.settlements'</span>).find(<span class="string">'em'</span>).text(total_price.toFixed(<span class="number">2</span>))</span><br><span class="line">            $(<span class="string">'.settlements'</span>).find(<span class="string">'b'</span>).text(total_count)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 计算商品的小计</span></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">update_books_price</span>(<span class="params">books_ul</span>) </span>&#123;</span><br><span class="line">            <span class="comment">// 获取每一个商品的价格和数量</span></span><br><span class="line">                books_price = books_ul.children(<span class="string">'.col05'</span>).text()</span><br><span class="line">                books_count = books_ul.find(<span class="string">'.num_show'</span>).val()</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 计算商品的小计</span></span><br><span class="line">                books_price = <span class="built_in">parseFloat</span>(books_price)</span><br><span class="line">                books_count = <span class="built_in">parseInt</span>(books_count)</span><br><span class="line">                books_amount = books_price * books_count</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 设置商品的小计</span></span><br><span class="line">                books_ul.children(<span class="string">'.col07'</span>).text(books_amount.toFixed(<span class="number">2</span>) + <span class="string">'元'</span>)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> &#123;</span><br><span class="line">                    <span class="string">'books_count'</span>: books_count,</span><br><span class="line">                    <span class="string">'books_amount'</span>: books_amount</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 更新页面上购物车商品的总数</span></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">update_cart_count</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            #  更新列表上方商品总数</span><br><span class="line">            $.get(<span class="string">'/cart/count/'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">                $(<span class="string">'.total_count'</span>).children(<span class="string">'em'</span>).text(data.res)</span><br><span class="line">            #  更新页面右上方购物车商品总数</span><br><span class="line">            $.get(<span class="string">'/cart/count/'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">                $(<span class="string">'#show_count'</span>).html(data.res)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 购物车商品信息的删除</span></span><br><span class="line">        $(<span class="string">'.cart_list_td'</span>).children(<span class="string">'.col08'</span>).children(<span class="string">'a'</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="comment">// 获取删除的商品的id</span></span><br><span class="line">            books_ul = $(<span class="keyword">this</span>).parents(<span class="string">'ul'</span>)</span><br><span class="line">            books_id = books_ul.find(<span class="string">'.num_show'</span>).attr(<span class="string">'books_id'</span>)</span><br><span class="line">            csrf = $(<span class="string">'input[name="csrfmiddlewaretoken"]'</span>).val()</span><br><span class="line">            params = &#123;</span><br><span class="line">                <span class="string">"books_id"</span>: books_id,</span><br><span class="line">                <span class="string">"csrfmiddlewaretoken"</span>: csrf</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 发起ajax请求，访问/cart/del/</span></span><br><span class="line">            $.post(<span class="string">'/cart/del/'</span>, params, <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (data.res == <span class="number">3</span>)&#123;</span><br><span class="line">                    <span class="comment">// 删除成功</span></span><br><span class="line">                    <span class="comment">// 移除商品对应的ul元素</span></span><br><span class="line">                    books_ul.remove() <span class="comment">// books.empty()</span></span><br><span class="line">                    <span class="comment">// 判断商品对应的checkbox是否选中</span></span><br><span class="line">                    is_checked = books_ul.find(<span class="string">':checkbox'</span>).prop(<span class="string">'checked'</span>)</span><br><span class="line">                    <span class="keyword">if</span> (is_checked)&#123;</span><br><span class="line">                        update_total_price()</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 更新页面购物车商品总数</span></span><br><span class="line">                    update_cart_count()</span><br><span class="line">                    <span class="comment">// 更新选择框状态</span></span><br><span class="line">                    $(<span class="string">'.settlements'</span>).find(<span class="string">":checkbox"</span>).prop(<span class="string">'checked'</span>, <span class="literal">false</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    &lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp">&#123;% endblock topfiles %&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>为避免403，我们添加一行{ % csrf_token %}</p>
<h2 id="5，实现购物车页面编辑商品数量的功能。"><a href="#5，实现购物车页面编辑商品数量的功能。" class="headerlink" title="5，实现购物车页面编辑商品数量的功能。"></a>5，实现购物车页面编辑商品数量的功能。</h2><p>我们先来编写更新购物车的接口。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cart/views.py</span></span><br><span class="line"><span class="comment"># 前端传过来的参数:商品id books_id 更新数目 books_count</span></span><br><span class="line"><span class="comment"># post</span></span><br><span class="line"><span class="comment"># /cart/update/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cart_update</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="string">'''更新购物车商品数目'''</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 接收数据</span></span><br><span class="line">    books_id = request.POST.get(<span class="string">'books_id'</span>)</span><br><span class="line">    books_count = request.POST.get(<span class="string">'books_count'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 数据的校验</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> all([books_id, books_count]):</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'res'</span>: <span class="number">1</span>, <span class="string">'errmsg'</span>: <span class="string">'数据不完整'</span>&#125;)</span><br><span class="line"></span><br><span class="line">    books = Books.objects.get_books_by_id(books_id=books_id)</span><br><span class="line">    <span class="keyword">if</span> books <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'res'</span>: <span class="number">2</span>, <span class="string">'errmsg'</span>: <span class="string">'商品不存在'</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        books_count = int(books_count)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'res'</span>: <span class="number">3</span>, <span class="string">'errmsg'</span>: <span class="string">'商品数目必须为数字'</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 更新操作</span></span><br><span class="line">    conn = get_redis_connection(<span class="string">'default'</span>)</span><br><span class="line">    cart_key = <span class="string">'cart_%d'</span> % request.session.get(<span class="string">'passport_id'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 判断商品库存</span></span><br><span class="line">    <span class="keyword">if</span> books_count &gt; books.stock:</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'res'</span>: <span class="number">4</span>, <span class="string">'errmsg'</span>: <span class="string">'商品库存不足'</span>&#125;)</span><br><span class="line"></span><br><span class="line">    conn.hset(cart_key, books_id, books_count)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'res'</span>: <span class="number">5</span>&#125;)</span><br></pre></td></tr></table></figure></p>
<p>注意别忘了配置cart app的urls.py。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url(<span class="string">r'^update/$'</span>, views.cart_update, name=<span class="string">"update"</span>)</span><br></pre></td></tr></table></figure></p>
<p>然后编写jquery代码来实现前端更新数量以及全选这样的功能。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 全选和全不选</span></span><br><span class="line">$(<span class="string">'.settlements'</span>).find(<span class="string">':checkbox'</span>).change(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 获取全选checkbox的选中状态</span></span><br><span class="line">    is_checked = $(<span class="keyword">this</span>).prop(<span class="string">'checked'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 遍历所有商品对应的checkbox,设置checked属性和全选checkbox一致</span></span><br><span class="line">    $(<span class="string">'.cart_list_td'</span>).find(<span class="string">':checkbox'</span>).each(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        $(<span class="keyword">this</span>).prop(<span class="string">'checked'</span>, is_checked)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新商品的信息</span></span><br><span class="line">    update_total_price()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 商品对应的checkbox状态发生改变时，全选checkbox的改变</span></span><br><span class="line">$(<span class="string">'.cart_list_td'</span>).find(<span class="string">':checkbox'</span>).change(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 获取所有商品对应的checkbox的数目</span></span><br><span class="line">    all_len = $(<span class="string">'.cart_list_td'</span>).find(<span class="string">':checkbox'</span>).length</span><br><span class="line">    <span class="comment">// 获取所有被选中商品的checkbox的数目</span></span><br><span class="line">    checked_len  = $(<span class="string">'.cart_list_td'</span>).find(<span class="string">':checked'</span>).length</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (checked_len &lt; all_len)&#123;</span><br><span class="line">        $(<span class="string">'.settlements'</span>).find(<span class="string">':checkbox'</span>).prop(<span class="string">'checked'</span>, <span class="literal">false</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">         $(<span class="string">'.settlements'</span>).find(<span class="string">':checkbox'</span>).prop(<span class="string">'checked'</span>, <span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新商品的信息</span></span><br><span class="line">    update_total_price()</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 购物车商品数目的增加</span></span><br><span class="line">$(<span class="string">'.add'</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 获取商品的数目和商品的id</span></span><br><span class="line">    books_count = $(<span class="keyword">this</span>).next().val()</span><br><span class="line">    books_id = $(<span class="keyword">this</span>).next().attr(<span class="string">'books_id'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新购物车信息</span></span><br><span class="line">    books_count = <span class="built_in">parseInt</span>(books_count) + <span class="number">1</span></span><br><span class="line">    update_remote_cart_info(books_id, books_count)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据更新的结果进行操作</span></span><br><span class="line">    <span class="keyword">if</span> (error_update == <span class="literal">false</span>)&#123;</span><br><span class="line">        <span class="comment">// 更新成功</span></span><br><span class="line">        $(<span class="keyword">this</span>).next().val(books_count)</span><br><span class="line">        <span class="comment">// 获取商品对应的checkbox的选中状态</span></span><br><span class="line">        is_checked = $(<span class="keyword">this</span>).parents(<span class="string">'ul'</span>).find(<span class="string">':checkbox'</span>).prop(<span class="string">'checked'</span>)</span><br><span class="line">        <span class="keyword">if</span> (is_checked)&#123;</span><br><span class="line">            <span class="comment">// 更新商品的总数目，总价格和小计</span></span><br><span class="line">            update_total_price()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">// 更新商品的小计</span></span><br><span class="line">            update_books_price($(<span class="keyword">this</span>).parents(<span class="string">'ul'</span>))</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 更新页面购物车商品总数</span></span><br><span class="line">        update_cart_count()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 购物车商品数目的减少</span></span><br><span class="line">$(<span class="string">'.minus'</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 获取商品的数目和商品的id</span></span><br><span class="line">    books_count = $(<span class="keyword">this</span>).prev().val()</span><br><span class="line">    books_id = $(<span class="keyword">this</span>).prev().attr(<span class="string">'books_id'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新购物车信息</span></span><br><span class="line">    books_count = <span class="built_in">parseInt</span>(books_count) - <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> (books_count &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">        books_count = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    update_remote_cart_info(books_id, books_count)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据更新的结果进行操作</span></span><br><span class="line">    <span class="keyword">if</span> (error_update == <span class="literal">false</span>)&#123;</span><br><span class="line">        <span class="comment">// 更新成功</span></span><br><span class="line">        $(<span class="keyword">this</span>).prev().val(books_count)</span><br><span class="line">        <span class="comment">// 获取商品对应的checkbox的选中状态</span></span><br><span class="line">        is_checked = $(<span class="keyword">this</span>).parents(<span class="string">'ul'</span>).find(<span class="string">':checkbox'</span>).prop(<span class="string">'checked'</span>)</span><br><span class="line">        <span class="keyword">if</span> (is_checked)&#123;</span><br><span class="line">            <span class="comment">// 更新商品的总数目，总价格和小计</span></span><br><span class="line">            update_total_price()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">// 更新商品的小计</span></span><br><span class="line">            update_books_price($(<span class="keyword">this</span>).parents(<span class="string">'ul'</span>))</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 更新页面购物车商品总数</span></span><br><span class="line">        update_cart_count()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">pre_books_count = <span class="number">0</span></span><br><span class="line">$(<span class="string">'.num_show'</span>).focus(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    pre_books_count = $(<span class="keyword">this</span>).val()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 购物车商品数目的手动输入</span></span><br><span class="line">$(<span class="string">'.num_show'</span>).blur(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 获取商品的数目和商品的id</span></span><br><span class="line">    books_count = $(<span class="keyword">this</span>).val()</span><br><span class="line">    books_id = $(<span class="keyword">this</span>).attr(<span class="string">'books_id'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 校验用户输入的商品数目</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">isNaN</span>(books_count) || books_count.trim().length == <span class="number">0</span> || <span class="built_in">parseInt</span>(books_count)&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="comment">// 设置回输入之前的值</span></span><br><span class="line">        $(<span class="keyword">this</span>).val(pre_books_count)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新购物车信息</span></span><br><span class="line">    books_count = <span class="built_in">parseInt</span>(books_count)</span><br><span class="line"></span><br><span class="line">    update_remote_cart_info(books_id, books_count)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据更新的结果进行操作</span></span><br><span class="line">    <span class="keyword">if</span> (error_update == <span class="literal">false</span>)&#123;</span><br><span class="line">        <span class="comment">// 更新成功</span></span><br><span class="line">        $(<span class="keyword">this</span>).val(books_count)</span><br><span class="line">        <span class="comment">// 获取商品对应的checkbox的选中状态</span></span><br><span class="line">        is_checked = $(<span class="keyword">this</span>).parents(<span class="string">'ul'</span>).find(<span class="string">':checkbox'</span>).prop(<span class="string">'checked'</span>)</span><br><span class="line">        <span class="keyword">if</span> (is_checked)&#123;</span><br><span class="line">            <span class="comment">// 更新商品的总数目，总价格和小计</span></span><br><span class="line">            update_total_price()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">// 更新商品的小计</span></span><br><span class="line">            update_books_price($(<span class="keyword">this</span>).parents(<span class="string">'ul'</span>))</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 更新页面购物车商品总数</span></span><br><span class="line">        update_cart_count()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">// 设置回输入之前的值</span></span><br><span class="line">        $(<span class="keyword">this</span>).val(pre_books_count)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>这里要注意看看jquery是怎么发送ajax post请求的。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 更新redis中购物车商品数目</span></span><br><span class="line">error_update = <span class="literal">false</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">update_remote_cart_info</span>(<span class="params">books_id, books_count</span>) </span>&#123;</span><br><span class="line">    csrf = $(<span class="string">'input[name="csrfmiddlewaretoken"]'</span>).val()</span><br><span class="line">    params = &#123;</span><br><span class="line">        <span class="string">'books_id'</span>: books_id,</span><br><span class="line">        <span class="string">'books_count'</span>: books_count,</span><br><span class="line">        <span class="string">'csrfmiddlewaretoken'</span>: csrf</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置同步</span></span><br><span class="line">    $.ajaxSettings.async = <span class="literal">false</span></span><br><span class="line">    <span class="comment">// 发起请求，访问/cart/update/</span></span><br><span class="line">    $.post(<span class="string">'/cart/update/'</span>, params, <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (data.res == <span class="number">5</span>)&#123;</span><br><span class="line">            <span class="comment">// alert('更新成功')</span></span><br><span class="line">            error_update = <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            error_update = <span class="literal">true</span></span><br><span class="line">            alert(data.errmsg)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// 设置异步</span></span><br><span class="line">    $.ajaxSettings.async = <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里设置了同步，因为我们需要马上更新购物车数据，即使阻塞了其他操作也在所不惜。<br>好，购物车页面基本就开发完了。</p>
<h1 id="6，订单页面的开发"><a href="#6，订单页面的开发" class="headerlink" title="6，订单页面的开发"></a><a id="6">6，订单页面的开发</a></h1><h2 id="1，创建models-1"><a href="#1，创建models-1" class="headerlink" title="1，创建models"></a>1，创建models</h2><p>先来设计数据库表结构，记住表结构的设计是最重要的，因为一般情况下设计好表结构，就不再变更了。<br>我们先安装order app。<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python manage<span class="selector-class">.py</span> startapp <span class="attribute">order</span></span><br></pre></td></tr></table></figure></p>
<p>然后订单信息model的设计如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> db.base_model <span class="keyword">import</span> BaseModel</span><br><span class="line"><span class="comment"># Create your models here.</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderInfo</span><span class="params">(BaseModel)</span>:</span></span><br><span class="line">    <span class="string">'''订单信息模型类'''</span></span><br><span class="line"></span><br><span class="line">    PAY_METHOD_CHOICES = (</span><br><span class="line">        (<span class="number">1</span>, <span class="string">"货到付款"</span>),</span><br><span class="line">        (<span class="number">2</span>, <span class="string">"微信支付"</span>),</span><br><span class="line">        (<span class="number">3</span>, <span class="string">"支付宝"</span>),</span><br><span class="line">        (<span class="number">4</span>, <span class="string">"银联支付"</span>)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    PAY_METHODS_ENUM = &#123;</span><br><span class="line">        <span class="string">"CASH"</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">"WEIXIN"</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="string">"ALIPAY"</span>: <span class="number">3</span>,</span><br><span class="line">        <span class="string">"UNIONPAY"</span>: <span class="number">4</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ORDER_STATUS_CHOICES = (</span><br><span class="line">        (<span class="number">1</span>, <span class="string">"待支付"</span>),</span><br><span class="line">        (<span class="number">2</span>, <span class="string">"待发货"</span>),</span><br><span class="line">        (<span class="number">3</span>, <span class="string">"待收货"</span>),</span><br><span class="line">        (<span class="number">4</span>, <span class="string">"待评价"</span>),</span><br><span class="line">        (<span class="number">5</span>, <span class="string">"已完成"</span>),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    order_id = models.CharField(max_length=<span class="number">64</span>, primary_key=<span class="keyword">True</span>, verbose_name=<span class="string">'订单编号'</span>)</span><br><span class="line">    passport = models.ForeignKey(<span class="string">'users.Passport'</span>, verbose_name=<span class="string">'下单账户'</span>)</span><br><span class="line">    addr = models.ForeignKey(<span class="string">'users.Address'</span>, verbose_name=<span class="string">'收货地址'</span>)</span><br><span class="line">    total_count = models.IntegerField(default=<span class="number">1</span>, verbose_name=<span class="string">'商品总数'</span>)</span><br><span class="line">    total_price = models.DecimalField(max_digits=<span class="number">10</span>, decimal_places=<span class="number">2</span>, verbose_name=<span class="string">'商品总价'</span>)</span><br><span class="line">    transit_price = models.DecimalField(max_digits=<span class="number">10</span>, decimal_places=<span class="number">2</span>, verbose_name=<span class="string">'订单运费'</span>)</span><br><span class="line">    pay_method = models.SmallIntegerField(choices=PAY_METHOD_CHOICES, default=<span class="number">1</span>, verbose_name=<span class="string">'支付方式'</span>)</span><br><span class="line">    status = models.SmallIntegerField(choices=ORDER_STATUS_CHOICES, default=<span class="number">1</span>, verbose_name=<span class="string">'订单状态'</span>)</span><br><span class="line">    trade_id = models.CharField(max_length=<span class="number">100</span>, unique=<span class="keyword">True</span>, null=<span class="keyword">True</span>, blank=<span class="keyword">True</span>, verbose_name=<span class="string">'支付编号'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        db_table = <span class="string">'s_order_info'</span></span><br></pre></td></tr></table></figure>
<p>由于每一笔订单都是由不同的商品组成，所以我们需要把一笔订单拆分开，来建立一个订单中每种商品的信息数据表。关系数据库的一个好处就是强约束，冗余也很少，这点比mongodb好。<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderGoods</span><span class="params">(BaseModel)</span>:</span></span><br><span class="line">    <span class="string">'''订单商品模型类'''</span></span><br><span class="line">    order = models.ForeignKey(<span class="string">'OrderInfo'</span>, verbose_name=<span class="string">'所属订单'</span>)</span><br><span class="line">    books = models.ForeignKey(<span class="string">'books.Books'</span>, verbose_name=<span class="string">'订单商品'</span>)</span><br><span class="line">    count = models.IntegerField(default=<span class="number">1</span>, verbose_name=<span class="string">'商品数量'</span>)</span><br><span class="line">    price = models.DecimalField(max_digits=<span class="number">10</span>, decimal_places=<span class="number">2</span>, verbose_name=<span class="string">'商品价格'</span>)</span><br><span class="line">    <span class="comment"># comment = models.CharField(max_length=128, null=True, blank=True, verbose_name='商品评论')</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        db_table = <span class="string">'s_order_books'</span></span><br></pre></td></tr></table></figure></p>
<p>接下来我们来做数据库迁移。别忘了在settings.py中添加order app。<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ python manage<span class="selector-class">.py</span> makemigrations <span class="attribute">order</span></span><br><span class="line">$ python manage<span class="selector-class">.py</span> migrate</span><br></pre></td></tr></table></figure></p>
<h2 id="2，开发有关订单的接口。"><a href="#2，开发有关订单的接口。" class="headerlink" title="2，开发有关订单的接口。"></a>2，开发有关订单的接口。</h2><p>我们先把订单显示页面来渲染出来。<br>先来开发后台接口。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render,redirect</span><br><span class="line"><span class="keyword">from</span> django.core.urlresolvers <span class="keyword">import</span> reverse</span><br><span class="line"><span class="keyword">from</span> utils.decorators <span class="keyword">import</span> login_required</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse,JsonResponse</span><br><span class="line"><span class="keyword">from</span> users.models <span class="keyword">import</span> Address</span><br><span class="line"><span class="keyword">from</span> books.models <span class="keyword">import</span> Books</span><br><span class="line"><span class="keyword">from</span> order.models <span class="keyword">import</span> OrderInfo, OrderGoods</span><br><span class="line"><span class="keyword">from</span> django_redis <span class="keyword">import</span> get_redis_connection</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="comment"># Create your views here.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">order_place</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="string">'''显示提交订单页面'''</span></span><br><span class="line">    <span class="comment"># 接收数据</span></span><br><span class="line">    books_ids = request.POST.getlist(<span class="string">'books_ids'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 校验数据</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> all(books_ids):</span><br><span class="line">        <span class="comment"># 跳转会购物车页面</span></span><br><span class="line">        <span class="keyword">return</span> redirect(reverse(<span class="string">'cart:show'</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 用户收货地址</span></span><br><span class="line">    passport_id = request.session.get(<span class="string">'passport_id'</span>)</span><br><span class="line">    addr = Address.objects.get_default_address(passport_id=passport_id)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 用户要购买商品的信息</span></span><br><span class="line">    books_li = []</span><br><span class="line">    <span class="comment"># 商品的总数目和总金额</span></span><br><span class="line">    total_count = <span class="number">0</span></span><br><span class="line">    total_price = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    conn = get_redis_connection(<span class="string">'default'</span>)</span><br><span class="line">    cart_key = <span class="string">'cart_%d'</span> % passport_id</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> id <span class="keyword">in</span> books_ids:</span><br><span class="line">        <span class="comment"># 根据id获取商品的信息</span></span><br><span class="line">        books = Books.objects.get_books_by_id(books_id=id)</span><br><span class="line">        <span class="comment"># 从redis中获取用户要购买的商品的数目</span></span><br><span class="line">        count = conn.hget(cart_key, id)</span><br><span class="line">        books.count = count</span><br><span class="line">        <span class="comment"># 计算商品的小计</span></span><br><span class="line">        amount = int(count) * books.price</span><br><span class="line">        books.amount = amount</span><br><span class="line">        books_li.append(books)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 累计计算商品的总数目和总金额</span></span><br><span class="line">        total_count += int(count)</span><br><span class="line">        total_price += books.amount</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 商品运费和实付款</span></span><br><span class="line">    transit_price = <span class="number">10</span></span><br><span class="line">    total_pay = total_price + transit_price</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1,2,3</span></span><br><span class="line">    books_ids = <span class="string">','</span>.join(books_ids)</span><br><span class="line">    <span class="comment"># 组织模板上下文</span></span><br><span class="line">    context = &#123;</span><br><span class="line">        <span class="string">'addr'</span>: addr,</span><br><span class="line">        <span class="string">'books_li'</span>: books_li,</span><br><span class="line">        <span class="string">'total_count'</span>: total_count,</span><br><span class="line">        <span class="string">'total_price'</span>: total_price,</span><br><span class="line">        <span class="string">'transit_price'</span>: transit_price,</span><br><span class="line">        <span class="string">'total_pay'</span>: total_pay,</span><br><span class="line">        <span class="string">'books_ids'</span>: books_ids,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 使用模板</span></span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'order/place_order.html'</span>, context)</span><br></pre></td></tr></table></figure></p>
<p>然后配置urls.py。<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># urls.py</span></span><br><span class="line">    url(<span class="string">r'^order/'</span>, include(<span class="string">'order.urls'</span>, namespace=<span class="string">'order'</span>)), <span class="comment"># 订单模块</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># order/urls.py</span></span><br><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url</span><br><span class="line"><span class="keyword">from</span> order <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r'^place/$'</span>, views.order_place, name=<span class="string">'place'</span>), <span class="comment"># 订单提交页面</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>然后将place_order.html拷贝到templates/order文件夹下。并用继承base.html的方式来改写。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends 'base.html' %&#125;</span><br><span class="line">&#123;% load staticfiles %&#125;</span><br><span class="line">&#123;% block title %&#125;尚硅谷书店-首页&#123;% endblock title %&#125;</span><br><span class="line">&#123;% block topfiles %&#125;</span><br><span class="line">&#123;% endblock topfiles %&#125;</span><br><span class="line">&#123;% block body %&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">h3</span> <span class="attr">class</span>=<span class="string">"common_title"</span>&gt;</span>确认收货地址<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"common_list_con clearfix"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dl</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dt</span>&gt;</span>寄送到：<span class="tag">&lt;/<span class="name">dt</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dd</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"radio"</span> <span class="attr">name</span>=<span class="string">""</span> <span class="attr">checked</span>=<span class="string">""</span>&gt;</span>北京市 海淀区 东北旺西路8号中关村软件园 （李思 收） 182****7528<span class="tag">&lt;/<span class="name">dd</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dl</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"user_center_site.html"</span> <span class="attr">class</span>=<span class="string">"edit_site"</span>&gt;</span>编辑收货地址<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">h3</span> <span class="attr">class</span>=<span class="string">"common_title"</span>&gt;</span>支付方式<span class="tag">&lt;/<span class="name">h3</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"common_list_con clearfix"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"pay_style_con clearfix"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"radio"</span> <span class="attr">name</span>=<span class="string">"pay_style"</span> <span class="attr">checked</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">"cash"</span>&gt;</span>货到付款<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"radio"</span> <span class="attr">name</span>=<span class="string">"pay_style"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">"weixin"</span>&gt;</span>微信支付<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"radio"</span> <span class="attr">name</span>=<span class="string">"pay_style"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">"zhifubao"</span>&gt;</span><span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"radio"</span> <span class="attr">name</span>=<span class="string">"pay_style"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">"bank"</span>&gt;</span>银行卡支付<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">h3</span> <span class="attr">class</span>=<span class="string">"common_title"</span>&gt;</span>商品列表<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"common_list_con clearfix"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"book_list_th clearfix"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col01"</span>&gt;</span>商品名称<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col02"</span>&gt;</span>商品单位<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col03"</span>&gt;</span>商品价格<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col04"</span>&gt;</span>数量<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col05"</span>&gt;</span>小计<span class="tag">&lt;/<span class="name">li</span>&gt;</span>       </span><br><span class="line">        <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"book_list_td clearfix"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col01"</span>&gt;</span>1<span class="tag">&lt;/<span class="name">li</span>&gt;</span>            </span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col02"</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"images/book/book012.jpg"</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col03"</span>&gt;</span>计算机程序设计艺术<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col04"</span>&gt;</span>册<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col05"</span>&gt;</span>25.80元<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col06"</span>&gt;</span>1<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col07"</span>&gt;</span>25.80元<span class="tag">&lt;/<span class="name">li</span>&gt;</span>   </span><br><span class="line">        <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"book_list_td clearfix"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col01"</span>&gt;</span>2<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col02"</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"images/book/book003.jpg"</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col03"</span>&gt;</span>Python Cookbook<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col04"</span>&gt;</span>册<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col05"</span>&gt;</span>16.80元<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col06"</span>&gt;</span>1<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col07"</span>&gt;</span>16.80元<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">h3</span> <span class="attr">class</span>=<span class="string">"common_title"</span>&gt;</span>总金额结算<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"common_list_con clearfix"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"settle_con"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"total_book_count"</span>&gt;</span>共<span class="tag">&lt;<span class="name">em</span>&gt;</span>2<span class="tag">&lt;/<span class="name">em</span>&gt;</span>件商品，总金额<span class="tag">&lt;<span class="name">b</span>&gt;</span>42.60元<span class="tag">&lt;/<span class="name">b</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"transit"</span>&gt;</span>运费：<span class="tag">&lt;<span class="name">b</span>&gt;</span>10元<span class="tag">&lt;/<span class="name">b</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"total_pay"</span>&gt;</span>实付款：<span class="tag">&lt;<span class="name">b</span>&gt;</span>52.60元<span class="tag">&lt;/<span class="name">b</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"order_submit clearfix"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:;"</span> <span class="attr">id</span>=<span class="string">"order_btn"</span> <span class="attr">books_ids</span>=<span class="string">"&#123;&#123; books_ids &#125;&#125;"</span>&gt;</span>提交订单<span class="tag">&lt;/<span class="name">a</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endblock body %&#125;</span><br><span class="line">&#123;% block bottom %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"popup_con"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"popup"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span>&gt;</span>订单提交成功！<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"mask"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endblock bottom %&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后将模板中的对应元素修改为后端渲染的代码。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends 'base.html' %&#125;</span><br><span class="line">&#123;% load staticfiles %&#125;</span><br><span class="line">&#123;% block title %&#125;尚硅谷书店-我的订单&#123;% endblock title %&#125;</span><br><span class="line">&#123;% block topfiles %&#125;</span><br><span class="line">&#123;% endblock topfiles %&#125;</span><br><span class="line">&#123;% block body %&#125;</span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">h3</span> <span class="attr">class</span>=<span class="string">"common_title"</span>&gt;</span>确认收货地址<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"common_list_con clearfix"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dl</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dt</span>&gt;</span>寄送到：<span class="tag">&lt;/<span class="name">dt</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dd</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"radio"</span> <span class="attr">name</span>=<span class="string">"addr_id"</span> <span class="attr">value</span>=<span class="string">"&#123;&#123; addr.id &#125;&#125;"</span> <span class="attr">checked</span>=<span class="string">""</span>&gt;</span>&#123;&#123; addr.recipient_addr &#125;&#125; （&#123;&#123; addr.recipient_name &#125;&#125; 收） &#123;&#123; addr.recipient_phone &#125;&#125;<span class="tag">&lt;/<span class="name">dd</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dl</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"user_center_site.html"</span> <span class="attr">class</span>=<span class="string">"edit_site"</span>&gt;</span>编辑收货地址<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">h3</span> <span class="attr">class</span>=<span class="string">"common_title"</span>&gt;</span>支付方式<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"common_list_con clearfix"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"pay_style_con clearfix"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"radio"</span> <span class="attr">name</span>=<span class="string">"pay_style"</span> <span class="attr">checked</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">"cash"</span>&gt;</span>货到付款<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"radio"</span> <span class="attr">name</span>=<span class="string">"pay_style"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">"weixin"</span>&gt;</span>微信支付<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"radio"</span> <span class="attr">name</span>=<span class="string">"pay_style"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">"zhifubao"</span>&gt;</span><span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"radio"</span> <span class="attr">name</span>=<span class="string">"pay_style"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">"bank"</span>&gt;</span>银行卡支付<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">h3</span> <span class="attr">class</span>=<span class="string">"common_title"</span>&gt;</span>商品列表<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"common_list_con clearfix"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"book_list_th clearfix"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col01"</span>&gt;</span>商品名称<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col02"</span>&gt;</span>商品单位<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col03"</span>&gt;</span>商品价格<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col04"</span>&gt;</span>数量<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col05"</span>&gt;</span>小计<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">        &#123;% for book in books_li %&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"books_list_td clearfix"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col01"</span>&gt;</span>&#123;&#123; forloop.counter &#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col02"</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&#123;% static book.image %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col03"</span>&gt;</span>&#123;&#123; book.name &#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col04"</span>&gt;</span>&#123;&#123; book.unit &#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col05"</span>&gt;</span>&#123;&#123; book.price &#125;&#125;元<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col06"</span>&gt;</span>&#123;&#123; book.count &#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col07"</span>&gt;</span>&#123;&#123; book.amount &#125;&#125;元<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">        &#123;% endfor %&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">h3</span> <span class="attr">class</span>=<span class="string">"common_title"</span>&gt;</span>总金额结算<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"common_list_con clearfix"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"settle_con"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"total_book_count"</span>&gt;</span>共<span class="tag">&lt;<span class="name">em</span>&gt;</span>&#123;&#123; total_count &#125;&#125;<span class="tag">&lt;/<span class="name">em</span>&gt;</span>件商品，总金额<span class="tag">&lt;<span class="name">b</span>&gt;</span>&#123;&#123; total_price &#125;&#125;元<span class="tag">&lt;/<span class="name">b</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"transit"</span>&gt;</span>运费：<span class="tag">&lt;<span class="name">b</span>&gt;</span>&#123;&#123; transit_price &#125;&#125;元<span class="tag">&lt;/<span class="name">b</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"total_pay"</span>&gt;</span>实付款：<span class="tag">&lt;<span class="name">b</span>&gt;</span>&#123;&#123; total_pay &#125;&#125;元<span class="tag">&lt;/<span class="name">b</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"order_submit clearfix"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:;"</span> <span class="attr">id</span>=<span class="string">"order_btn"</span> <span class="attr">books_ids</span>=<span class="string">"&#123;&#123; books_ids &#125;&#125;"</span>&gt;</span>提交订单<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endblock body %&#125;</span><br><span class="line">&#123;% block bottom %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"popup_con"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"popup"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span>&gt;</span>订单提交成功！<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"mask"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endblock bottom %&#125;</span><br></pre></td></tr></table></figure>
<p>那么订单显示页面就初步开发完了。</p>
<h2 id="3，订单提交功能"><a href="#3，订单提交功能" class="headerlink" title="3，订单提交功能"></a>3，订单提交功能</h2><p>接下来我们来开发提交订单的功能。先开发后端接口，这里要用到事务，transaction，原子操作的概念。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># order/views.py</span></span><br><span class="line"><span class="comment"># 提交订单，需要向两张表中添加信息</span></span><br><span class="line"><span class="comment"># s_order_info:订单信息表 添加一条</span></span><br><span class="line"><span class="comment"># s_order_books: 订单商品表， 订单中买了几件商品，添加几条记录</span></span><br><span class="line"><span class="comment"># 前端需要提交过来的数据: 地址 支付方式 购买的商品id</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1.向订单表中添加一条信息</span></span><br><span class="line"><span class="comment"># 2.遍历向订单商品表中添加信息</span></span><br><span class="line">    <span class="comment"># 2.1 添加订单商品信息之后，增加商品销量，减少库存</span></span><br><span class="line">    <span class="comment"># 2.2 累计计算订单商品的总数目和总金额</span></span><br><span class="line"><span class="comment"># 3.更新订单商品的总数目和总金额</span></span><br><span class="line"><span class="comment"># 4.清除购物车对应信息</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 事务:原子性:一组sql操作，要么都成功，要么都失败。</span></span><br><span class="line"><span class="comment"># 开启事务: begin;</span></span><br><span class="line"><span class="comment"># 事务回滚: rollback;</span></span><br><span class="line"><span class="comment"># 事务提交: commit;</span></span><br><span class="line"><span class="comment"># 设置保存点: savepoint 保存点;</span></span><br><span class="line"><span class="comment"># 回滚到保存点: rollback to 保存点;</span></span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> transaction</span><br><span class="line"></span><br><span class="line"><span class="meta">@transaction.atomic</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">order_commit</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="string">'''生成订单'''</span></span><br><span class="line">    <span class="comment"># 验证用户是否登录</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> request.session.has_key(<span class="string">'islogin'</span>):</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'res'</span>: <span class="number">0</span>, <span class="string">'errmsg'</span>: <span class="string">'用户未登录'</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 接收数据</span></span><br><span class="line">    addr_id = request.POST.get(<span class="string">'addr_id'</span>)</span><br><span class="line">    pay_method = request.POST.get(<span class="string">'pay_method'</span>)</span><br><span class="line">    books_ids = request.POST.get(<span class="string">'books_ids'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 进行数据校验</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> all([addr_id, pay_method, books_ids]):</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'res'</span>: <span class="number">1</span>, <span class="string">'errmsg'</span>: <span class="string">'数据不完整'</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        addr = Address.objects.get(id=addr_id)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># 地址信息出错</span></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'res'</span>: <span class="number">2</span>, <span class="string">'errmsg'</span>: <span class="string">'地址信息错误'</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> int(pay_method) <span class="keyword">not</span> <span class="keyword">in</span> OrderInfo.PAY_METHODS_ENUM.values():</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'res'</span>: <span class="number">3</span>, <span class="string">'errmsg'</span>: <span class="string">'不支持的支付方式'</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 订单创建</span></span><br><span class="line">    <span class="comment"># 组织订单信息</span></span><br><span class="line">    passport_id = request.session.get(<span class="string">'passport_id'</span>)</span><br><span class="line">    <span class="comment"># 订单id: 20171029110830+用户的id</span></span><br><span class="line">    order_id = datetime.now().strftime(<span class="string">'%Y%m%d%H%M%S'</span>) + str(passport_id)</span><br><span class="line">    <span class="comment"># 运费</span></span><br><span class="line">    transit_price = <span class="number">10</span></span><br><span class="line">    <span class="comment"># 订单商品总数和总金额</span></span><br><span class="line">    total_count = <span class="number">0</span></span><br><span class="line">    total_price = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建一个保存点</span></span><br><span class="line">    sid = transaction.savepoint()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 向订单信息表中添加一条记录</span></span><br><span class="line">        order = OrderInfo.objects.create(order_id=order_id,</span><br><span class="line">                                 passport_id=passport_id,</span><br><span class="line">                                 addr_id=addr_id,</span><br><span class="line">                                 total_count=total_count,</span><br><span class="line">                                 total_price=total_price,</span><br><span class="line">                                 transit_price=transit_price,</span><br><span class="line">                                 pay_method=pay_method)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 向订单商品表中添加订单商品的记录</span></span><br><span class="line">        books_ids = books_ids.split(<span class="string">','</span>)</span><br><span class="line">        conn = get_redis_connection(<span class="string">'default'</span>)</span><br><span class="line">        cart_key = <span class="string">'cart_%d'</span> % passport_id</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 遍历获取用户购买的商品信息</span></span><br><span class="line">        <span class="keyword">for</span> id <span class="keyword">in</span> books_ids:</span><br><span class="line">            books = Books.objects.get_books_by_id(books_id=id)</span><br><span class="line">            <span class="keyword">if</span> books <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">                transaction.savepoint_rollback(sid)</span><br><span class="line">                <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'res'</span>: <span class="number">4</span>, <span class="string">'errmsg'</span>: <span class="string">'商品信息错误'</span>&#125;)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 获取用户购买的商品数目</span></span><br><span class="line">            count = conn.hget(cart_key, id)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 判断商品的库存</span></span><br><span class="line">            <span class="keyword">if</span> int(count) &gt; books.stock:</span><br><span class="line">                transaction.savepoint_rollback(sid)</span><br><span class="line">                <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'res'</span>: <span class="number">5</span>, <span class="string">'errmsg'</span>: <span class="string">'商品库存不足'</span>&#125;)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 创建一条订单商品记录</span></span><br><span class="line">            OrderGoods.objects.create(order_id=order_id,</span><br><span class="line">                                      books_id=id,</span><br><span class="line">                                      count=count,</span><br><span class="line">                                      price=books.price)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 增加商品的销量，减少商品库存</span></span><br><span class="line">            books.sales += int(count)</span><br><span class="line">            books.stock -= int(count)</span><br><span class="line">            books.save()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 累计计算商品的总数目和总额</span></span><br><span class="line">            total_count += int(count)</span><br><span class="line">            total_price += int(count) * books.price</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 更新订单的商品总数目和总金额</span></span><br><span class="line">        order.total_count = total_count</span><br><span class="line">        order.total_price = total_price</span><br><span class="line">        order.save()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># 操作数据库出错，进行回滚操作</span></span><br><span class="line">        transaction.savepoint_rollback(sid)</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'res'</span>: <span class="number">7</span>, <span class="string">'errmsg'</span>: <span class="string">'服务器错误'</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 清除购物车对应记录</span></span><br><span class="line">    conn.hdel(cart_key, *books_ids)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 事务提交</span></span><br><span class="line">    transaction.savepoint_commit(sid)</span><br><span class="line">    <span class="comment"># 返回应答</span></span><br><span class="line">    <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'res'</span>: <span class="number">6</span>&#125;)</span><br></pre></td></tr></table></figure>
<p>然后配置urls.py<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url(<span class="string">r'^commit/$'</span>, views.order_commit, name=<span class="string">'commit'</span>), <span class="comment"># 生成订单</span></span><br></pre></td></tr></table></figure></p>
<p>然后改写前端页面<code>place_order.html</code>，来调用后端提交订单的接口。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&#123;% block bottomfiles %&#125;</span><br><span class="line">    &lt;script type=<span class="string">"text/javascript"</span>&gt;</span><br><span class="line">        $(<span class="string">'#order_btn'</span>).click(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="comment">// 获取收货地址的id, 支付方式，用户购买的商品id</span></span><br><span class="line">            <span class="keyword">var</span> addr_id = $(<span class="string">'input[name="addr_id"]'</span>).val()</span><br><span class="line">            <span class="keyword">var</span> pay_method = $(<span class="string">'input[name="pay_style"]:checked'</span>).val()</span><br><span class="line">            <span class="keyword">var</span> books_ids = $(<span class="keyword">this</span>).attr(<span class="string">'books_ids'</span>)</span><br><span class="line">            <span class="keyword">var</span> csrf = $(<span class="string">'input[name="csrfmiddlewaretoken"]'</span>).val()</span><br><span class="line">            <span class="comment">// alert(addr_id+':'+pay_method+':'+books_ids)</span></span><br><span class="line">            <span class="comment">// 发起post请求， 访问/order/commit/</span></span><br><span class="line">            <span class="keyword">var</span> params = &#123;</span><br><span class="line">                <span class="string">'addr_id'</span>: addr_id,</span><br><span class="line">                <span class="string">'pay_method'</span>: pay_method,</span><br><span class="line">                <span class="string">'books_ids'</span>: books_ids,</span><br><span class="line">                <span class="string">'csrfmiddlewaretoken'</span>: csrf</span><br><span class="line">            &#125;</span><br><span class="line">            $.post(<span class="string">'/order/commit/'</span>, params, <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">                <span class="comment">// 根据json进行处理</span></span><br><span class="line">                <span class="keyword">if</span> (data.res == <span class="number">6</span>)&#123;</span><br><span class="line">                    $(<span class="string">'.popup_con'</span>).fadeIn(<span class="string">'fast'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                        setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                            $(<span class="string">'.popup_con'</span>).fadeOut(<span class="string">'fast'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                                <span class="built_in">window</span>.location.href = <span class="string">'/user/order/'</span>;</span><br><span class="line">                            &#125;);</span><br><span class="line">                        &#125;,<span class="number">3000</span>)</span><br><span class="line"></span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    alert(data.errmsg)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line"></span><br><span class="line">        &#125;);</span><br><span class="line">    &lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp">&#123;% endblock bottomfiles %&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>那么，我们提交订单的功能也就开发好了。</p>
<h2 id="4，接下来我们回过头去把购物车中的提交功能给做了，然后就能做支付功能了。"><a href="#4，接下来我们回过头去把购物车中的提交功能给做了，然后就能做支付功能了。" class="headerlink" title="4，接下来我们回过头去把购物车中的提交功能给做了，然后就能做支付功能了。"></a>4，接下来我们回过头去把购物车中的提交功能给做了，然后就能做支付功能了。</h2><p>将cart.html中的去结算功能给出如下的实现。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">action</span>=<span class="string">"/order/place/"</span>&gt;</span></span><br><span class="line">&#123;% for book in books_li %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"cart_list_td clearfix"</span>&gt;</span></span><br><span class="line">    &#123;# 提交表单时，如果checkbox没有被选中，它的值不会被提交 #&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col01"</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">name</span>=<span class="string">"books_ids"</span> <span class="attr">value</span>=<span class="string">"&#123;&#123; book.id &#125;&#125;"</span> <span class="attr">checked</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col02"</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&#123;% static book.image %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col03"</span>&gt;</span>&#123;&#123; book.name &#125;&#125;<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">em</span>&gt;</span>&#123;&#123; book.price &#125;&#125;元/&#123;&#123; book.unit &#125;&#125;<span class="tag">&lt;/<span class="name">em</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col04"</span>&gt;</span>&#123;&#123; book.unit &#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col05"</span>&gt;</span>&#123;&#123; book.price &#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col06"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"num_add"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:;"</span> <span class="attr">class</span>=<span class="string">"add fl"</span>&gt;</span>+<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">books_id</span>=<span class="string">&#123;&#123;</span> <span class="attr">book.id</span> &#125;&#125; <span class="attr">class</span>=<span class="string">"num_show fl"</span> <span class="attr">value</span>=<span class="string">"&#123;&#123; book.count &#125;&#125;"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:;"</span> <span class="attr">class</span>=<span class="string">"minus fl"</span>&gt;</span>-<span class="tag">&lt;/<span class="name">a</span>&gt;</span>   </span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col07"</span>&gt;</span>&#123;&#123; book.amount &#125;&#125;元<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col08"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:;"</span>&gt;</span>删除<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"settlements"</span>&gt;</span></span><br><span class="line">    &#123; % csrf_token %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col01"</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">name</span>=<span class="string">""</span> <span class="attr">checked</span>=<span class="string">""</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col02"</span>&gt;</span>全选<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col03"</span>&gt;</span>合计(不含运费)：<span class="tag">&lt;<span class="name">span</span>&gt;</span>¥<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">em</span>&gt;</span>&#123;&#123; total_price &#125;&#125;<span class="tag">&lt;/<span class="name">em</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span>共计<span class="tag">&lt;<span class="name">b</span>&gt;</span>&#123;&#123; total_count &#125;&#125;<span class="tag">&lt;/<span class="name">b</span>&gt;</span>件商品<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col04"</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"去结算"</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>好，我们去结算功能也实现了。</p>
<h2 id="5，接下来我们将提交订单页面完善一下，完成去支付功能。将支付方式绑定value值，供提交。"><a href="#5，接下来我们将提交订单页面完善一下，完成去支付功能。将支付方式绑定value值，供提交。" class="headerlink" title="5，接下来我们将提交订单页面完善一下，完成去支付功能。将支付方式绑定value值，供提交。"></a>5，接下来我们将提交订单页面完善一下，完成去支付功能。将支付方式绑定value值，供提交。</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"radio"</span> <span class="attr">name</span>=<span class="string">"pay_style"</span> <span class="attr">value</span>=<span class="string">"1"</span> <span class="attr">checked</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">"cash"</span>&gt;</span>货到付款<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"radio"</span> <span class="attr">name</span>=<span class="string">"pay_style"</span> <span class="attr">value</span>=<span class="string">"2"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">"weixin"</span>&gt;</span>微信支付<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"radio"</span> <span class="attr">name</span>=<span class="string">"pay_style"</span> <span class="attr">value</span>=<span class="string">"3"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">"zhifubao"</span>&gt;</span><span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"radio"</span> <span class="attr">name</span>=<span class="string">"pay_style"</span> <span class="attr">value</span>=<span class="string">"4"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">"bank"</span>&gt;</span>银行卡支付<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>查缺补漏，发现编辑收货地址功能还没有实现。我们先来编写用户中心地址页的接口。注意，要写在<code>users/views.py</code>中。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">address</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="string">'''用户中心-地址页'''</span></span><br><span class="line">    <span class="comment"># 获取登录用户的id</span></span><br><span class="line">    passport_id = request.session.get(<span class="string">'passport_id'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'GET'</span>:</span><br><span class="line">        <span class="comment"># 显示地址页面</span></span><br><span class="line">        <span class="comment"># 查询用户的默认地址</span></span><br><span class="line">        addr = Address.objects.get_default_address(passport_id=passport_id)</span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">'users/user_center_site.html'</span>, &#123;<span class="string">'addr'</span>: addr, <span class="string">'page'</span>: <span class="string">'address'</span>&#125;)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># 添加收货地址</span></span><br><span class="line">        <span class="comment"># 1.接收数据</span></span><br><span class="line">        recipient_name = request.POST.get(<span class="string">'username'</span>)</span><br><span class="line">        recipient_addr = request.POST.get(<span class="string">'addr'</span>)</span><br><span class="line">        zip_code = request.POST.get(<span class="string">'zip_code'</span>)</span><br><span class="line">        recipient_phone = request.POST.get(<span class="string">'phone'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 2.进行校验</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> all([recipient_name, recipient_addr, zip_code, recipient_phone]):</span><br><span class="line">            <span class="keyword">return</span> render(request, <span class="string">'users/user_center_site.html'</span>, &#123;<span class="string">'errmsg'</span>: <span class="string">'参数不能为空!'</span>&#125;)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 3.添加收货地址</span></span><br><span class="line">        Address.objects.add_one_address(passport_id=passport_id,</span><br><span class="line">                                        recipient_name=recipient_name,</span><br><span class="line">                                        recipient_addr=recipient_addr,</span><br><span class="line">                                        zip_code=zip_code,</span><br><span class="line">                                        recipient_phone=recipient_phone)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 4.返回应答</span></span><br><span class="line">        <span class="keyword">return</span> redirect(reverse(<span class="string">'user:address'</span>))</span><br></pre></td></tr></table></figure></p>
<p>然后配置urls.py<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url(<span class="string">r'^address/$'</span>, views.address, name=<span class="string">'address'</span>), <span class="comment"># 用户中心-地址页</span></span><br></pre></td></tr></table></figure></p>
<p>然后将user_center_site.html拷贝到templates/users文件夹下。并继承base.html。<br>然后改写模板。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"site_con"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dl</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dt</span>&gt;</span>当前地址：<span class="tag">&lt;/<span class="name">dt</span>&gt;</span></span><br><span class="line">        &#123;% if addr %&#125;</span><br><span class="line">            <span class="tag">&lt;<span class="name">dd</span>&gt;</span>&#123;&#123; addr.recipient_addr &#125;&#125; （&#123;&#123; addr.recipient_name &#125;&#125; 收） &#123;&#123; addr.recipient_phone &#125;&#125;<span class="tag">&lt;/<span class="name">dd</span>&gt;</span></span><br><span class="line">        &#123;% else %&#125;</span><br><span class="line">            <span class="tag">&lt;<span class="name">dd</span>&gt;</span>无<span class="tag">&lt;/<span class="name">dd</span>&gt;</span></span><br><span class="line">        &#123;% endif %&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">dl</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>改写form提交表单。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">action</span>=<span class="string">"/user/address/"</span>&gt;</span></span><br><span class="line">    &#123; % csrf_token %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form_group"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span>&gt;</span>收件人：<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"username"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form_group form_group2"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span>&gt;</span>详细地址：<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">class</span>=<span class="string">"site_area"</span> <span class="attr">name</span>=<span class="string">"addr"</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form_group"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span>&gt;</span>邮编：<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"zip_code"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form_group"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span>&gt;</span>手机：<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"phone"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"提交"</span> <span class="attr">class</span>=<span class="string">"info_submit"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>好，我们编辑地址的功能已经编写好了。</p>
<h2 id="6，完善用户中心"><a href="#6，完善用户中心" class="headerlink" title="6，完善用户中心"></a>6，完善用户中心</h2><p>接下来我们进一步完善一下用户中心，把用户中心的订单显示页面给做了。先来实现订单显示的后台接口。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># users/views.py</span></span><br><span class="line"><span class="keyword">from</span> django.core.paginator <span class="keyword">import</span> Paginator</span><br><span class="line"></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">order</span><span class="params">(request, page)</span>:</span></span><br><span class="line">    <span class="string">'''用户中心-订单页'''</span></span><br><span class="line">    <span class="comment"># 查询用户的订单信息</span></span><br><span class="line">    passport_id = request.session.get(<span class="string">'passport_id'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取订单信息</span></span><br><span class="line">    order_li = OrderInfo.objects.filter(passport_id=passport_id)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 遍历获取订单的商品信息</span></span><br><span class="line">    <span class="comment"># order-&gt;OrderInfo实例对象</span></span><br><span class="line">    <span class="keyword">for</span> order <span class="keyword">in</span> order_li:</span><br><span class="line">        <span class="comment"># 根据订单id查询订单商品信息</span></span><br><span class="line">        order_id = order.order_id</span><br><span class="line">        order_books_li = OrderGoods.objects.filter(order_id=order_id)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 计算商品的小计</span></span><br><span class="line">        <span class="comment"># order_books -&gt;OrderGoods实例对象</span></span><br><span class="line">        <span class="keyword">for</span> order_books <span class="keyword">in</span> order_books_li:</span><br><span class="line">            count = order_books.count</span><br><span class="line">            price = order_books.price</span><br><span class="line">            amount = count * price</span><br><span class="line">            <span class="comment"># 保存订单中每一个商品的小计</span></span><br><span class="line">            order_books.amount = amount</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 给order对象动态增加一个属性order_books_li,保存订单中商品的信息</span></span><br><span class="line">        order.order_books_li = order_books_li</span><br><span class="line">    </span><br><span class="line">    paginator = Paginator(order_li, <span class="number">3</span>)      <span class="comment"># 每页显示3个订单</span></span><br><span class="line">    </span><br><span class="line">    num_pages = paginator.num_pages</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> page:        <span class="comment"># 首次进入时默认进入第一页</span></span><br><span class="line">        page = <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> page == <span class="string">''</span> <span class="keyword">or</span> int(page) &gt; num_pages:</span><br><span class="line">        page = <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        page = int(page)</span><br><span class="line">        </span><br><span class="line">    order_li = paginator.page(page)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> num_pages &lt; <span class="number">5</span>:</span><br><span class="line">        pages = range(<span class="number">1</span>, num_pages + <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">elif</span> page &lt;= <span class="number">3</span>:</span><br><span class="line">        pages = range(<span class="number">1</span>, <span class="number">6</span>)</span><br><span class="line">    <span class="keyword">elif</span> num_pages - page &lt;= <span class="number">2</span>:</span><br><span class="line">        pages = range(num_pages - <span class="number">4</span>, num_pages + <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        pages = range(page - <span class="number">2</span>, page + <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    context = &#123;</span><br><span class="line">        <span class="string">'order_li'</span>: order_li,</span><br><span class="line">        <span class="string">'pages'</span>: pages,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'users/user_center_order.html'</span>, context)</span><br></pre></td></tr></table></figure></p>
<p>然后配置urls.py。<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">    url(<span class="string">r'^order/(?P&lt;page&gt;\d+)?/?$'</span>, views.order, name=<span class="string">'order'</span>), <span class="comment"># 用户中心-订单页  增加分页功能</span></span><br></pre></td></tr></table></figure></p>
<p>然后将user_center_order.html拷贝到templates/users文件夹下，并继承base.html。<br>然后改写模板中的元素，使得后端可以渲染。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends 'base.html' %&#125;</span><br><span class="line">&#123;% load staticfiles %&#125;</span><br><span class="line">&#123;% block title %&#125;尚硅谷书店-首页&#123;% endblock title %&#125;</span><br><span class="line">&#123;% block topfiles %&#125;</span><br><span class="line">&#123;% endblock topfiles %&#125;</span><br><span class="line">&#123;% block body %&#125;</span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"main_con clearfix"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"left_menu_con clearfix"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">h3</span>&gt;</span>用户中心<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'user:user' %&#125;"</span>&gt;</span>· 个人信息<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'user:order' %&#125;"</span> <span class="attr">class</span>=<span class="string">"active"</span>&gt;</span>· 全部订单<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'user:address' %&#125;"</span>&gt;</span>· 收货地址<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"right_content clearfix"</span>&gt;</span></span><br><span class="line">                &#123; % csrf_token %&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">h3</span> <span class="attr">class</span>=<span class="string">"common_title2"</span>&gt;</span>全部订单<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">                &#123;# OrderInfo #&#125;</span><br><span class="line">                &#123;% for order in order_li %&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"order_list_th w978 clearfix"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col01"</span>&gt;</span>&#123;&#123; order.create_time &#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col02"</span>&gt;</span>订单号：&#123;&#123; order.order_id &#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col02 stress"</span>&gt;</span>&#123;&#123; order.status &#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;<span class="name">table</span> <span class="attr">class</span>=<span class="string">"order_list_table w980"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">tbody</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">td</span> <span class="attr">width</span>=<span class="string">"55%"</span>&gt;</span></span><br><span class="line">                                &#123;# 遍历出来的order_books是一个OrderGoods对象 #&#125;</span><br><span class="line">                                &#123;% for order_books in order.order_books_li %&#125;</span><br><span class="line">                                <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"order_book_list clearfix"</span>&gt;</span>                   </span><br><span class="line">                                    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col01"</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&#123;% static order_books.books.image %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col02"</span>&gt;</span>&#123;&#123; order_books.books.name &#125;&#125;<span class="tag">&lt;<span class="name">em</span>&gt;</span>&#123;&#123; order_books.books.price &#125;&#125;元/&#123;&#123; order_books.books.unit &#125;&#125;<span class="tag">&lt;/<span class="name">em</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col03"</span>&gt;</span>&#123;&#123; order_books.count &#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"col04"</span>&gt;</span>&#123;&#123; order_books.amount &#125;&#125;元<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">                                &#123;% endfor %&#125;</span><br><span class="line">                            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">td</span> <span class="attr">width</span>=<span class="string">"15%"</span>&gt;</span>&#123;&#123; order.total_price &#125;&#125;元<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">td</span> <span class="attr">width</span>=<span class="string">"15%"</span>&gt;</span>&#123;&#123; order.status &#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">td</span> <span class="attr">width</span>=<span class="string">"15%"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span> <span class="attr">pay_method</span>=<span class="string">"&#123;&#123; order.pay_method &#125;&#125;"</span> <span class="attr">order_id</span>=<span class="string">"&#123;&#123; order.order_id &#125;&#125;"</span> <span class="attr">order_status</span>=<span class="string">"&#123;&#123; order.status &#125;&#125;"</span> <span class="attr">class</span>=<span class="string">"oper_btn"</span>&gt;</span>去付款<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">tbody</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">                &#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"pagenation"</span>&gt;</span></span><br><span class="line">                    &#123;% if order_li.has_previous %&#125;</span><br><span class="line">                        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'user:order' page=order_li.previous_page_number %&#125;"</span>&gt;</span>上一页<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                    &#123;% endif %&#125;</span><br><span class="line">                    &#123;% for page in pages %&#125;</span><br><span class="line">                        &#123;% if page == order_li.number %&#125;</span><br><span class="line">                            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'user:order' page=page %&#125;"</span> <span class="attr">class</span>=<span class="string">"active"</span>&gt;</span>&#123;&#123; page &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                        &#123;% else %&#125;</span><br><span class="line">                            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'user:order' page=page %&#125;"</span>&gt;</span>&#123;&#123; page &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                        &#123;% endif %&#125;</span><br><span class="line">                    &#123;% endfor %&#125;</span><br><span class="line">                    &#123;% if order_li.has_next %&#125;</span><br><span class="line">                        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'user:order' page=order_li.next_page_number %&#125;"</span>&gt;</span>下一页<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                    &#123;% endif %&#125;</span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endblock body %&#125;</span><br></pre></td></tr></table></figure></p>
<p>这样我们个人中心的订单的显示页面也就做完了。</p>
<h2 id="7，“去付款”功能的实现"><a href="#7，“去付款”功能的实现" class="headerlink" title="7，“去付款”功能的实现"></a>7，“去付款”功能的实现</h2><p>接下来我们需要实现“去付款”功能。这里需要集成阿里的支付宝sdk。<br>我们先来编写后端代码。</p>
<p>生成秘钥文件<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">openssl</span><br><span class="line">OpenSSL&gt; genrsa -out app_private_key.pem <span class="number">2048</span>  <span class="comment"># 私钥</span></span><br><span class="line">OpenSSL&gt; rsa -<span class="keyword">in</span> app_private_key.pem -pubout -out app_public_key.pem <span class="comment"># 导出公钥</span></span><br><span class="line">OpenSSL&gt; <span class="keyword">exit</span></span><br></pre></td></tr></table></figure></p>
<p>设置支付宝沙箱公钥<br>支付宝逐渐转换为RSA2秘钥，可以使用官方工具生成秘钥<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">支付宝沙箱地址：http<span class="variable">s:</span>//openhome.alipay.<span class="keyword">com</span>/platform/appDaily.htm?<span class="keyword">tab</span>=info</span><br><span class="line">生成RSA2教程：http<span class="variable">s:</span>//docs.<span class="keyword">open</span>.alipay.<span class="keyword">com</span>/<span class="number">291</span>/<span class="number">106130</span></span><br><span class="line">测试用秘钥： 链接: http<span class="variable">s:</span>//pan.baidu.<span class="keyword">com</span>/s/<span class="number">1</span>HpAoD8heei18rXdjRIZdUg 密码: rcip</span><br></pre></td></tr></table></figure></p>
<p>设置本地公钥&amp;私钥格式<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">app_private_key_string.pem</span><br><span class="line"></span><br><span class="line">-<span class="ruby">----<span class="keyword">BEGIN</span> RSA PRIVATE KEY-----</span></span><br><span class="line"><span class="ruby">         私钥内容</span></span><br><span class="line"><span class="ruby">-----<span class="keyword">END</span> RSA PRIVATE KEY-----</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">alipay_public_key_string.pem</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">-----<span class="keyword">BEGIN</span> PUBLIC KEY-----</span></span><br><span class="line"><span class="ruby">         公钥内容</span></span><br><span class="line"><span class="ruby">-----<span class="keyword">END</span> PUBLIC KEY-----</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># order/views.py</span></span><br><span class="line"><span class="comment"># 前端需要发过来的参数:order_id</span></span><br><span class="line"><span class="comment"># post</span></span><br><span class="line"><span class="comment"># 接口文档：https://github.com/fzlee/alipay/blob/master/README.zh-hans.md</span></span><br><span class="line"><span class="comment"># 安装python-alipay-sdk</span></span><br><span class="line"><span class="comment"># pip install python-alipay-sdk --upgrade</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> alipay <span class="keyword">import</span> AliPay</span><br><span class="line"></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">order_pay</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="string">'''订单支付'''</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 接收订单id</span></span><br><span class="line">    order_id = request.POST.get(<span class="string">'order_id'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 数据校验</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> order_id:</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'res'</span>: <span class="number">1</span>, <span class="string">'errmsg'</span>: <span class="string">'订单不存在'</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        order = OrderInfo.objects.get(order_id=order_id,</span><br><span class="line">                                      status=<span class="number">1</span>,</span><br><span class="line">                                      pay_method=<span class="number">3</span>)</span><br><span class="line">    <span class="keyword">except</span> OrderInfo.DoesNotExist:</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'res'</span>: <span class="number">2</span>, <span class="string">'errmsg'</span>: <span class="string">'订单信息出错'</span>&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将app_private_key.pem和app_public_key.pem拷贝到order文件夹下。</span></span><br><span class="line">    app_private_key_path = os.path.join(settings.BASE_DIR, <span class="string">'order/app_private_key.pem'</span>)</span><br><span class="line">    alipay_public_key_path = os.path.join(settings.BASE_DIR, <span class="string">'order/app_public_key.pem'</span>)</span><br><span class="line"></span><br><span class="line">    app_private_key_string = open(app_private_key_path).read()</span><br><span class="line">    alipay_public_key_string = open(alipay_public_key_path).read()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 和支付宝进行交互</span></span><br><span class="line">    alipay = AliPay(</span><br><span class="line">        appid=<span class="string">"2016091500515408"</span>, <span class="comment"># 应用id</span></span><br><span class="line">        app_notify_url=<span class="keyword">None</span>,  <span class="comment"># 默认回调url</span></span><br><span class="line">        app_private_key_string=app_private_key_string,</span><br><span class="line">        alipay_public_key_string=alipay_public_key_string,  <span class="comment"># 支付宝的公钥，验证支付宝回传消息使用，不是你自己的公钥,</span></span><br><span class="line">        sign_type = <span class="string">"RSA2"</span>,  <span class="comment"># RSA 或者 RSA2</span></span><br><span class="line">        debug = <span class="keyword">True</span>,  <span class="comment"># 默认False</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 电脑网站支付，需要跳转到https://openapi.alipaydev.com/gateway.do? + order_string</span></span><br><span class="line">    total_pay = order.total_price + order.transit_price <span class="comment"># decimal</span></span><br><span class="line">    order_string = alipay.api_alipay_trade_page_pay(</span><br><span class="line">        out_trade_no=order_id, <span class="comment"># 订单id</span></span><br><span class="line">        total_amount=str(total_pay), <span class="comment"># Json传递，需要将浮点转换为字符串</span></span><br><span class="line">        subject=<span class="string">'尚硅谷书城%s'</span> % order_id,</span><br><span class="line">        return_url=<span class="keyword">None</span>,</span><br><span class="line">        notify_url=<span class="keyword">None</span>  <span class="comment"># 可选, 不填则使用默认notify url</span></span><br><span class="line">    )</span><br><span class="line">    <span class="comment"># 返回应答</span></span><br><span class="line">    pay_url = settings.ALIPAY_URL + <span class="string">'?'</span> + order_string</span><br><span class="line">    <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'res'</span>: <span class="number">3</span>, <span class="string">'pay_url'</span>: pay_url, <span class="string">'message'</span>: <span class="string">'OK'</span>&#125;)</span><br></pre></td></tr></table></figure>
<p>然后我们把公钥和私钥拷贝到order文件夹下。<br>然后我们需要获取用户的支付结果。<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 前端需要发过来的参数:order_id</span></span><br><span class="line"><span class="comment"># post</span></span><br><span class="line"><span class="keyword">from</span> alipay <span class="keyword">import</span> AliPay</span><br><span class="line"></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_pay</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="string">'''获取用户支付的结果'''</span></span><br><span class="line"></span><br><span class="line">    passport_id = request.session.get(<span class="string">'passport_id'</span>)</span><br><span class="line">    <span class="comment"># 接收订单id</span></span><br><span class="line">    order_id = request.POST.get(<span class="string">'order_id'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 数据校验</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> order_id:</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'res'</span>: <span class="number">1</span>, <span class="string">'errmsg'</span>: <span class="string">'订单不存在'</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        order = OrderInfo.objects.get(order_id=order_id,</span><br><span class="line">                                      passport_id=passport_id,</span><br><span class="line">                                      pay_method=<span class="number">3</span>)</span><br><span class="line">    <span class="keyword">except</span> OrderInfo.DoesNotExist:</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'res'</span>: <span class="number">2</span>, <span class="string">'errmsg'</span>: <span class="string">'订单信息出错'</span>&#125;)</span><br><span class="line"></span><br><span class="line">    app_private_key_path = os.path.join(settings.BASE_DIR, <span class="string">'order/app_private_key.pem'</span>)</span><br><span class="line">    alipay_public_key_path = os.path.join(settings.BASE_DIR, <span class="string">'order/app_public_key.pem'</span>)</span><br><span class="line"></span><br><span class="line">    app_private_key_string = open(app_private_key_path).read()</span><br><span class="line">    alipay_public_key_string = open(alipay_public_key_path).read()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 和支付宝进行交互</span></span><br><span class="line">    alipay = AliPay(</span><br><span class="line">        appid=<span class="string">"2016091500515408"</span>, <span class="comment"># 应用id</span></span><br><span class="line">        app_notify_url=<span class="keyword">None</span>,  <span class="comment"># 默认回调url</span></span><br><span class="line">        app_private_key_string=app_private_key_string,</span><br><span class="line">        alipay_public_key_string=alipay_public_key_string,  <span class="comment"># 支付宝的公钥，验证支付宝回传消息使用，不是你自己的公钥,</span></span><br><span class="line">        sign_type = <span class="string">"RSA2"</span>,  <span class="comment"># RSA 或者 RSA2</span></span><br><span class="line">        debug = <span class="keyword">True</span>,  <span class="comment"># 默认False</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        <span class="comment"># 进行支付结果查询</span></span><br><span class="line">        result = alipay.api_alipay_trade_query(order_id)</span><br><span class="line">        code = result.get(<span class="string">'code'</span>)</span><br><span class="line">        <span class="keyword">if</span> code == <span class="string">'10000'</span> <span class="keyword">and</span> result.get(<span class="string">'trade_status'</span>) == <span class="string">'TRADE_SUCCESS'</span>:</span><br><span class="line">            <span class="comment"># 用户支付成功</span></span><br><span class="line">            <span class="comment"># 改变订单支付状态</span></span><br><span class="line">            order.status = <span class="number">2</span> <span class="comment"># 待发货</span></span><br><span class="line">            <span class="comment"># 填写支付宝交易号</span></span><br><span class="line">            order.trade_id = result.get(<span class="string">'trade_no'</span>)</span><br><span class="line">            order.save()</span><br><span class="line">            <span class="comment"># 返回数据</span></span><br><span class="line">            <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'res'</span>:<span class="number">3</span>, <span class="string">'message'</span>:<span class="string">'支付成功'</span>&#125;)</span><br><span class="line">        <span class="keyword">elif</span> code == <span class="string">'40004'</span> <span class="keyword">or</span> (code == <span class="string">'10000'</span> <span class="keyword">and</span> result.get(<span class="string">'trade_status'</span>) == <span class="string">'WAIT_BUYER_PAY'</span>):</span><br><span class="line">            <span class="comment"># 支付订单还未生成，继续查询</span></span><br><span class="line">            <span class="comment"># 用户还未完成支付，继续查询</span></span><br><span class="line">            time.sleep(<span class="number">5</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 支付出错</span></span><br><span class="line">            <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'res'</span>:<span class="number">4</span>, <span class="string">'errmsg'</span>:<span class="string">'支付出错'</span>&#125;)</span><br></pre></td></tr></table></figure></p>
<p>配置支付宝gateway到配置文件中。<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALIPAY_URL=<span class="string">'https://openapi.alipaydev.com/gateway.do'</span></span><br></pre></td></tr></table></figure></p>
<p>配置urls.py。<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">url(<span class="string">r'^pay/$'</span>, views.order_pay, name=<span class="string">'pay'</span>), <span class="comment"># 订单支付</span></span><br><span class="line">url(<span class="string">r'^check_pay/$'</span>, views.check_pay, name=<span class="string">'check_pay'</span>), <span class="comment"># 查询支付结果</span></span><br></pre></td></tr></table></figure></p>
<p>然后编写前端jquery代码，来处理支付后的结果，比如支付成功以后刷新页面。以下代码写入<code>templates/users/user_center_order.html</code>中。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&#123;% block bottomfiles%&#125;</span><br><span class="line">    &lt;script&gt;</span><br><span class="line">    $(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        $(<span class="string">'.oper_btn'</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="comment">// 获取订单id和订单的状态</span></span><br><span class="line">            order_id = $(<span class="keyword">this</span>).attr(<span class="string">'order_id'</span>)</span><br><span class="line">            order_status = $(<span class="keyword">this</span>).attr(<span class="string">'order_status'</span>)</span><br><span class="line">            csrf = $(<span class="string">'input[name="csrfmiddlewaretoken"]'</span>).val()</span><br><span class="line">            params = &#123;<span class="string">'order_id'</span>:order_id, <span class="string">'csrfmiddlewaretoken'</span>:csrf&#125;</span><br><span class="line">            <span class="keyword">if</span> (order_status == <span class="number">1</span>)&#123;</span><br><span class="line">                $.post(<span class="string">'/order/pay/'</span>, params, <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (data.res == <span class="number">3</span>)&#123;</span><br><span class="line">                        <span class="comment">// 把用户引导支付页面</span></span><br><span class="line">                        <span class="built_in">window</span>.open(data.pay_url)</span><br><span class="line">                        <span class="comment">// 查询用户的支付结果</span></span><br><span class="line">                        $.post(<span class="string">'/order/check_pay/'</span>, params, <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">                            <span class="keyword">if</span> (data.res == <span class="number">3</span>)&#123;</span><br><span class="line">                                alert(<span class="string">'支付成功'</span>)</span><br><span class="line">                                <span class="comment">// 重新刷新页面</span></span><br><span class="line">                                location.reload()</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span>&#123;</span><br><span class="line">                                alert(data.errmsg)</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;)</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span>&#123;</span><br><span class="line">                        alert(data.errmsg)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    &lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp">&#123;% endblock bottomfiles %&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>好，我们支付功能也编写好了。</p>
<h1 id="7，使用缓存"><a href="#7，使用缓存" class="headerlink" title="7，使用缓存"></a><a id="7">7，使用缓存</a></h1><p>使用redis缓存首页的页面。<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.views.decorators.cache <span class="keyword">import</span> cache_page</span><br><span class="line"><span class="meta">@cache_page(60 * 15)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="string">'''显示首页'''</span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure></p>
<p>别忘了把redis启动起来。<br>在settings.py中配置redis缓存。<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pip install django-redis</span></span><br><span class="line">CACHES = &#123;</span><br><span class="line">    <span class="string">"default"</span>: &#123;</span><br><span class="line">        <span class="string">"BACKEND"</span>: <span class="string">"django_redis.cache.RedisCache"</span>,</span><br><span class="line">        <span class="string">"LOCATION"</span>: <span class="string">"redis://127.0.0.1:6379/2"</span>,</span><br><span class="line">        <span class="string">"OPTIONS"</span>: &#123;</span><br><span class="line">            <span class="string">"CLIENT_CLASS"</span>: <span class="string">"django_redis.client.DefaultClient"</span>,</span><br><span class="line">            <span class="string">"PASSWORD"</span>: <span class="string">""</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SESSION_ENGINE = <span class="string">"django.contrib.sessions.backends.cache"</span></span><br><span class="line">SESSION_CACHE_ALIAS = <span class="string">"default"</span></span><br></pre></td></tr></table></figure></p>
<h1 id="8，评论功能的实现"><a href="#8，评论功能的实现" class="headerlink" title="8，评论功能的实现"></a><a id="8">8，评论功能的实现</a></h1><p>先来新建comments应用。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> python manage.py startapp comments</span></span><br></pre></td></tr></table></figure></p>
<p>然后设计数据库表结构。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> db.base_model <span class="keyword">import</span> BaseModel</span><br><span class="line"><span class="keyword">from</span> users.models <span class="keyword">import</span> Passport</span><br><span class="line"><span class="keyword">from</span> books.models <span class="keyword">import</span> Books</span><br><span class="line"><span class="comment"># Create your models here.</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Comments</span><span class="params">(BaseModel)</span>:</span></span><br><span class="line">    disabled = models.BooleanField(default=<span class="keyword">False</span>, verbose_name=<span class="string">"禁用评论"</span>)</span><br><span class="line">    user = models.ForeignKey(<span class="string">'users.Passport'</span>, verbose_name=<span class="string">"用户ID"</span>)</span><br><span class="line">    book = models.ForeignKey(<span class="string">'books.Books'</span>, verbose_name=<span class="string">"书籍ID"</span>)</span><br><span class="line">    content = models.CharField(max_length=<span class="number">1000</span>, verbose_name=<span class="string">"评论内容"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        db_table = <span class="string">'s_comment_table'</span></span><br></pre></td></tr></table></figure>
<p>这里要注意外键的使用和理解。<br>然后我们要在配置文件里注册app。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># bookstore/settings.py</span></span><br><span class="line">INSTALLED_APPS = (</span><br><span class="line">    ...</span><br><span class="line">    <span class="string">'comments'</span>, <span class="comment"># 评论模块</span></span><br><span class="line">    ...</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>然后我们来写评论应用的视图函数。视图函数使用redis作为缓存，缓存了get请求的结果。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># comments/views.py</span></span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> JsonResponse</span><br><span class="line"><span class="keyword">from</span> django.views.decorators.http <span class="keyword">import</span> require_http_methods</span><br><span class="line"><span class="keyword">from</span> comments.models <span class="keyword">import</span> Comments</span><br><span class="line"><span class="keyword">from</span> books.models <span class="keyword">import</span> Books</span><br><span class="line"><span class="keyword">from</span> users.models <span class="keyword">import</span> Passport</span><br><span class="line"><span class="keyword">from</span> django.views.decorators.csrf <span class="keyword">import</span> csrf_exempt</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">from</span> utils.decorators <span class="keyword">import</span> login_required</span><br><span class="line"><span class="comment"># Create your views here.</span></span><br><span class="line"><span class="comment"># 设置过期时间</span></span><br><span class="line">EXPIRE_TIME = <span class="number">60</span> * <span class="number">10</span></span><br><span class="line"><span class="comment"># 连接redis数据库</span></span><br><span class="line">pool = redis.ConnectionPool(host=<span class="string">'localhost'</span>, port=<span class="number">6379</span>, db=<span class="number">2</span>)</span><br><span class="line">redis_db = redis.Redis(connection_pool=pool)</span><br><span class="line"></span><br><span class="line"><span class="meta">@csrf_exempt</span></span><br><span class="line"><span class="meta">@require_http_methods(['GET', 'POST'])</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">comment</span><span class="params">(request, books_id)</span>:</span></span><br><span class="line">    book_id = books_id</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'GET'</span>:</span><br><span class="line">        <span class="comment"># 先在redis里面寻找评论</span></span><br><span class="line">        c = redis_db.get(<span class="string">'comment_%s'</span> % book_id)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            c = c.decode(<span class="string">'utf-8'</span>)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        print(<span class="string">'c: '</span>, c)</span><br><span class="line">        <span class="keyword">if</span> c:</span><br><span class="line">            <span class="keyword">return</span> JsonResponse(&#123;</span><br><span class="line">                    <span class="string">'code'</span>: <span class="number">200</span>,</span><br><span class="line">                    <span class="string">'data'</span>: json.loads(c),</span><br><span class="line">                &#125;)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 找不到，就从数据库里面取</span></span><br><span class="line">            comments = Comments.objects.filter(book_id=book_id)</span><br><span class="line">            data = []</span><br><span class="line">            <span class="keyword">for</span> c <span class="keyword">in</span> comments:</span><br><span class="line">                data.append(&#123;</span><br><span class="line">                    <span class="string">'user_id'</span>: c.user_id,</span><br><span class="line">                    <span class="string">'content'</span>: c.content,</span><br><span class="line">                &#125;)</span><br><span class="line"></span><br><span class="line">            res = &#123;</span><br><span class="line">                <span class="string">'code'</span>: <span class="number">200</span>,</span><br><span class="line">                <span class="string">'data'</span>: data, </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                redis_db.setex(<span class="string">'comment_%s'</span> % book_id, json.dumps(data), EXPIRE_TIME)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                print(<span class="string">'e: '</span>, e)</span><br><span class="line">            <span class="keyword">return</span> JsonResponse(res)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        params = json.loads(request.body.decode(<span class="string">'utf-8'</span>))</span><br><span class="line"></span><br><span class="line">        book_id = params.get(<span class="string">'book_id'</span>)</span><br><span class="line">        user_id = params.get(<span class="string">'user_id'</span>)</span><br><span class="line">        content = params.get(<span class="string">'content'</span>)</span><br><span class="line"></span><br><span class="line">        book = Books.objects.get(id=book_id)</span><br><span class="line">        user = Passport.objects.get(id=user_id)</span><br><span class="line"></span><br><span class="line">        comment = Comments(book=book, user=user, content=content)</span><br><span class="line">        comment.save()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;</span><br><span class="line">                <span class="string">'code'</span>: <span class="number">200</span>,</span><br><span class="line">                <span class="string">'msg'</span>: <span class="string">'评论成功'</span>,</span><br><span class="line">            &#125;)</span><br></pre></td></tr></table></figure></p>
<p>然后注册url。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 根urls.py: bookstore: urls.py</span></span><br><span class="line">urlpatterns = [</span><br><span class="line">    ...</span><br><span class="line">    url(<span class="string">r'^comment/'</span>, include(<span class="string">'comments.urls'</span>, namespace=<span class="string">'comment'</span>)), <span class="comment"># 评论模块</span></span><br><span class="line">    ...</span><br><span class="line">]</span><br></pre></td></tr></table></figure></p>
<p>comments app的url注册。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url</span><br><span class="line"><span class="keyword">from</span> comments <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r'comment/(?P&lt;books_id&gt;\d+)/$'</span>, views.comment, name=<span class="string">'comment'</span>), <span class="comment"># 评论内容</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure></p>
<p>注册好url以后，我们要编写detail.html里面的前端代码了。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"operate_btn"</span>&gt;</span></span><br><span class="line">    &#123; % csrf_token %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:;"</span> <span class="attr">class</span>=<span class="string">"buy_btn"</span>&gt;</span>立即购买<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:;"</span> <span class="attr">books_id</span>=<span class="string">"&#123;&#123; books.id &#125;&#125;"</span> <span class="attr">class</span>=<span class="string">"add_cart"</span> <span class="attr">id</span>=<span class="string">"add_cart"</span>&gt;</span>加入购物车<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span> <span class="attr">id</span>=<span class="string">"write-comment"</span> <span class="attr">class</span>=<span class="string">"comment"</span>&gt;</span>我要写评论<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"display:flex;"</span> <span class="attr">id</span>=<span class="string">"comment-input"</span> <span class="attr">data-bookid</span>=<span class="string">"&#123;&#123; books.id &#125;&#125;"</span> <span class="attr">data-userid</span>=<span class="string">"&#123;&#123; request.session.passport_id &#125;&#125;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">placeholder</span>=<span class="string">"评论内容"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"submit-comment"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span>&gt;</span></span><br><span class="line">          提交评论</span><br><span class="line">        <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>再增加id-book_detail 和id-book_comment 增加点击效果<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"r_wrap fr clearfix"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"detail_tab clearfix"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"active"</span> <span class="attr">id</span>=<span class="string">"detail"</span>&gt;</span>商品介绍<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">id</span>=<span class="string">"comment"</span>&gt;</span>评论<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"tab_content"</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dl</span> <span class="attr">id</span>=<span class="string">"book_detail"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dt</span>&gt;</span>商品详情：<span class="tag">&lt;/<span class="name">dt</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dd</span>&gt;</span>&#123;&#123; books.detail | safe &#125;&#125;<span class="tag">&lt;/<span class="name">dd</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dl</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dl</span> <span class="attr">id</span>=<span class="string">"book_comment"</span> <span class="attr">style</span>=<span class="string">"display: none; font-size: 15px; color: #0a0a0a"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dt</span>&gt;</span>用户评论:<span class="tag">&lt;/<span class="name">dt</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dd</span>&gt;</span><span class="tag">&lt;/<span class="name">dd</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dl</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>然后写样式。<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;style type="text/css"&gt;</span><br><span class="line"><span class="selector-class">.comment</span> &#123;</span><br><span class="line">    <span class="attribute">background-color</span>: <span class="number">#c40000</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#fff</span>;</span><br><span class="line">    <span class="attribute">margin-left</span>: <span class="number">10px</span>;</span><br><span class="line">    <span class="attribute">position</span>: relative;</span><br><span class="line">    <span class="attribute">z-index</span>: <span class="number">10</span>;</span><br><span class="line">    <span class="attribute">display</span>: inline-block;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">178px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">38px</span>;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#c40000</span>;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">14px</span>;</span><br><span class="line">    <span class="attribute">line-height</span>: <span class="number">38px</span>;</span><br><span class="line">    <span class="attribute">text-align</span>: center;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure></p>
<p>以及提交评论的js代码。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取评论</span></span><br><span class="line">$.ajax(&#123;</span><br><span class="line">    url: <span class="string">'/comment/comment/'</span> + $(<span class="string">'#comment-input'</span>).data(<span class="string">'bookid'</span>),</span><br><span class="line">    success: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (res.code === <span class="number">200</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> data = res.data;</span><br><span class="line">            <span class="built_in">console</span>.log(data);</span><br><span class="line">            <span class="keyword">var</span> div_head = <span class="string">'&lt;div&gt;'</span>;</span><br><span class="line">            <span class="keyword">var</span> div_tail = <span class="string">'&lt;/div&gt;'</span>;</span><br><span class="line">            <span class="keyword">var</span> dom_element = <span class="string">''</span></span><br><span class="line">            <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; data.length; i++) &#123;</span><br><span class="line">                <span class="keyword">var</span> head = <span class="string">'&lt;div&gt;'</span>;</span><br><span class="line">                <span class="keyword">var</span> tail = <span class="string">'&lt;/div&gt;'</span>;</span><br><span class="line">                <span class="keyword">var</span> temp = head + <span class="string">'&lt;span&gt;'</span> + data[i].user_id + <span class="string">'&lt;/span&gt;'</span> + <span class="string">'&lt;br&gt;'</span> + <span class="string">'&lt;span&gt;'</span> + data[i].content + <span class="string">'&lt;/span&gt;'</span> + tail;</span><br><span class="line">                dom_element += temp;</span><br><span class="line">            &#125;</span><br><span class="line">            dom_element = div_head + dom_element + div_tail;</span><br><span class="line">            $(<span class="string">'#book_comment'</span>).append(dom_element);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">$(<span class="string">'#detail'</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    $(<span class="keyword">this</span>).addClass(<span class="string">'active'</span>);</span><br><span class="line">    $(<span class="string">'#comment'</span>).removeClass(<span class="string">'active'</span>);</span><br><span class="line">    $(<span class="string">'#book_comment'</span>).hide();</span><br><span class="line">    $(<span class="string">'#book_detail'</span>).show();</span><br><span class="line">&#125;)</span><br><span class="line">$(<span class="string">'#comment'</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    $(<span class="keyword">this</span>).addClass(<span class="string">'active'</span>);</span><br><span class="line">    $(<span class="string">'#detail'</span>).removeClass(<span class="string">'active'</span>);</span><br><span class="line">    $(<span class="string">'#book_comment'</span>).show();</span><br><span class="line">    $(<span class="string">'#book_detail'</span>).hide();</span><br><span class="line">&#125;)</span><br><span class="line">$(<span class="string">'#write-comment'</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    $(<span class="string">'#comment-input'</span>).show();</span><br><span class="line">&#125;)</span><br><span class="line">$(<span class="string">'#submit-comment'</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> book_id = $(<span class="string">'#comment-input'</span>).data(<span class="string">'bookid'</span>);</span><br><span class="line">    <span class="keyword">var</span> user_id = $(<span class="string">'#comment-input'</span>).data(<span class="string">'userid'</span>);</span><br><span class="line">    <span class="keyword">var</span> content = $(<span class="string">'#comment-input input'</span>).val();</span><br><span class="line">    <span class="keyword">var</span> data = &#123;</span><br><span class="line">        book_id: book_id,</span><br><span class="line">        user_id: user_id,</span><br><span class="line">        content: content,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'content: '</span>, content);</span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">        type: <span class="string">'POST'</span>,</span><br><span class="line">        url: <span class="string">'/comment/comment/'</span> + book_id + <span class="string">'/'</span>,</span><br><span class="line">        data: <span class="built_in">JSON</span>.stringify(data),</span><br><span class="line">        success: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (res.code === <span class="number">200</span>) &#123;</span><br><span class="line">                <span class="comment">// console.log('res: ', res)</span></span><br><span class="line">                $(<span class="string">'#comment-input'</span>).hide();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>这样评论功能就做好了。</p>
<h1 id="9，发送邮件功能实现。"><a href="#9，发送邮件功能实现。" class="headerlink" title="9，发送邮件功能实现。"></a><a id="9">9，发送邮件功能实现。</a></h1><h2 id="1，同步发送邮件"><a href="#1，同步发送邮件" class="headerlink" title="1，同步发送邮件"></a>1，同步发送邮件</h2><p>先在配置文件中配置邮件相关参数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># settings.py</span></span><br><span class="line">EMAIL_BACKEND = <span class="string">'django.core.mail.backends.smtp.EmailBackend'</span></span><br><span class="line">EMAIL_HOST = <span class="string">'smtp.126.com'</span></span><br><span class="line"><span class="comment"># 126和163邮箱的SMTP端口为25； QQ邮箱使用的SMTP端口为465</span></span><br><span class="line">EMAIL_PORT = <span class="number">25</span></span><br><span class="line"><span class="comment"># 如果使用QQ邮箱发送邮件，需要开启SSL加密, 如果在aliyun上部署，也需要开启ssl加密，同时修改端口为EMAIL_PORT = 465</span></span><br><span class="line"><span class="comment"># EMAIL_USE_SSL = True</span></span><br><span class="line"><span class="comment"># 发送邮件的邮箱</span></span><br><span class="line">EMAIL_HOST_USER = <span class="string">'xxxxxxxx@126.com'</span></span><br><span class="line"><span class="comment"># 在邮箱中设置的客户端授权密码</span></span><br><span class="line">EMAIL_HOST_PASSWORD = <span class="string">'xxxxxxxx'</span></span><br><span class="line"><span class="comment"># 收件人看到的发件人</span></span><br><span class="line">EMAIL_FROM = <span class="string">'shangguigu&lt;xxxxxxxx@126.com&gt;'</span></span><br></pre></td></tr></table></figure>
<p>在注册页的视图函数里写发邮件的代码。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># users/views.py</span></span><br><span class="line"><span class="keyword">from</span> itsdangerous <span class="keyword">import</span> TimedJSONWebSignatureSerializer <span class="keyword">as</span> Serializer</span><br><span class="line"><span class="keyword">from</span> itsdangerous <span class="keyword">import</span> SignatureExpired</span><br></pre></td></tr></table></figure></p>
<p>itsdangerous是一个产生token的库，有flask的作者编写。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register_handle</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="string">'''进行用户注册处理'''</span></span><br><span class="line">    <span class="comment"># 接收数据</span></span><br><span class="line">    username = request.POST.get(<span class="string">'user_name'</span>)</span><br><span class="line">    password = request.POST.get(<span class="string">'pwd'</span>)</span><br><span class="line">    email = request.POST.get(<span class="string">'email'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 进行数据校验</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> all([username, password, email]):</span><br><span class="line">        <span class="comment"># 有数据为空</span></span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">'users/register.html'</span>, &#123;<span class="string">'errmsg'</span>:<span class="string">'参数不能为空!'</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 判断邮箱是否合法</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> re.match(<span class="string">r'^[a-z0-9][\w\.\-]*@[a-z0-9\-]+(\.[a-z]&#123;2,5&#125;)&#123;1,2&#125;$'</span>, email):</span><br><span class="line">        <span class="comment"># 邮箱不合法</span></span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">'users/register.html'</span>, &#123;<span class="string">'errmsg'</span>:<span class="string">'邮箱不合法!'</span>&#125;)</span><br><span class="line"></span><br><span class="line">    p = Passport.objects.check_passport(username=username)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> p:</span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">'users/register.html'</span>, &#123;<span class="string">'errmsg'</span>: <span class="string">'用户名已存在！'</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 进行业务处理:注册，向账户系统中添加账户</span></span><br><span class="line">    <span class="comment"># Passport.objects.create(username=username, password=password, email=email)</span></span><br><span class="line">    passport = Passport.objects.add_one_passport(username=username, password=password, email=email)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 生成激活的token itsdangerous</span></span><br><span class="line">    serializer = Serializer(settings.SECRET_KEY, <span class="number">3600</span>)</span><br><span class="line">    token = serializer.dumps(&#123;<span class="string">'confirm'</span>:passport.id&#125;) <span class="comment"># 返回bytes</span></span><br><span class="line">    token = token.decode()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 给用户的邮箱发激活邮件</span></span><br><span class="line">    send_mail(<span class="string">'尚硅谷书城用户激活'</span>, <span class="string">''</span>, settings.EMAIL_FROM, [email], html_message=<span class="string">'&lt;a href="http://127.0.0.1:8000/user/active/%s/"&gt;http://127.0.0.1:8000/user/active/&lt;/a&gt;'</span> % token)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 注册完，还是返回注册页。</span></span><br><span class="line">    <span class="keyword">return</span> redirect(reverse(<span class="string">'books:index'</span>))</span><br></pre></td></tr></table></figure></p>
<p>register_handle函数变为以上代码，增加了发送邮件的功能。注意这里我们没有实现check_passport函数。所以要在<code>users/models.py</code>中的<code>PassportManager</code>中实现这个函数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PassportManager</span><span class="params">(models.Manager)</span>:</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">check_passport</span><span class="params">(self, username)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            passport = self.get(username=username)</span><br><span class="line">        <span class="keyword">except</span> self.model.DoesNotExist:</span><br><span class="line">            passport = <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">if</span> passport:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">False</span></span><br></pre></td></tr></table></figure>
<h2 id="2，使用消息队列celery来异步发送邮件。"><a href="#2，使用消息队列celery来异步发送邮件。" class="headerlink" title="2，使用消息队列celery来异步发送邮件。"></a>2，使用消息队列celery来异步发送邮件。</h2><p>首先配置celery。在bookstore文件夹下面。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># bookstore/celery.py</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> celery <span class="keyword">import</span> Celery</span><br><span class="line"></span><br><span class="line"><span class="comment"># set the default Django settings module for the 'celery' program.</span></span><br><span class="line">os.environ.setdefault(<span class="string">'DJANGO_SETTINGS_MODULE'</span>, <span class="string">'bookstore.settings'</span>)</span><br><span class="line"></span><br><span class="line">app = Celery(<span class="string">'bookstore'</span>, broker=<span class="string">'redis://127.0.0.1:6379/6'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Using a string here means the worker doesn't have to serialize</span></span><br><span class="line"><span class="comment"># the configuration object to child processes.</span></span><br><span class="line"><span class="comment"># - namespace='CELERY' means all celery-related configuration keys</span></span><br><span class="line"><span class="comment">#   should have a `CELERY_` prefix.</span></span><br><span class="line">app.config_from_object(<span class="string">'django.conf:settings'</span>, namespace=<span class="string">'CELERY'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Load task modules from all registered Django app configs.</span></span><br><span class="line">app.autodiscover_tasks()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.task(bind=True)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug_task</span><span class="params">(self)</span>:</span></span><br><span class="line">    print(<span class="string">'Request: &#123;0!r&#125;'</span>.format(self.request))</span><br></pre></td></tr></table></figure></p>
<p>然后在users app中编写异步任务。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># users/tasks.py</span></span><br><span class="line"><span class="keyword">from</span> celery <span class="keyword">import</span> shared_task</span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"><span class="keyword">from</span> django.core.mail <span class="keyword">import</span> send_mail</span><br><span class="line"></span><br><span class="line"><span class="meta">@shared_task</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_active_email</span><span class="params">(token, username, email)</span>:</span></span><br><span class="line">    <span class="string">'''发送激活邮件'''</span></span><br><span class="line">    subject = <span class="string">'尚硅谷书城用户激活'</span> <span class="comment"># 标题</span></span><br><span class="line">    message = <span class="string">''</span></span><br><span class="line">    sender = settings.EMAIL_FROM <span class="comment"># 发件人</span></span><br><span class="line">    receiver = [email] <span class="comment"># 收件人列表</span></span><br><span class="line">    html_message = <span class="string">'&lt;a href="http://127.0.0.1:8000/user/active/%s/"&gt;http://127.0.0.1:8000/user/active/&lt;/a&gt;'</span>%token</span><br><span class="line">    send_mail(subject, message, sender, receiver, html_message=html_message)</span><br></pre></td></tr></table></figure></p>
<p>然后在视图函数中导入异步任务。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> users.tasks <span class="keyword">import</span> send_active_email</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register_handle</span><span class="params">(request)</span>:</span></span><br><span class="line">    ...</span><br><span class="line">    send_active_email.delay(token, username, email)</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure></p>
<p>然后改写根应用文件夹里的<strong>init</strong>.py，将整个文件改为：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line">pymysql.install_as_MySQLdb()</span><br><span class="line"><span class="comment"># This will make sure the app is always imported when</span></span><br><span class="line"><span class="comment"># Django starts so that shared_task will use this app.</span></span><br><span class="line"><span class="keyword">from</span> .celery <span class="keyword">import</span> app <span class="keyword">as</span> celery_app</span><br><span class="line"></span><br><span class="line">__all__ = [<span class="string">'celery_app'</span>]</span><br></pre></td></tr></table></figure></p>
<p>然后运行:(在根目录，和manage.py同级)<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ celery -A <span class="keyword">bookstore </span>worker -l <span class="meta">info</span></span><br></pre></td></tr></table></figure></p>
<h1 id="10，登陆验证码功能实现"><a href="#10，登陆验证码功能实现" class="headerlink" title="10，登陆验证码功能实现"></a><a id="10">10，登陆验证码功能实现</a></h1><p>将项目中的<code>Ubuntu-RI.ttf</code>字体文件拷贝到你的项目的根目录下面。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># users/views.py</span></span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">verifycode</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="comment">#引入绘图模块</span></span><br><span class="line">    <span class="keyword">from</span> PIL <span class="keyword">import</span> Image, ImageDraw, ImageFont</span><br><span class="line">    <span class="comment">#引入随机函数模块</span></span><br><span class="line">    <span class="keyword">import</span> random</span><br><span class="line">    <span class="comment">#定义变量，用于画面的背景色、宽、高</span></span><br><span class="line">    bgcolor = (random.randrange(<span class="number">20</span>, <span class="number">100</span>), random.randrange(</span><br><span class="line">        <span class="number">20</span>, <span class="number">100</span>), <span class="number">255</span>)</span><br><span class="line">    width = <span class="number">100</span></span><br><span class="line">    height = <span class="number">25</span></span><br><span class="line">    <span class="comment">#创建画面对象</span></span><br><span class="line">    im = Image.new(<span class="string">'RGB'</span>, (width, height), bgcolor)</span><br><span class="line">    <span class="comment">#创建画笔对象</span></span><br><span class="line">    draw = ImageDraw.Draw(im)</span><br><span class="line">    <span class="comment">#调用画笔的point()函数绘制噪点</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">100</span>):</span><br><span class="line">        xy = (random.randrange(<span class="number">0</span>, width), random.randrange(<span class="number">0</span>, height))</span><br><span class="line">        fill = (random.randrange(<span class="number">0</span>, <span class="number">255</span>), <span class="number">255</span>, random.randrange(<span class="number">0</span>, <span class="number">255</span>))</span><br><span class="line">        draw.point(xy, fill=fill)</span><br><span class="line">    <span class="comment">#定义验证码的备选值</span></span><br><span class="line">    str1 = <span class="string">'ABCD123EFGHIJK456LMNOPQRS789TUVWXYZ0'</span></span><br><span class="line">    <span class="comment">#随机选取4个值作为验证码</span></span><br><span class="line">    rand_str = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">4</span>):</span><br><span class="line">        rand_str += str1[random.randrange(<span class="number">0</span>, len(str1))]</span><br><span class="line">    <span class="comment">#构造字体对象</span></span><br><span class="line">    font = ImageFont.truetype(os.path.join(settings.BASE_DIR, <span class="string">"Ubuntu-RI.ttf"</span>), <span class="number">15</span>)</span><br><span class="line">    <span class="comment">#构造字体颜色</span></span><br><span class="line">    fontcolor = (<span class="number">255</span>, random.randrange(<span class="number">0</span>, <span class="number">255</span>), random.randrange(<span class="number">0</span>, <span class="number">255</span>))</span><br><span class="line">    <span class="comment">#绘制4个字</span></span><br><span class="line">    draw.text((<span class="number">5</span>, <span class="number">2</span>), rand_str[<span class="number">0</span>], font=font, fill=fontcolor)</span><br><span class="line">    draw.text((<span class="number">25</span>, <span class="number">2</span>), rand_str[<span class="number">1</span>], font=font, fill=fontcolor)</span><br><span class="line">    draw.text((<span class="number">50</span>, <span class="number">2</span>), rand_str[<span class="number">2</span>], font=font, fill=fontcolor)</span><br><span class="line">    draw.text((<span class="number">75</span>, <span class="number">2</span>), rand_str[<span class="number">3</span>], font=font, fill=fontcolor)</span><br><span class="line">    <span class="comment">#释放画笔</span></span><br><span class="line">    <span class="keyword">del</span> draw</span><br><span class="line">    <span class="comment">#存入session，用于做进一步验证</span></span><br><span class="line">    request.session[<span class="string">'verifycode'</span>] = rand_str</span><br><span class="line">    <span class="comment">#内存文件操作</span></span><br><span class="line">    <span class="keyword">import</span> io</span><br><span class="line">    buf = io.BytesIO()</span><br><span class="line">    <span class="comment">#将图片保存在内存中，文件类型为png</span></span><br><span class="line">    im.save(buf, <span class="string">'png'</span>)</span><br><span class="line">    <span class="comment">#将内存中的图片数据返回给客户端，MIME类型为图片png</span></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(buf.getvalue(), <span class="string">'image/png'</span>)</span><br></pre></td></tr></table></figure>
<p>然后在urls.py中配置url。<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url(<span class="string">r'^verifycode/$'</span>, views.verifycode, name=<span class="string">'verifycode'</span>), <span class="comment"># 验证码功能</span></span><br></pre></td></tr></table></figure></p>
<p>编写前端代码。在前段代码中的Form里添加以下代码。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// templates/users/login.html</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"top: 100px; position: absolute;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">id</span>=<span class="string">"vc"</span> <span class="attr">name</span>=<span class="string">"vc"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">'verifycode'</span> <span class="attr">src</span>=<span class="string">"/user/verifycode/"</span> <span class="attr">onclick</span>=<span class="string">"this.src='/user/verifycode/?'+Math.random()"</span> <span class="attr">alt</span>=<span class="string">"CheckCode"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>前端需要向后端post数据。post以下数据<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> username = $(<span class="string">'#username'</span>).val()</span><br><span class="line"><span class="keyword">var</span> password = $(<span class="string">'#pwd'</span>).val()</span><br><span class="line"><span class="keyword">var</span> csrf = $(<span class="string">'input[name="csrfmiddlewaretoken"]'</span>).val()</span><br><span class="line"><span class="keyword">var</span> remember = $(<span class="string">'input[name="remember"]'</span>).prop(<span class="string">'checked'</span>)</span><br><span class="line"><span class="keyword">var</span> vc = $(<span class="string">'input[name="vc"]'</span>).val()</span><br><span class="line"><span class="comment">// 发起ajax请求</span></span><br><span class="line"><span class="keyword">var</span> params = &#123;</span><br><span class="line">    <span class="string">'username'</span>: username,</span><br><span class="line">    <span class="string">'password'</span>: password,</span><br><span class="line">    <span class="string">'csrfmiddlewaretoken'</span>: csrf,</span><br><span class="line">    <span class="string">'remember'</span>: remember,</span><br><span class="line">    <span class="string">'verifycode'</span>: vc,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后在后端进行校验。login_check函数改为以下代码实现。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login_check</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="string">'''进行用户登录校验'''</span></span><br><span class="line">    <span class="comment"># 1.获取数据</span></span><br><span class="line">    username = request.POST.get(<span class="string">'username'</span>)</span><br><span class="line">    password = request.POST.get(<span class="string">'password'</span>)</span><br><span class="line">    remember = request.POST.get(<span class="string">'remember'</span>)</span><br><span class="line">    verifycode = request.POST.get(<span class="string">'verifycode'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2.数据校验</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> all([username, password, remember, verifycode]):</span><br><span class="line">        <span class="comment"># 有数据为空</span></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'res'</span>: <span class="number">2</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> verifycode.upper() != request.session[<span class="string">'verifycode'</span>]:</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'res'</span>: <span class="number">2</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3.进行处理:根据用户名和密码查找账户信息</span></span><br><span class="line">    passport = Passport.objects.get_one_passport(username=username, password=password)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> passport:</span><br><span class="line">        <span class="comment"># 用户名密码正确</span></span><br><span class="line">        <span class="comment"># 获取session中的url_path</span></span><br><span class="line">        <span class="comment"># if request.session.has_key('url_path'):</span></span><br><span class="line">        <span class="comment">#     next_url = request.session.get('url_path')</span></span><br><span class="line">        <span class="comment"># else:</span></span><br><span class="line">        <span class="comment">#     next_url = reverse('books:index')</span></span><br><span class="line">        next_url = reverse(<span class="string">'books:index'</span>) <span class="comment"># /user/</span></span><br><span class="line">        jres = JsonResponse(&#123;<span class="string">'res'</span>: <span class="number">1</span>, <span class="string">'next_url'</span>: next_url&#125;)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 判断是否需要记住用户名</span></span><br><span class="line">        <span class="keyword">if</span> remember == <span class="string">'true'</span>:</span><br><span class="line">            <span class="comment"># 记住用户名</span></span><br><span class="line">            jres.set_cookie(<span class="string">'username'</span>, username, max_age=<span class="number">7</span>*<span class="number">24</span>*<span class="number">3600</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 不要记住用户名</span></span><br><span class="line">            jres.delete_cookie(<span class="string">'username'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 记住用户的登录状态</span></span><br><span class="line">        request.session[<span class="string">'islogin'</span>] = <span class="keyword">True</span></span><br><span class="line">        request.session[<span class="string">'username'</span>] = username</span><br><span class="line">        request.session[<span class="string">'passport_id'</span>] = passport.id</span><br><span class="line">        <span class="keyword">return</span> jres</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># 用户名或密码错误</span></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'res'</span>: <span class="number">0</span>&#125;)</span><br></pre></td></tr></table></figure></p>
<p>那我们的验证码功能就实现了。</p>
<h1 id="11，全文检索的实现"><a href="#11，全文检索的实现" class="headerlink" title="11，全文检索的实现"></a><a id="11">11，全文检索的实现</a></h1><p>添加全文检索应用，在配置文件中。<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = (</span><br><span class="line">    ...</span><br><span class="line">    <span class="string">'haystack'</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>在配置文件中写入以下配置。<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 全文检索配置</span></span><br><span class="line">HAYSTACK_CONNECTIONS = &#123;</span><br><span class="line">    <span class="string">'default'</span>: &#123;</span><br><span class="line">        <span class="comment"># 使用whoosh引擎</span></span><br><span class="line">        <span class="comment"># 'ENGINE': 'haystack.backends.whoosh_cn_backend.WhooshEngine',</span></span><br><span class="line">        <span class="string">'ENGINE'</span>: <span class="string">'haystack.backends.whoosh_backend.WhooshEngine'</span>,</span><br><span class="line">        <span class="comment"># 索引文件路径</span></span><br><span class="line">        <span class="string">'PATH'</span>: os.path.join(BASE_DIR, <span class="string">'whoosh_index'</span>),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 当添加、修改、删除数据时，自动生成索引</span></span><br><span class="line">HAYSTACK_SIGNAL_PROCESSOR = <span class="string">'haystack.signals.RealtimeSignalProcessor'</span></span><br><span class="line"></span><br><span class="line">HAYSTACK_SEARCH_RESULTS_PER_PAGE = <span class="number">6</span> <span class="comment"># 指定搜索结果每页的条数</span></span><br></pre></td></tr></table></figure></p>
<p>在urls.py中配置。<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">    ...</span><br><span class="line">    url(<span class="string">r'^search/'</span>, include(<span class="string">'haystack.urls'</span>)),</span><br><span class="line">]</span><br></pre></td></tr></table></figure></p>
<p>在books应用目录下建立search_indexes.py文件。<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> haystack <span class="keyword">import</span> indexes</span><br><span class="line"><span class="keyword">from</span> books.models <span class="keyword">import</span> Books</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定对于某个类的某些数据建立索引, 一般类名:模型类名+Index</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BooksIndex</span><span class="params">(indexes.SearchIndex, indexes.Indexable)</span>:</span></span><br><span class="line">    <span class="comment"># 指定根据表中的哪些字段建立索引:比如:商品名字 商品描述</span></span><br><span class="line">    text = indexes.CharField(document=<span class="keyword">True</span>, use_template=<span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_model</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> Books</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">index_queryset</span><span class="params">(self, using=None)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.get_model().objects.all()</span><br></pre></td></tr></table></figure></p>
<p>在目录“templates/search/indexes/books/”下创建“books_text.txt”文件<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-variable">&#123;&#123; object.name &#125;&#125;</span> <span class="comment"># 根据书籍的名称建立索引</span></span><br><span class="line"><span class="template-variable">&#123;&#123; object.desc &#125;&#125;</span> <span class="comment"># 根据书籍的描述建立索引</span></span><br><span class="line"><span class="template-variable">&#123;&#123; object.detail &#125;&#125;</span> <span class="comment"># 根据书籍的详情建立索引</span></span><br></pre></td></tr></table></figure></p>
<p>在目录“templates/search/”下建立search.html。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends 'base.html' %&#125;</span><br><span class="line">&#123;% load staticfiles %&#125;</span><br><span class="line">&#123;% block title %&#125;尚硅谷书城-书籍搜索结果列表&#123;% endblock title %&#125;</span><br><span class="line">&#123;% block body %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"breadcrumb"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>&#123;&#123; query &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span>&gt;</span>&gt;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>搜索结果如下:<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"main_wrap clearfix"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"book_type_list clearfix"</span>&gt;</span></span><br><span class="line">                &#123;% for item in page %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'books:detail' books_id=item.object.id %&#125;"</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&#123;% static item.object.image %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">h4</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'books:detail' books_id=item.object.id %&#125;"</span>&gt;</span>&#123;&#123; item.object.name &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"operate"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"price"</span>&gt;</span>￥&#123;&#123; item.object.price &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"unit"</span>&gt;</span>&#123;&#123; item.object.unit &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span> <span class="attr">class</span>=<span class="string">"add_books"</span> <span class="attr">title</span>=<span class="string">"加入购物车"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                &#123;% endfor %&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"pagenation"</span>&gt;</span></span><br><span class="line">                &#123;% if page.has_previous %&#125;</span><br><span class="line">                    &lt;a href="/search/?q=&#123;&#123; query &#125;&#125;&amp;page=&#123;&#123; page.previous_page_number &#125;&#125;"&gt;&lt;上一页&lt;/a&gt;</span><br><span class="line">                &#123;% endif %&#125;</span><br><span class="line">                &#123;% for pindex in paginator.page_range %&#125;</span><br><span class="line">                    &#123;% if pindex == page.number %&#125;</span><br><span class="line">                        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/search/?q=&#123;&#123; query &#125;&#125;&amp;page=&#123;&#123; pindex &#125;&#125;"</span> <span class="attr">class</span>=<span class="string">"active"</span>&gt;</span>&#123;&#123; pindex &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                    &#123;% else %&#125;</span><br><span class="line">                        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/search/?q=&#123;&#123; query &#125;&#125;&amp;page=&#123;&#123; pindex &#125;&#125;"</span>&gt;</span>&#123;&#123; pindex &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                    &#123;% endif %&#125;</span><br><span class="line">                &#123;% endfor %&#125;</span><br><span class="line">                &#123;% if page.has_next %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/search/?q=&#123;&#123; query &#125;&#125;&amp;page=&#123;&#123; page.next_page_number &#125;&#125;"</span>&gt;</span>下一页&gt;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                &#123;% endif %&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endblock body %&#125;</span><br></pre></td></tr></table></figure></p>
<p>建立ChineseAnalyzer.py文件。<br>保存在haystack的安装文件夹下，路径如“/home/python/.virtualenvs/django_py2/lib/python3.5/site-packages/haystack/backends”<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jieba</span><br><span class="line"><span class="keyword">from</span> whoosh.analysis <span class="keyword">import</span> Tokenizer, Token</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChineseTokenizer</span><span class="params">(Tokenizer)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, value, positions=False, chars=False,</span></span></span><br><span class="line"><span class="function"><span class="params">                 keeporiginal=False, removestops=True,</span></span></span><br><span class="line"><span class="function"><span class="params">                 start_pos=<span class="number">0</span>, start_char=<span class="number">0</span>, mode=<span class="string">''</span>, **kwargs)</span>:</span></span><br><span class="line">        t = Token(positions, chars, removestops=removestops, mode=mode,</span><br><span class="line">                  **kwargs)</span><br><span class="line">        seglist = jieba.cut(value, cut_all=<span class="keyword">True</span>)</span><br><span class="line">        <span class="keyword">for</span> w <span class="keyword">in</span> seglist:</span><br><span class="line">            t.original = t.text = w</span><br><span class="line">            t.boost = <span class="number">1.0</span></span><br><span class="line">            <span class="keyword">if</span> positions:</span><br><span class="line">                t.pos = start_pos + value.find(w)</span><br><span class="line">            <span class="keyword">if</span> chars:</span><br><span class="line">                t.startchar = start_char + value.find(w)</span><br><span class="line">                t.endchar = start_char + value.find(w) + len(w)</span><br><span class="line">            <span class="keyword">yield</span> t</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ChineseAnalyzer</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> ChineseTokenizer()</span><br></pre></td></tr></table></figure></p>
<p>复制whoosh_backend.py文件，改名为whoosh_cn_backend.py<br>注意：复制出来的文件名，末尾会有一个空格，记得要删除这个空格<br>然后将下面这一行代码写入<code>whoosh_cn_backend.py</code>文件中。<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .ChineseAnalyzer <span class="keyword">import</span> ChineseAnalyzer</span><br></pre></td></tr></table></figure></p>
<p>然后查找下面的这一行代码<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">analyzer=StemmingAnalyzer()</span><br></pre></td></tr></table></figure></p>
<p>改为<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">analyzer=ChineseAnalyzer()</span><br></pre></td></tr></table></figure></p>
<p>生成索引<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python manage.py rebuild_index</span><br></pre></td></tr></table></figure></p>
<p>在模板<code>base.html</code>中创建搜索栏<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="selector-tag">form</span> method=<span class="string">'get'</span> action=<span class="string">"/search/"</span> target=<span class="string">"_blank"</span>&gt;</span><br><span class="line">    &lt;<span class="selector-tag">input</span> type=<span class="string">"text"</span> name=<span class="string">"q"</span>&gt;</span><br><span class="line">    &lt;<span class="selector-tag">input</span> type=<span class="string">"submit"</span> value=<span class="string">"查询"</span>&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure></p>
<h1 id="12，用户激活功能的实现"><a href="#12，用户激活功能的实现" class="headerlink" title="12，用户激活功能的实现"></a><a id="12">12，用户激活功能的实现</a></h1><p>首先编写视图函数：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register_active</span><span class="params">(request, token)</span>:</span></span><br><span class="line">    <span class="string">'''用户账户激活'''</span></span><br><span class="line">    serializer = Serializer(settings.SECRET_KEY, <span class="number">3600</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        info = serializer.loads(token)</span><br><span class="line">        passport_id = info[<span class="string">'confirm'</span>]</span><br><span class="line">        <span class="comment"># 进行用户激活</span></span><br><span class="line">        passport = Passport.objects.get(id=passport_id)</span><br><span class="line">        passport.is_active = <span class="keyword">True</span></span><br><span class="line">        passport.save()</span><br><span class="line">        <span class="comment"># 跳转的登录页</span></span><br><span class="line">        <span class="keyword">return</span> redirect(reverse(<span class="string">'user:login'</span>))</span><br><span class="line">    <span class="keyword">except</span> SignatureExpired:</span><br><span class="line">        <span class="comment"># 链接过期</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">'激活链接已过期'</span>)</span><br></pre></td></tr></table></figure></p>
<p>然后配置url就完成了。<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url(<span class="string">r'^active/(?P&lt;token&gt;.*)/$'</span>, views.register_active, name=<span class="string">'active'</span>), <span class="comment"># 用户激活</span></span><br></pre></td></tr></table></figure></p>
<h1 id="13，用户中心最近浏览功能的实现"><a href="#13，用户中心最近浏览功能的实现" class="headerlink" title="13，用户中心最近浏览功能的实现"></a><a id="13">13，用户中心最近浏览功能的实现</a></h1><p>最近浏览使用redis实现。重新编写books/views.py中的detail函数，每次点击商品，都将商品信息写入redis，作为最近浏览的数据。<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># books/views.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">detail</span><span class="params">(request, books_id)</span>:</span></span><br><span class="line">    <span class="string">'''显示商品的详情页面'''</span></span><br><span class="line">    <span class="comment"># 获取商品的详情信息</span></span><br><span class="line">    books = Books.objects.get_books_by_id(books_id=books_id)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> books <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">        <span class="comment"># 商品不存在，跳转到首页</span></span><br><span class="line">        <span class="keyword">return</span> redirect(reverse(<span class="string">'books:index'</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 新品推荐</span></span><br><span class="line">    books_li = Books.objects.get_books_by_type(type_id=books.type_id, limit=<span class="number">2</span>, sort=<span class="string">'new'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 用户登录之后，才记录浏览记录</span></span><br><span class="line">    <span class="comment"># 每个用户浏览记录对应redis中的一条信息 格式:'history_用户id':[10,9,2,3,4]</span></span><br><span class="line">    <span class="comment"># [9, 10, 2, 3, 4]</span></span><br><span class="line">    <span class="keyword">if</span> request.session.has_key(<span class="string">'islogin'</span>):</span><br><span class="line">        <span class="comment"># 用户已登录，记录浏览记录</span></span><br><span class="line">        con = get_redis_connection(<span class="string">'default'</span>)</span><br><span class="line">        key = <span class="string">'history_%d'</span> % request.session.get(<span class="string">'passport_id'</span>)</span><br><span class="line">        <span class="comment"># 先从redis列表中移除books.id</span></span><br><span class="line">        con.lrem(key, <span class="number">0</span>, books.id)</span><br><span class="line">        con.lpush(key, books.id)</span><br><span class="line">        <span class="comment"># 保存用户最近浏览的5个商品</span></span><br><span class="line">        con.ltrim(key, <span class="number">0</span>, <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 定义上下文</span></span><br><span class="line">    context = &#123;<span class="string">'books'</span>: books, <span class="string">'books_li'</span>: books_li&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 使用模板</span></span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'books/detail.html'</span>, context)</span><br></pre></td></tr></table></figure></p>
<p>然后重写用户中心的视图函数代码：users/views.py中的user函数。<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">user</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="string">'''用户中心-信息页'''</span></span><br><span class="line">    passport_id = request.session.get(<span class="string">'passport_id'</span>)</span><br><span class="line">    <span class="comment"># 获取用户的基本信息</span></span><br><span class="line">    addr = Address.objects.get_default_address(passport_id=passport_id)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取用户的最近浏览信息</span></span><br><span class="line">    con = get_redis_connection(<span class="string">'default'</span>)</span><br><span class="line">    key = <span class="string">'history_%d'</span> % passport_id</span><br><span class="line">    <span class="comment"># 取出用户最近浏览的5个商品的id</span></span><br><span class="line">    history_li = con.lrange(key, <span class="number">0</span>, <span class="number">4</span>)</span><br><span class="line">    <span class="comment"># history_li = [21,20,11]</span></span><br><span class="line">    <span class="comment"># print(history_li)</span></span><br><span class="line">    <span class="comment"># 查询数据库,获取用户最近浏览的商品信息</span></span><br><span class="line">    <span class="comment"># books_li = Books.objects.filter(id__in=history_li)</span></span><br><span class="line">    books_li = []</span><br><span class="line">    <span class="keyword">for</span> id <span class="keyword">in</span> history_li:</span><br><span class="line">        books = Books.objects.get_books_by_id(books_id=id)</span><br><span class="line">        books_li.append(books)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'users/user_center_info.html'</span>, &#123;<span class="string">'addr'</span>: addr,</span><br><span class="line">                                                           <span class="string">'page'</span>: <span class="string">'user'</span>,</span><br><span class="line">                                                           <span class="string">'books_li'</span>: books_li&#125;)</span><br></pre></td></tr></table></figure></p>
<p>然后编写前端页面。重写user_center_info.html中最近浏览下面的html内容。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h3</span> <span class="attr">class</span>=<span class="string">"common_title2"</span>&gt;</span>最近浏览<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"has_view_list"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"book_type_list clearfix"</span>&gt;</span></span><br><span class="line">        &#123;% for books in books_li %&#125;</span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'books:detail' books_id=books.id %&#125;"</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&#123;% static books.image %&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h4</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'books:detail' books_id=books.id %&#125;"</span>&gt;</span>&#123;&#123; books.name &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"operate"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"price"</span>&gt;</span>￥&#123;&#123; books.price &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"unit"</span>&gt;</span>&#123;&#123; books.unit &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span> <span class="attr">class</span>=<span class="string">"add_books"</span> <span class="attr">title</span>=<span class="string">"加入购物车"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        &#123;% endfor %&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>最近浏览功能就实现了。</p>
<h1 id="14，前端过滤器实现"><a href="#14，前端过滤器实现" class="headerlink" title="14，前端过滤器实现"></a><a id="14">14，前端过滤器实现</a></h1><p>在users文件夹中新建templatetags文件夹。然后新建<strong>init</strong>.py文件，这是空文件。然后新建filters.py文件。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.template <span class="keyword">import</span> Library</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个Library类的对象</span></span><br><span class="line">register = Library()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个过滤器函数</span></span><br><span class="line"><span class="meta">@register.filter</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">order_status</span><span class="params">(status)</span>:</span></span><br><span class="line">    <span class="string">'''返回订单状态对应的字符串'''</span></span><br><span class="line">    status_dict =  &#123;</span><br><span class="line">        <span class="number">1</span>:<span class="string">"待支付"</span>,</span><br><span class="line">        <span class="number">2</span>:<span class="string">"待发货"</span>,</span><br><span class="line">        <span class="number">3</span>:<span class="string">"待收货"</span>,</span><br><span class="line">        <span class="number">4</span>:<span class="string">"待评价"</span>,</span><br><span class="line">        <span class="number">5</span>:<span class="string">"已完成"</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> status_dict[status]</span><br></pre></td></tr></table></figure></p>
<p>然后在根应用settings.py里面添加应用：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = (</span><br><span class="line">    ...</span><br><span class="line">    <span class="string">'users.templatetags.filters'</span>, <span class="comment"># 过滤器功能</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>这样我们就能在前端使用这个过滤器了。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">td</span> <span class="attr">width</span>=<span class="string">"15%"</span>&gt;</span>&#123;&#123; order.status | order_status &#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>注意要在页面里<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% load filters %&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="15，使用gunicorn-nginx-django进行部署"><a href="#15，使用gunicorn-nginx-django进行部署" class="headerlink" title="15，使用gunicorn+nginx+django进行部署"></a><a id="15">15，使用gunicorn+nginx+django进行部署</a></h1><p>安装nginx。<br><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt <span class="keyword">install</span> nginx</span><br></pre></td></tr></table></figure></p>
<p>先看nginx配置文件nginx.conf, 一般情况下, 路径为<code>/etc/nginx/nginx.conf</code><br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">user</span> root;</span><br><span class="line"><span class="attribute">worker_processes</span> auto;</span><br><span class="line"><span class="attribute">pid</span> /run/nginx.pid;</span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">        <span class="attribute">worker_connections</span> <span class="number">768</span>;</span><br><span class="line">        <span class="comment"># multi_accept on;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">##</span></span><br><span class="line">        <span class="comment"># Basic Settings</span></span><br><span class="line">        <span class="comment">##</span></span><br><span class="line"></span><br><span class="line">        <span class="attribute">sendfile</span> <span class="literal">on</span>;</span><br><span class="line">        <span class="attribute">tcp_nopush</span> <span class="literal">on</span>;</span><br><span class="line">        <span class="attribute">tcp_nodelay</span> <span class="literal">on</span>;</span><br><span class="line">        <span class="attribute">keepalive_timeout</span> <span class="number">65</span>;</span><br><span class="line">        <span class="attribute">types_hash_max_size</span> <span class="number">2048</span>;</span><br><span class="line">        <span class="comment"># server_tokens off;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># server_names_hash_bucket_size 64;</span></span><br><span class="line">        <span class="comment"># server_name_in_redirect off;</span></span><br><span class="line"></span><br><span class="line">        <span class="attribute">include</span> /etc/nginx/mime.types;</span><br><span class="line">        <span class="attribute">default_type</span> application/octet-stream;</span><br><span class="line"></span><br><span class="line">        <span class="comment">##</span></span><br><span class="line">        <span class="comment"># SSL Settings</span></span><br><span class="line">        <span class="comment">##</span></span><br><span class="line"></span><br><span class="line">        <span class="attribute">ssl_protocols</span> TLSv1 TLSv1.<span class="number">1</span> TLSv1.<span class="number">2</span>; <span class="comment"># Dropping SSLv3, ref: POODLE</span></span><br><span class="line">        <span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">##</span></span><br><span class="line">        <span class="comment"># Logging Settings</span></span><br><span class="line">        <span class="comment">##</span></span><br><span class="line"></span><br><span class="line">        <span class="attribute">access_log</span> /var/log/nginx/access.log;</span><br><span class="line">        <span class="attribute">error_log</span> /var/log/nginx/error.log;</span><br><span class="line"></span><br><span class="line">        <span class="comment">##</span></span><br><span class="line">        <span class="comment"># Gzip Settings</span></span><br><span class="line">        <span class="comment">##</span></span><br><span class="line"></span><br><span class="line">        <span class="attribute">gzip</span> <span class="literal">on</span>;</span><br><span class="line">        <span class="attribute">gzip_disable</span> <span class="string">"msie6"</span>;</span><br><span class="line">        <span class="comment"># gzip_vary on;</span></span><br><span class="line">        <span class="comment"># gzip_proxied any;</span></span><br><span class="line">        <span class="comment"># gzip_comp_level 6;</span></span><br><span class="line">        <span class="comment"># gzip_buffers 16 8k;</span></span><br><span class="line">        <span class="comment"># gzip_http_version 1.1;</span></span><br><span class="line">        <span class="comment"># gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">##</span></span><br><span class="line">        <span class="comment"># Virtual Host Configs</span></span><br><span class="line">        <span class="comment">##</span></span><br><span class="line"></span><br><span class="line">        <span class="attribute">include</span> /etc/nginx/conf.d/<span class="regexp">*.conf</span>;</span><br><span class="line">        <span class="comment">#include /etc/nginx/sites-enabled/*;</span></span><br><span class="line"></span><br><span class="line">        <span class="section">server</span> &#123;</span><br><span class="line">            <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">            <span class="attribute">server_name</span> localhost;</span><br><span class="line">            <span class="attribute">location</span> / &#123;</span><br><span class="line">                <span class="attribute">proxy_pass</span> http://0.0.0.0:8000;</span><br><span class="line">                <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">                <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">                <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="attribute">error_page</span> <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span> /50x.html;</span><br><span class="line"></span><br><span class="line">            <span class="attribute">location</span> = /50x.html &#123;</span><br><span class="line">                <span class="attribute">root</span> html;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="attribute">location</span> /media &#123;</span><br><span class="line">                <span class="attribute">alias</span> /root/bookstore/bookstore/static;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="attribute">location</span> /static &#123;</span><br><span class="line">                <span class="attribute">alias</span> /root/bookstore/bookstore/collect_static;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果<code>nginx</code>没启动，则执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nginx</span><br></pre></td></tr></table></figure></p>
<p>如果<code>nginx</code>已经启动，则执行以下命令重启<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nginx -s reload</span><br></pre></td></tr></table></figure></p>
<p>然后在根目录bookstore新建文件夹collect_static。<br>注意要在配置文件<code>settings.py</code>中写一行<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">STATIC_ROOT = os.path.join(BASE_DIR, <span class="string">'collect_static'</span>)</span><br></pre></td></tr></table></figure></p>
<p>然后在根目录运行<code>python manage.py collectstatic</code>命令，这个命令用来收集静态文件。<br>并将books/models.py中添加代码：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.core.files.storage <span class="keyword">import</span> FileSystemStorage</span><br><span class="line">fs = FileSystemStorage(location=<span class="string">'/root/bookstore/bookstore/collect_static'</span>)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Books</span><span class="params">(BaseModel)</span>:</span></span><br><span class="line">    ...</span><br><span class="line">    image = models.ImageField(storage=fs, upload_to=<span class="string">'books'</span>, verbose_name=<span class="string">'商品图片'</span>)</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure></p>
<p>然后在根目录运行<code>gunicorn</code>。安装<code>gunicorn</code>，<code>pip install gunicorn</code><br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">nohup</span> <span class="selector-tag">gunicorn</span> <span class="selector-tag">-w</span> 3 <span class="selector-tag">-b</span> 0<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-pseudo">:8000</span> <span class="selector-tag">bookstore</span><span class="selector-class">.wsgi</span><span class="selector-pseudo">:application</span> &amp;</span><br></pre></td></tr></table></figure></p>
<h1 id="16，django日志模块的使用"><a href="#16，django日志模块的使用" class="headerlink" title="16，django日志模块的使用"></a><a id="16">16，django日志模块的使用</a></h1><p>首先将下面的代码添加到配置文件<code>settings.py</code>。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">LOGGING = &#123;</span><br><span class="line">    <span class="string">'version'</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">'disable_existing_loggers'</span>: <span class="keyword">False</span>,</span><br><span class="line">    <span class="string">'formatters'</span>: &#123;             <span class="comment"># 日志输出的格式</span></span><br><span class="line">        <span class="string">'verbose'</span>: &#123;</span><br><span class="line">            <span class="string">'format'</span>: <span class="string">'%(levelname)s %(asctime)s %(module)s %(process)d %(thread)d %(message)s'</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">'simple'</span>: &#123;</span><br><span class="line">            <span class="string">'format'</span>: <span class="string">'%(levelname)s %(message)s'</span></span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'handlers'</span>: &#123;               <span class="comment"># 处理日志的函数</span></span><br><span class="line">        <span class="string">'file'</span>: &#123;</span><br><span class="line">            <span class="string">'level'</span>: <span class="string">'DEBUG'</span>,</span><br><span class="line">            <span class="string">'class'</span>: <span class="string">'logging.FileHandler'</span>,</span><br><span class="line">            <span class="string">'filename'</span>: BASE_DIR + <span class="string">'/log/debug.log'</span>,</span><br><span class="line">            <span class="string">'formatter'</span>: <span class="string">'simple'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'loggers'</span>: &#123;</span><br><span class="line">        <span class="string">'django'</span>: &#123;</span><br><span class="line">            <span class="string">'handlers'</span>: [<span class="string">'file'</span>],</span><br><span class="line">            <span class="string">'propagate'</span>: <span class="keyword">True</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">'django.request'</span>: &#123;     <span class="comment"># 日志的命名空间</span></span><br><span class="line">            <span class="string">'handlers'</span>: [<span class="string">'file'</span>],</span><br><span class="line">            <span class="string">'level'</span>: <span class="string">'DEBUG'</span>,</span><br><span class="line">            <span class="string">'propagate'</span>: <span class="keyword">True</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在根目录新建文件夹<code>log</code>。<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> <span class="built_in">log</span></span><br></pre></td></tr></table></figure></p>
<p>然后在代码中添加日志相关的代码。例如，在<code>books/views.py</code>中，添加以下代码：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">logger = logging.getLogger(<span class="string">'django.request'</span>)</span><br></pre></td></tr></table></figure>
<p>在<code>books/views.py</code>中的<code>index</code>函数中添加一行：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logger.info(request.body)</span><br></pre></td></tr></table></figure></p>
<p>就会发现当我们访问首页的时候，在<code>log/debug.log</code>中有日志信息。</p>
<h1 id="17，中间件的编写"><a href="#17，中间件的编写" class="headerlink" title="17，中间件的编写"></a><a id="17">17，中间件的编写</a></h1><p>在<code>utils</code>文件夹中新建<code>middleware.py</code>文件。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> http</span><br><span class="line"><span class="comment"># 中间件示例，打印中间件执行语句</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookMiddleware</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_request</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        print(<span class="string">"Middleware executed"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分别处理收到的请求和发出去的相应，要理解中间件的原理。</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnotherMiddleware</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_request</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        print(<span class="string">"Another middleware executed"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_response</span><span class="params">(self, request, response)</span>:</span></span><br><span class="line">        print(<span class="string">"AnotherMiddleware process_response executed"</span>)</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"><span class="comment"># 记录用户访问的url地址</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UrlPathRecordMiddleware</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">'''记录用户访问的url地址'''</span></span><br><span class="line">    EXCLUDE_URLS = [<span class="string">'/user/login/'</span>, <span class="string">'/user/logout/'</span>, <span class="string">'/user/register/'</span>]</span><br><span class="line">    <span class="comment"># 1./user/ 记录 url_path = /user/</span></span><br><span class="line">    <span class="comment"># 2./user/login/ url_path = /user/</span></span><br><span class="line">    <span class="comment"># 3./user/login_check/  url_path = /user/</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_view</span><span class="params">(self, request, view_func, *view_args, **view_kwargs)</span>:</span></span><br><span class="line">        <span class="comment"># 当用户请求的地址不在排除的列表中，同时不是ajax的get请求</span></span><br><span class="line">        <span class="keyword">if</span> request.path <span class="keyword">not</span> <span class="keyword">in</span> UrlPathRecordMiddleware.EXCLUDE_URLS <span class="keyword">and</span> <span class="keyword">not</span> request.is_ajax() <span class="keyword">and</span> request.method == <span class="string">'GET'</span>:</span><br><span class="line">            request.session[<span class="string">'url_path'</span>] = request.path</span><br><span class="line"></span><br><span class="line">BLOCKED_IPS = []</span><br><span class="line"><span class="comment"># 拦截在BLOCKED_IPS中的IP</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BlockedIpMiddleware</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_request</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> request.META[<span class="string">'REMOTE_ADDR'</span>] <span class="keyword">in</span> BLOCKED_IPS:</span><br><span class="line">            <span class="keyword">return</span> http.HttpResponseForbidden(<span class="string">'&lt;h1&gt;Forbidden&lt;/h1&gt;'</span>)</span><br></pre></td></tr></table></figure>
<p>然后在配置文件<code>settings.py</code>中，写入中间件类的名字。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">MIDDLEWARE_CLASSES = (</span><br><span class="line">    ...</span><br><span class="line">    <span class="string">'utils.middleware.BookMiddleware'</span>,</span><br><span class="line">    <span class="string">'utils.middleware.AnotherMiddleware'</span>,</span><br><span class="line">    <span class="string">'utils.middleware.UrlPathRecordMiddleware'</span>,</span><br><span class="line">    <span class="string">'utils.middleware.BlockedIpMiddleware'</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>这样就可以使用中间件了。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/python/" rel="tag"># python</a>
          
            <a href="/tags/django项目/" rel="tag"># django项目</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/10/18/Python沙箱逃逸（CTF）/" rel="next" title="Python沙箱逃逸（CTF）">
                <i class="fa fa-chevron-left"></i> Python沙箱逃逸（CTF）
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
         <div id="uyan_frame"></div>

    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/lalala"
                alt="lalala" />
            
              <p class="site-author-name" itemprop="name">lalala</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">34</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">32</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/zhangdebiao" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:843345000@qq.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#目录"><span class="nav-number">1.</span> <span class="nav-text">目录</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#1，新建项目"><span class="nav-number">2.</span> <span class="nav-text">1，新建项目</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1，新建项目-1"><span class="nav-number">2.1.</span> <span class="nav-text">1，新建项目</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2，将需要用的包添加进来"><span class="nav-number">2.2.</span> <span class="nav-text">2，将需要用的包添加进来</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3，修改项目配置文件，将默认sqlite改为mysql"><span class="nav-number">2.3.</span> <span class="nav-text">3，修改项目配置文件，将默认sqlite改为mysql</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2，用户系统开发"><span class="nav-number">3.</span> <span class="nav-text">2，用户系统开发</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1，用户系统的开发"><span class="nav-number">3.1.</span> <span class="nav-text">1，用户系统的开发</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2，用户系统前端模板编写"><span class="nav-number">3.2.</span> <span class="nav-text">2，用户系统前端模板编写</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3，注册页面表单提交功能"><span class="nav-number">3.3.</span> <span class="nav-text">3，注册页面表单提交功能</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3，书籍商品模块"><span class="nav-number">4.</span> <span class="nav-text">3，书籍商品模块</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1，渲染首页功能（书籍表结构设计）"><span class="nav-number">4.1.</span> <span class="nav-text">1，渲染首页功能（书籍表结构设计）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#富文本编辑器应用到项目中"><span class="nav-number">4.1.1.</span> <span class="nav-text">富文本编辑器应用到项目中</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2，编写书籍表视图函数。"><span class="nav-number">4.2.</span> <span class="nav-text">2，编写书籍表视图函数。</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3，将Books注册到后台管理系统admin"><span class="nav-number">4.3.</span> <span class="nav-text">3，将Books注册到后台管理系统admin</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4，从注册页跳转到首页"><span class="nav-number">4.4.</span> <span class="nav-text">4，从注册页跳转到首页</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5，登陆功能的实现。"><span class="nav-number">4.5.</span> <span class="nav-text">5，登陆功能的实现。</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6，首页上的登陆和注册按钮redirect到相关页面。"><span class="nav-number">4.6.</span> <span class="nav-text">6，首页上的登陆和注册按钮redirect到相关页面。</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7，实现商品详情页的功能"><span class="nav-number">4.7.</span> <span class="nav-text">7，实现商品详情页的功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8，抽象出一个通用的模板，供别的模板继承。"><span class="nav-number">4.8.</span> <span class="nav-text">8，抽象出一个通用的模板，供别的模板继承。</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9，列表页的开发"><span class="nav-number">4.9.</span> <span class="nav-text">9，列表页的开发</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4，用户中心的实现"><span class="nav-number">5.</span> <span class="nav-text">4，用户中心的实现</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5，购物车功能"><span class="nav-number">6.</span> <span class="nav-text">5，购物车功能</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1，创建models"><span class="nav-number">6.1.</span> <span class="nav-text">1，创建models</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2，渲染购物车页面"><span class="nav-number">6.2.</span> <span class="nav-text">2，渲染购物车页面</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3，购物车页面的开发"><span class="nav-number">6.3.</span> <span class="nav-text">3，购物车页面的开发</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4，购物车中删除商品的功能"><span class="nav-number">6.4.</span> <span class="nav-text">4，购物车中删除商品的功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5，实现购物车页面编辑商品数量的功能。"><span class="nav-number">6.5.</span> <span class="nav-text">5，实现购物车页面编辑商品数量的功能。</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#6，订单页面的开发"><span class="nav-number">7.</span> <span class="nav-text">6，订单页面的开发</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1，创建models-1"><span class="nav-number">7.1.</span> <span class="nav-text">1，创建models</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2，开发有关订单的接口。"><span class="nav-number">7.2.</span> <span class="nav-text">2，开发有关订单的接口。</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3，订单提交功能"><span class="nav-number">7.3.</span> <span class="nav-text">3，订单提交功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4，接下来我们回过头去把购物车中的提交功能给做了，然后就能做支付功能了。"><span class="nav-number">7.4.</span> <span class="nav-text">4，接下来我们回过头去把购物车中的提交功能给做了，然后就能做支付功能了。</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5，接下来我们将提交订单页面完善一下，完成去支付功能。将支付方式绑定value值，供提交。"><span class="nav-number">7.5.</span> <span class="nav-text">5，接下来我们将提交订单页面完善一下，完成去支付功能。将支付方式绑定value值，供提交。</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6，完善用户中心"><span class="nav-number">7.6.</span> <span class="nav-text">6，完善用户中心</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7，“去付款”功能的实现"><span class="nav-number">7.7.</span> <span class="nav-text">7，“去付款”功能的实现</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#7，使用缓存"><span class="nav-number">8.</span> <span class="nav-text">7，使用缓存</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#8，评论功能的实现"><span class="nav-number">9.</span> <span class="nav-text">8，评论功能的实现</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#9，发送邮件功能实现。"><span class="nav-number">10.</span> <span class="nav-text">9，发送邮件功能实现。</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1，同步发送邮件"><span class="nav-number">10.1.</span> <span class="nav-text">1，同步发送邮件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2，使用消息队列celery来异步发送邮件。"><span class="nav-number">10.2.</span> <span class="nav-text">2，使用消息队列celery来异步发送邮件。</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#10，登陆验证码功能实现"><span class="nav-number">11.</span> <span class="nav-text">10，登陆验证码功能实现</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#11，全文检索的实现"><span class="nav-number">12.</span> <span class="nav-text">11，全文检索的实现</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#12，用户激活功能的实现"><span class="nav-number">13.</span> <span class="nav-text">12，用户激活功能的实现</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#13，用户中心最近浏览功能的实现"><span class="nav-number">14.</span> <span class="nav-text">13，用户中心最近浏览功能的实现</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#14，前端过滤器实现"><span class="nav-number">15.</span> <span class="nav-text">14，前端过滤器实现</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#15，使用gunicorn-nginx-django进行部署"><span class="nav-number">16.</span> <span class="nav-text">15，使用gunicorn+nginx+django进行部署</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#16，django日志模块的使用"><span class="nav-number">17.</span> <span class="nav-text">16，django日志模块的使用</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#17，中间件的编写"><span class="nav-number">18.</span> <span class="nav-text">17，中间件的编写</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">lalala</span>

  
</div>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="powered-by">
	<i class="fa fa-user-md"></i>
	<span id="busuanzi_container_site_pv">
		本站总访问量<span id="busuanzi_value_site_pv"></span>次
	</span>
</div>
|
<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共58.8k字</span>
</div>

<br>
	

  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  
    

    
      <!-- UY BEGIN -->
	<div id="uyan_frame"></div>
	<script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=2160339"></script>
	<!-- UY END -->
    
  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
